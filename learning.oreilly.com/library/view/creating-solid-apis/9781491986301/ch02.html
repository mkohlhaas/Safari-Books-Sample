<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/creating-solid-apis/9781491986301/ch02.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9781491986301"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch02.html"
  data-epub-title="Creating Solid APIs with Lua" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/creating-solid-apis/9781491986301/ch02.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9781491986301"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch02.html"
  data-epub-title="Creating Solid APIs with Lua" data-debug=0 data-testing=0><!--<![endif]--><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="author" content="O'Reilly Media" /><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781491986301"/><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico" /><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"/><meta property="twitter:account_id" content="4503599627559754" /><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic' rel='stylesheet' type='text/css'><title>2. Calling C from Lua - Creating Solid APIs with Lua</title><link rel="stylesheet" href="https://learning.oreilly.com/static/CACHE/css/output.5bdb4fcb2aad.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td,#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content canvas,#sbo-rt-content details,#sbo-rt-content embed,#sbo-rt-content figure,#sbo-rt-content figcaption,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content output,#sbo-rt-content ruby,#sbo-rt-content section,#sbo-rt-content summary,#sbo-rt-content time,#sbo-rt-content mark,#sbo-rt-content audio,#sbo-rt-content video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content details,#sbo-rt-content figcaption,#sbo-rt-content figure,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content section{display:block}#sbo-rt-content div{line-height:1}#sbo-rt-content ol,#sbo-rt-content ul{list-style:none}#sbo-rt-content blockquote,#sbo-rt-content q{quotes:none}#sbo-rt-content blockquote:before,#sbo-rt-content blockquote:after,#sbo-rt-content q:before,#sbo-rt-content q:after{content:none}#sbo-rt-content table{border-collapse:collapse;border-spacing:0}@page{margin:5px !important}#sbo-rt-content p{margin:10px 0 0;line-height:125%;text-align:left}#sbo-rt-content p.byline{text-align:left;margin:-33px auto 35px;font-style:italic;font-weight:bold}#sbo-rt-content div.preface p+p.byline{margin:1em 0 0}#sbo-rt-content div.preface p.byline+p.byline{margin:0}#sbo-rt-content div.sect1>p.byline{margin:-.25em 0 1em}#sbo-rt-content div.sect1>p.byline+p.byline{margin-top:-1em}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link,#sbo-rt-content a{text-decoration:none;color:#8e0012}#sbo-rt-content span.lineannotation{font-style:italic;color:#a62a2a;font-family:serif}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#fff}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important;margin-bottom:30px !important}#sbo-rt-content section[data-type="sect1"] h1{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content section[data-type="sect2"] h2{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content section[data-type="sect3"] h3{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content section[data-type="sect4"] h4{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section[data-type="chapter"]>div>h1,#sbo-rt-content section[data-type="preface"]>div>h1,#sbo-rt-content section[data-type="appendix"]>div>h1,#sbo-rt-content section[data-type="glossary"]>div>h1,#sbo-rt-content section[data-type="bibliography"]>div>h1,#sbo-rt-content section[data-type="index"]>div>h1{font-size:2em;line-height:1;margin-bottom:50px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content span.label,#sbo-rt-content span.keep-together{font-size:inherit;font-weight:inherit}#sbo-rt-content div[data-type="part"] h1{font-size:2em;text-align:center;margin-top:0 !important;margin-bottom:50px;padding:50px 0 10px 0;border-bottom:1px solid #000}#sbo-rt-content img.width-ninety{width:90%}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center !important;margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content figure{margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content div.figure h6{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif !important;color:#000;padding-top:10px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center !important;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:15px 0 10px 0 !important;border:1px solid #DCDCDC;background-color:#F7F7F7;padding:15px !important;page-break-inside:avoid}#sbo-rt-content aside[data-type="sidebar"]{margin:15px 0 10px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title,#sbo-rt-content aside[data-type="sidebar"] h5{font-weight:bold;font-size:1em;font-family:sans-serif;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar ol,#sbo-rt-content div.sidebar ul,#sbo-rt-content aside[data-type="sidebar"] ol,#sbo-rt-content aside[data-type="sidebar"] ul{margin-left:1.25em !important}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content aside[data-type="sidebar"] figcaption,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif !important;color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div[data-type="tip"],#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div[data-type="note"],#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div[data-type="warning"],#sbo-rt-content div.sidebar div[data-type="caution"],#sbo-rt-content div.sidebar div[data-type="important"]{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content aside[data-type="sidebar"] p.byline{font-size:90%;font-weight:bold;font-style:italic;text-align:center;text-indent:0;margin:5px auto 6px;page-break-after:avoid}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div[data-type="example"]{margin:10px 0 15px 0 !important}#sbo-rt-content div[data-type="example"] h1,#sbo-rt-content div[data-type="example"] h2,#sbo-rt-content div[data-type="example"] h3,#sbo-rt-content div[data-type="example"] h4,#sbo-rt-content div[data-type="example"] h5,#sbo-rt-content div[data-type="example"] h6{font-style:italic;font-weight:normal;text-align:left !important;text-transform:none !important;font-family:serif !important;margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div[data-type="example"] pre[data-type="programlisting"],#sbo-rt-content div[data-type="example"] pre[data-type="screen"]{margin:0}#sbo-rt-content section[data-type="titlepage"]>div>h1{font-size:2em;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content section[data-type="titlepage"] h2,#sbo-rt-content section[data-type="titlepage"] p.subtitle,#sbo-rt-content section[data-type="titlepage"] p[data-type="subtitle"]{font-size:1.3em;font-weight:normal;text-align:center;margin-top:.5em;color:#555}#sbo-rt-content section[data-type="titlepage"]>div>h2[data-type="author"],#sbo-rt-content section[data-type="titlepage"] p.author{font-size:1.3em;font-family:serif !important;font-weight:bold;margin:50px 0 !important;text-align:center}#sbo-rt-content section[data-type="titlepage"] p.edition{text-align:center;text-transform:uppercase;margin-top:2em}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content ul.stafflist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.stafflist li{list-style-type:none;padding:5px 0}#sbo-rt-content ul.printings li{list-style-type:none}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif !important;font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif !important;margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10px}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif !important}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-style:italic;margin:.75em 0 0 !important}#sbo-rt-content blockquote div.attribution,#sbo-rt-content blockquote p[data-type="attribution"]{margin:5px 0 10px 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p,#sbo-rt-content blockquote p[data-type="attribution"]{font-style:normal;margin-top:5px}#sbo-rt-content blockquote div.attribution p:before,#sbo-rt-content blockquote p[data-type="attribution"]:before{font-style:normal;content:"—";-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div[data-type="footnotes"]{border-top:1px solid black;margin-top:1.5em}#sbo-rt-content sub,#sbo-rt-content sup{font-size:75%;line-height:0;position:relative}#sbo-rt-content sup{top:-.5em}#sbo-rt-content sub{bottom:-.25em}#sbo-rt-content div.refentry p.refname{font-size:1em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin-bottom:5px;overflow:auto;width:100%}#sbo-rt-content div.refentry{width:100%;display:block;margin-top:2em}#sbo-rt-content div.refsynopsisdiv{display:block;clear:both}#sbo-rt-content div.refentry header{page-break-inside:avoid !important;display:block;break-inside:avoid !important;padding-top:0;border-bottom:1px solid #000}#sbo-rt-content div.refsect1 h6{font-size:.9em;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content div.refsect1{margin-top:3em}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dd{margin-left:1.5em !important;margin-bottom:.25em}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ul{list-style-type:disc}#sbo-rt-content ul ul{list-style-type:square}#sbo-rt-content ul ul ul{list-style-type:circle}#sbo-rt-content ol{list-style-type:decimal}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ol ul{list-style-type:disc}#sbo-rt-content ol ul ol{list-style-type:decimal}#sbo-rt-content ul ol{list-style-type:decimal}#sbo-rt-content ul ol ul{list-style-type:disc}#sbo-rt-content ol,#sbo-rt-content ul{list-style-position:outside;margin:15px 0 15px 1.25em}#sbo-rt-content ol li,#sbo-rt-content ul li{margin:.5em 0 .65em;line-height:125%}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist,#sbo-rt-content ul.simplelist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.simplelist li{list-style-type:none;padding:5px 0}#sbo-rt-content table.simplelist td{border:none}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content dl.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content dl.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content dl.calloutlist img,#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"],#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{margin:30px !important;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip ol,#sbo-rt-content div.tip ul,#sbo-rt-content div[data-type="tip"] ol,#sbo-rt-content div[data-type="tip"] ul,#sbo-rt-content div.note ol,#sbo-rt-content div.note ul,#sbo-rt-content div[data-type="note"] ol,#sbo-rt-content div[data-type="note"] ul,#sbo-rt-content div.warning ol,#sbo-rt-content div.warning ul,#sbo-rt-content div[data-type="warning"] ol,#sbo-rt-content div[data-type="warning"] ul,#sbo-rt-content div[data-type="caution"] ol,#sbo-rt-content div[data-type="caution"] ul,#sbo-rt-content div[data-type="important"] ol,#sbo-rt-content div[data-type="important"] ul{margin-left:1.5em !important}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"]{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="note"] h1,#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1,#sbo-rt-content div[data-type="important"] h6{font-weight:bold;font-size:110%;font-family:sans-serif !important;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div[data-type="note"] h1{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="important"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note,#sbo-rt-content div.safarienabled{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3,#sbo-rt-content div.safarienabled h6{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px 0 30px 0 !important;max-width:95%;border:none !important;background:none;display:table !important}#sbo-rt-content div.table,#sbo-rt-content div.informaltable,#sbo-rt-content table{page-break-inside:avoid}#sbo-rt-content tr,#sbo-rt-content tr td{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td,#sbo-rt-content thead th{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif;font-weight:bold}#sbo-rt-content td,#sbo-rt-content th{display:table-cell;padding:.3em;text-align:left;vertical-align:middle;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title,#sbo-rt-content table caption{font-weight:normal;font-style:italic;font-family:serif;font-size:1em;margin:10px 0 10px 0 !important;padding:0;page-break-after:avoid;text-align:left !important}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation,#sbo-rt-content div[data-type="equation"]{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title,#sbo-rt-content div[data-type="equation"] h5{font-style:italic;font-weight:normal;font-family:serif !important;font-size:90%;margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{text-indent:0}#sbo-rt-content div.index li{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content div.index ul,#sbo-rt-content div[data-type="index"] ul{list-style-type:none;padding-left:0;margin-left:0}#sbo-rt-content div.index ul li{padding-left:0;margin-left:0}#sbo-rt-content div.index ul li ul li{margin-left:1em}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif;text-align:left}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content span.gray{color:#4C4C4C}
    </style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781491986301/chapter/ch02.html",
          "book_id": "9781491986301",
          "chapter_uri": "ch02.html",
          "position": 0,
          "user_uuid": "ce47de5b-ce80-49f0-b5cd-c60d3d33b198",
          "next_chapter_uri": "/library/view/creating-solid-apis/9781491986301/ch03.html"
        
      },
      title: "Creating Solid APIs with Lua",
      author_list: "Tyler Neylon",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="https://learning.oreilly.com/static/js/src/modernizr.8e35451ddb64.js"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
        }
      };
  </script><link rel="canonical" href="ch02.html"/><meta name="description" content=" Chapter 2. Calling C from Lua C is the lingua franca of programming languages. Anything your system can do—such as access the internet, play an audio file, or generate real-time ... "><meta property="og:title" content="2. Calling C from Lua" /><meta itemprop="isPartOf" content="/library/view/creating-solid-apis/9781491986301/" /><meta itemprop="name" content="2. Calling C from Lua" /><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/ch02.html" /><meta property="og:site_name" content="Safari" /><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9781491986301/" /><meta property="og:description" itemprop="description" content=" Chapter 2. Calling C from Lua C is the lingua franca of programming languages. Anything your system can do—such as access the internet, play an audio file, or generate real-time ... "><meta itemprop="inLanguage" content="en" /><meta itemprop="publisher" content="O&#39;Reilly Media, Inc." /><meta property="og:type" content="book" /><meta property="og:book:isbn" itemprop="isbn" content="9781491963760" /><meta property="og:book:author" itemprop="author" content="Tyler Neylon" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; URL=https://learning.oreilly.com/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198';
      dataLayer.push({userIdentifier: 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '29964b7b-68d8-4532-9a9b-32e089689c1f';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer src="https://learning.oreilly.com/static/js/build/vendor.0eac897f11ed.js"></script><script defer src="https://learning.oreilly.com/static/js/build/reader.c745ea9296ac.js"></script></head>


<body class="reading sidenav nav-collapsed  scalefonts">

    
  <noscript> 
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="ch02.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z" /></svg><span>Home</span></a></li><li class="search"><a href="ch02.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"/></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="ch02.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"/></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a
                href="ch02.html#"
                class="l1 nav-icn "
                
              ><?xml version="1.0" encoding="UTF-8"?><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O&#39;Reilly</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/profile/"
                    class="l2 nav-icn"
                    
                  ><span>Profile</span></a></li><li><a
                    href="https://learning.oreilly.com/history/"
                    class="l2 nav-icn"
                    
                  ><span>History</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/"
                    class="l2 nav-icn"
                    
                  ><span>Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/u/ce47de5b-ce80-49f0-b5cd-c60d3d33b198/"
                    class="l2 nav-icn"
                    
                  ><span>Highlights</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/answers/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"/></svg><span>Answers</span></a></li><li class="flyout-parent"><a
                href="ch02.html#"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"/></g></svg><span>Explore</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/topics/"
                    class="l2 nav-icn"
                    
                  ><span>All Topics</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert"
                    class="l2 nav-icn"
                    
                  ><span>Most Popular Titles</span></a></li><li><a
                    href="https://learning.oreilly.com/recommendations/"
                    class="l2 nav-icn"
                    
                  ><span>Recommended</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0"
                    class="l2 nav-icn"
                    
                  ><span>Early Releases</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/discover/"
                    class="l2 nav-icn"
                    
                  ><span>Shared Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/resource-centers/"
                    class="l2 nav-icn"
                    
                  ><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch02.html#"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z" /></svg><span>Live Events</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/attend/"
                    class="l2 nav-icn"
                    
                  ><span>All Events</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/architectural-katas/"
                    class="l2 nav-icn"
                    
                  ><span>Architectural Katas</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/ai/"
                    class="l2 nav-icn"
                    
                  ><span>AI &amp; ML</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/strata/"
                    class="l2 nav-icn"
                    
                  ><span>Data Sci &amp; Eng</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/oscon/"
                    class="l2 nav-icn"
                    
                  ><span>Programming</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/infrastructure-ops/"
                    class="l2 nav-icn"
                    
                  ><span>Infra &amp; Ops</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/software-architecture/"
                    class="l2 nav-icn"
                    
                  ><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch02.html#"
                class="l1 nav-icn "
                
              ><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interactive</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=content-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Scenarios</span></a></li><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Sandboxes</span></a></li><li><a
                    href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook"
                    class="l2 nav-icn"
                    
                  ><span>Jupyter Notebooks</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/certifications/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"/></svg><span>Certifications</span></a></li><li ><a
                href="https://learning.oreilly.com/preferences/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"/></g></svg><span>Settings</span></a></li><li ><a
                href="https://learning.oreilly.com/public/support/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z" /></svg><span>Support</span></a></li><li ><a
                href="https://get.oreilly.com/email-signup.html"
                class="l1 nav-icn "
                target=&quot;_blank&quot;
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z" /></svg><span>Newsletters</span></a></li><li ><a
                href="https://learning.oreilly.com/accounts/logout/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z" /></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="ch02.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Creating Solid APIs with Lua
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="ch02.html#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track('SearchBook_HeronBook')"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9781491986301/chapter/ch02.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track('AddPlaylist_HeronBook')"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="ch02.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track('ChangeFont_HeronBook')"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="ch02.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track('Share_HeronBook')"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a
        class="twitter share-button t-twitter"
        target="_blank"
        aria-label="Share this section on Twitter"
        title="Share this section on Twitter"
      
        href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/ch02.html&text=Creating%20Solid%20APIs%20with%20Lua&via=OReillyMedia"
      ><span>Twitter</span></a></li><li><a
        class="facebook share-button t-facebook"
        target="_blank"
        aria-label="Share this section on Facebook"
        title="Share this section on Facebook"
        href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/ch02.html"
      ><span>Facebook</span></a></li><li><a
        class="googleplus share-button t-googleplus"
        target="_blank"
        aria-label="Share this secton on Google Plus"
        title="Share this secton on Google Plus"
        href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/ch02.html"
      ><span>Google Plus</span></a></li><li><a
        class="email share-button t-email"
        aria-label="Share this section via email"
        title="Share this section via email"
      
        href="mailto:?subject=Safari: 2.%20Calling%20C%20from%20Lua&body=https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/ch02.html%0D%0Afrom Creating%20Solid%20APIs%20with%20Lua%0D%0A"
      ><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer src="https://learning.oreilly.com/static/js/build/djangoMessagesPage.bfaca9fd8619.js"></script>


        <script src="https://fast.appcues.com/48743.js"></script>
<script>
  var userId = "ce47de5b-ce80-49f0-b5cd-c60d3d33b198";

  var userObject = {
    firstName: "Michael",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2021-05-13",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Running a Lua Script from C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Using Lua Values in C</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. Calling C from Lua"><div class="chapter" id="calling_c_from_lua">
<h1><span class="label">Chapter 2. </span>Calling C from Lua</h1>

<p>C is the lingua franca of programming languages. Anything your system can do—such as access the internet, play an audio file, or generate real-time GPU-based 3D graphics—you can do via C code linked with the right libraries. Lua takes advantage of C’s universality by making it easy to share C functionality with Lua code. That’s what we’ll do in this chapter.</p>

<p>The example code in this chapter is split across two pairs of files. The first pair contains the files <em>eatyguy1.c</em> and <em>eatyguy1.lua</em>, whereas the second pair, in a rather predictable manner, contains the files <em>eatyguy2.c</em> and <em>eatyguy2.lua</em>. Thus continues the saga of the EatyGuy example code, which will grow iteratively throughout the remainder of this book, consistently with filenames that begin with <em>eatyguy&lt;num&gt;</em>. I hope this naming scheme makes it easier for you to see where each iteration fits into the big picture. It also reflects the typical iterative nature of software projects.</p>

<section data-type="sect1" data-pdf-bookmark="EatyGuy Version 1: A Lua-Callable C Function"><div class="sect1" id="eatyguy_version_1_a_lua-callable_c_funct">
<h1>EatyGuy Version 1: A Lua-Callable C Function</h1>

<p>Let’s begin by giving EatyGuy the ability to draw text characters with different background colors. We’ll write C code that creates the function listed in <a data-type="xref" href="ch02.html#description_of_the_setunderscorecolorlef">Table 2-1</a> in Lua.</p>

<table class="border" id="description_of_the_setunderscorecolorlef">
	<caption><span class="label">Table 2-1. </span>Description of the set_color() Lua function that we’ll implement in C</caption>
	<thead>
		<tr>
			<th colspan="2" style="vertical-align: top;"><strong>Lua function</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>set_color(</code><code><em>&lt;color_index&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Change the terminal’s current background color to <code><em>&lt;color_index&gt;</em></code>. Text printed out after this function is run will be printed with the given background color.</td>
		</tr>
	</tbody>
</table>

<section data-type="sect2" data-pdf-bookmark="The tput Shell Command"><div class="sect2" id="tput_shell_command">
<h2>The <em>tput</em> Shell Command</h2>

<p>Most terminals support at least eight colors, and some support an astonishing 256 colors. How many colors your terminal supports depends on which terminal application you use, and is codified in the value of your <code>$TERM</code> environment variable. This variable maps to a precise set of terminal capabilities via a database called <em>terminfo</em>; if you want to learn more about it, in your shell, type <a href="http://man7.org/linux/man-pages/man5/terminfo.5.html"><code><strong>man terminfo</strong></code></a>.</p>

<p>Luckily for us, there is an incredibly handy little shell command called <em>tput</em> that allows us to blithely forge ahead using terminal capabilities while knowing next to nothing about your <code>$TERM</code> value or the <em>terminfo</em> database. The only assumption I’m making is that your terminal supports at least eight colors, which you can check by running <code><strong>tput colors</strong></code> in your shell. The result should be a number greater than or equal to eight.</p>

<p>In general, <em>tput</em> works by accepting command-line parameters in the following form:</p>

<pre data-type="programlisting">
tput <em>&lt;command&gt;</em> [command args]</pre>

<p>Depending on the value of <code><em>&lt;command&gt;</em></code> and the optional arguments after it, <em>tput</em> will send a specific string to <code>stdout</code>. In many cases, you won’t see this string because it’s composed of a special sequence of bytes that the terminal application knows to ingest and interpret as a change in behavior, such as changing the color of all subsequently printed text to red (this particular change is realized with the command <code>tput setaf 1</code>). In theory, any program can print out those special byte sequences to achieve the same effects; the value of <em>tput</em> is that it knows how to speak the languages of many different types of terminals, much like a well-made protocol droid.</p>

<p><a data-type="xref" href="ch02.html#summary_of_the_tput_commands_that_weapos">Table 2-2</a> lists the <em>tput</em> commands that the code in this book uses.</p>

<table class="border" id="summary_of_the_tput_commands_that_weapos">
	<caption><span class="label">Table 2-2. </span>Summary of the <em>tput</em> commands that we’ll use in the example code</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong><em>tput</em> command</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><span class="keep-together"><code>tput setab</code> <code><em>&lt;color&gt;</em></code></span></td>
			<td style="vertical-align: top;">Set the terminal background color to <code><em>&lt;color&gt;</em></code>, which is expected to be an integer in the range [0, #colors – 1], where #colors is the number of colors supported by your terminal.</td>
		</tr>
		<tr>
			<td style="vertical-align: top;"><span class="keep-together"><code>tput setaf</code> <code><em>&lt;color&gt;</em></code></span></td>
			<td style="vertical-align: top;">Set the terminal foreground color to <code><em>&lt;color&gt;</em></code>, which is expected to be an integer in the range [0, #colors – 1].</td>
		</tr>
		<tr>
			<td style="vertical-align: top;"><span class="keep-together"><code>tput cup</code> <code><em>&lt;y&gt;</em></code> <code><em>&lt;x&gt;</em></code></span></td>
			<td style="vertical-align: top;">Move the terminal’s cursor to position (<code><em>&lt;x&gt;</em></code>, <code><em>&lt;y&gt;</em></code>). The upper-left corner of your terminal window is position (0, 0).</td>
		</tr>
		<tr>
			<td style="vertical-align: top;"><code>tput reset</code></td>
			<td style="vertical-align: top;">Reset terminal colors to their default values, clear the window, and return the cursor to the upper-left of the window. This is useful if you’ve gotten yourself into a weird state and can’t read what you’re typing or find the cursor.</td>
		</tr>
	</tbody>
</table>

<p><a data-type="xref" href="ch02.html#default_eight_colors_supported_by_tputdo">Figure 2-1</a> demonstrates the default eight colors as displayed on my terminal by the short bash function in the image.</p>

<figure><div id="default_eight_colors_supported_by_tputdo" class="figure"><img alt="The default eight colors supported by tput. Color 7 is white, so the text blends in with the background in the color bar" src="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/assets/csal_0201.png" width="975" height="625">
<h6><span class="label">Figure 2-1. </span>The default eight colors supported by <em>tput</em>; color 7 is white, so the text blends in with the background in the color bar</h6>
</div></figure>

<p>If you are wealthy enough to afford a top-end 256-color terminal, you might extend the preceding bash function to see a color table like the one shown in <a data-type="xref" href="ch02.html#default_color_palette_for_a_256-color_te">Figure 2-2</a>.</p>

<figure><div id="default_color_palette_for_a_256-color_te" class="figure"><img alt="The default color palette for a 256-color terminal." src="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/assets/csal_0202.png" width="975" height="421">
<h6><span class="label">Figure 2-2. </span>The default color palette for a 256-color terminal</h6>
</div></figure>

<p>However, this book is not written for the aristocracy, so the code herein will work with the traditional eight colors available to the masses.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="The Core Mechanics of Lua-Callable C Functions"><div class="sect2" id="core_mechanics_of_lua-callable_c_functio">
<h2>The Core Mechanics of Lua-Callable C Functions</h2>

<p>C’s <code>system()</code> function can call shell commands like <em>tput</em>. Here is the C code for the <code>set_color()</code> function:</p>

<pre data-type="programlisting">
// This function will be part of eatyguy1.c.
// It requires us to #include &lt;stdlib.h&gt;.

// The C version of Lua's set_color(&lt;color&gt;) function.
// Set the terminal background color to &lt;color&gt;.
int set_color(lua_State *L) {
  int color = lua_tonumber(L, 1);
  char cmd[1024];
  snprintf(cmd, 1024, "tput setab %d", color);
  system(cmd);
  return 0;  // 0 is the number of Lua-visible return values.
}</pre>

<p><a data-type="xref" href="ch02.html#new_c_api_functioncomma_luaunderscoreton">Table 2-3</a> descibes the new <code>lua_tonumber()</code> function.</p>

<table class="border" id="new_c_api_functioncomma_luaunderscoreton">
	<caption><span class="label">Table 2-3. </span>The new C API function, <code>lua_tonumber()</code>, used to implement <code>set_color()</code></caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code><span class="keep-together">lua_tonumber</span>(L,</code> <code><em>&lt;index&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Convert the Lua stack value at <code><em>&lt;index&gt;</em></code> into the C type <code>lua_Number</code> and return that value. Numbers and appropriately formatted strings can be converted, but other values or empty stack slots can’t, in which case 0 is returned.</td>
			<td style="vertical-align: top;">[–0, +0]</td>
		</tr>
	</tbody>
</table>

<p>This function provides visibility into a value on the Lua stack. The <code>lua_Number</code> type is typically the same as C’s <code>double</code> type, although in some cases it can be a <code>float</code> or another type. The exact mapping is defined in the file <em>luaconf.h</em>, which is meant to be somewhat user-editable so that you can customize Lua to work well on various platforms. For learning purposes, you can safely treat the <code>lua_Number</code> type as if it were <code>double</code>.</p>

<p>Notice that the <code>set_color()</code> function accepts a single <code>lua_State</code> pointer as input and returns an <code>int</code>. <em>Every</em> Lua-callable function written in C has exactly this input type and output type. The list of input and output types of a function are called the <em>signature</em> of that function. Armed with this terminology, we can succinctly state that every Lua-callable C function must have the same signature.</p>

<p>The <code>lua_State</code> provides all of <code>set_color()</code>’s Lua inputs by placing them in order on the stack. Nothing else will be on the stack when Lua makes the call into your function—only the Lua arguments given by the caller when calling your function. Passing in arguments on the stack allows C functions to accept an arbitrary number of input values, as is standard in Lua but not C. The output value of <code>set_color()</code>—the <code>int</code>—indicates how many return values you want to send back to Lua. Normally, C functions can have zero or one return values, whereas Lua functions can have arbitrarily many. If your C function returns the integer <em>n</em>, the top <em>n</em> values on the Lua stack when the function ends are the return values visible from Lua. If the stack has too many values, the bottom-most values are ignored; if the stack has too few values, nil values are returned in place of the missing values.</p>

<p>Let’s see how these mechanisms work for the <code>set_color()</code> function. The function begins by examining the value in stack location 1, which represents the first argument passed in. If that value were 5, it would make the system call <code>tput setab 5</code>, setting the background color to 5. The C function ends by returning 0, meaning that there are no return values visible in Lua.</p>

<p>We’ll see more interesting examples of Lua-callable C functions later on in this chapter. Before that, there’s one more critical step required to make a C function visible to Lua. Specifically, Lua needs to have a name for the function that it can call. Here is the file <em>eatyguy1.c</em>, which you can see in <a data-type="xref" href="ch01.html#running_a_lua_script_from_c">Chapter 1</a> as <em>runmodule.c</em>, modified to include the new <code>set_color()</code> function; note the three new lines in bold:</p>

<pre data-type="programlisting">
// eatyguy1.c
//
// Loads eatyguy1.lua and runs eatyguy.init().
//

#include &lt;stdlib.h&gt;

#include "lauxlib.h"
#include "lua.h"
#include "lualib.h"


// Lua-visible functions.

int set_color(lua_State *L) {
  int color = lua_tonumber(L, 1);
  char cmd[1024];
  snprintf(cmd, 1024, "tput setab %d", color);
  system(cmd);
  return 0;
}


// Main.

int main() {

  // Create a Lua state and load the module.
  lua_State *L = luaL_newstate();
  luaL_openlibs(L);
  luaL_dofile(L, "<strong>eatyguy1.lua</strong>");
  lua_setglobal(L, "eatyguy");
  lua_settop(L, 0);

  <strong>// Make the set_color function visible to Lua.</strong>
  <strong>lua_pushcfunction(L, set_color);</strong>
  <strong>lua_setglobal(L, "set_color");</strong>

  // Run the init() function.
  lua_getglobal(L, "eatyguy");
  lua_getfield(L, -1, "init");  // -1 means stack top.
  lua_call(L, 0, 0);            // 0, 0 = #args, #retvals

  return 0;
}</pre>

<p>The filename passed to <code>luaL_dofile()</code>, which was previously <em>eatyguy0.lua</em>, is now <em>eatyguy1.lua</em>. In general, every version of <em>eatyguy&lt;</em><code><em>n</em></code><em>&gt;.c</em> will contain a call to <code>luaL_dofile()</code> that loads the corresponding <em>eatyguy&lt;</em><code><em>n</em></code><em>&gt;.lua</em> file (e.g., <em>eatyguy3.c</em> will load <em>eatyguy3.lua</em> and not <em>eatyguy2.lua</em>).</p>

<p>The <code>lua_setglobal()</code> function is covered in <a data-type="xref" href="ch01.html#running_a_lua_script_from_c">Chapter 1</a>, but <code>lua_pushcfunction()</code> (<a data-type="xref" href="ch02.html#new_c_api_functioncomma_luaunderscorepus">Table 2-4</a>) is new.</p>

<table class="border" id="new_c_api_functioncomma_luaunderscorepus">
	<caption><span class="label">Table 2-4. </span>The new C API function, <code>lua_pushcfunction()</code>, used in <em>eatyguy1.c</em></caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>lua_pushcfunction(L, &lt;fn&gt;)</code></td>
			<td style="vertical-align: top;">Push the function <code>&lt;fn&gt;</code> onto the top of the stack.</td>
			<td style="vertical-align: top;">[–0, +1]</td>
		</tr>
	</tbody>
</table>

<p>The combo of <code>lua_pushcfunction()</code> followed by <code>lua_setglobal()</code> works like this pseudocode:</p>

<pre data-type="programlisting">
&lt;the lua global "set_color"&gt; = &lt;the C function "set_color"&gt;</pre>

<p>When that’s done, the C code can safely call a Lua function that itself calls <code>set_color()</code>. In fact, now is the perfect time to write <em>eatyguy1.lua</em>, a file that builds on <em>eatyguy0.lua</em>, to take advantage of our fun new function.</p>

<p>In <a data-type="xref" href="ch01.html#running_a_lua_script_from_c">Chapter 1</a>, the walls of a maze were drawn as <code>#</code> characters, and the open spaces were drawn as space characters. This time around, walls will be blue space characters and open spaces will be black space characters. <a data-type="xref" href="ch02.html#example_output_from_eatyguy1">Figure 2-3</a> shows the result.</p>

<figure><div id="example_output_from_eatyguy1" class="figure"><img alt="An example output from eatyguy1." src="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/assets/csal_0203.png" width="975" height="630">
<h6><span class="label">Figure 2-3. </span>An example output from <em>eatyguy1</em></h6>
</div></figure>

<p>The only part of <em>eatyguy1.lua</em> that needs to differ from <em>eatyguy0.lua</em> is the maze-drawing code. Here’s the updated portion, with the key lines in bold:</p>

<pre data-type="programlisting">
  -- Part of eatyguy1.lua

  -- Draw the maze.
  for y = 0, grid_h + 1 do
    for x = 0, grid_w + 1 do
      <strong>if grid[x] and grid[x][y] then</strong>
        <strong>set_color(0)                 -- Black; open space color.</strong>
      <strong>else</strong>
        <strong>set_color(4)                 -- Blue; wall color.</strong>
      <strong>end</strong>
      <strong>io.write('  ')</strong>
      <strong>io.flush()                     -- Needed for color output.</strong>
    <strong>end</strong>
    <strong>set_color(0)                     -- End the lines in black.</strong>
    <strong>io.write(' \r\n')                -- Move cursor to next row.</strong>
  end
end</pre>

<p>I found out through bitter, bitter experience that the call to <code>io.flush()</code> was necessary on my terminal in order to correctly draw the maze. Without flushing the output of the <code>io.write()</code> calls, the terminal might not see the space characters until an output buffer is triggered to send the characters to the terminal, but the <em>tput</em> commands are always immediately sent. In other words, the terminal would receive the color-changing signals from the <em>tput</em> calls, but they would not be correctly interwoven with the space characters, so that the color changes might not be correctly synchronized with the corresponding spaces. Calling <code>io.flush()</code> effectively turns off output buffering and fixes this issue.</p>

<p>Your terminal colors might end up in a funky state after you run <em>eatyguy1</em>. To recover from this, simply run the <em>reset</em> command. (This will work even if you find yourself typing black characters on a black background!) The <code>reset</code> command clears your terminal screen and restores what it considers to be your terminal’s default colors. Future versions of EatyGuy avoid this issue by cleaning up after <span class="keep-together">themselves—much</span> more polite!</p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="EatyGuy Version 2: Adding an Animated Player"><div class="sect1" id="eatyguy_version_2_adding_an_animated_pla">
<h1>EatyGuy Version 2: Adding an Animated Player</h1>

<p>Next, we’ll build the following three C-based, Lua-callable functions with which we can draw an animated player that moves around the maze. The new version of <code>set_color()</code> shown in <a data-type="xref" href="ch02.html#new_set_of_lua_functions_that_weapostrop">Table 2-5</a> is different in that it can set either a background or foreground color, whereas the old version could only set a background color.</p>

<table class="border" id="new_set_of_lua_functions_that_weapostrop">
	<caption><span class="label">Table 2-5. </span>A new set of Lua functions that we’ll implement in C</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>Lua function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>set_color(’b’ or ’f’,</code> <code><em>&lt;color&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">If the first parameter is <code>’b’</code>, set the background color to <code><em>&lt;color&gt;</em></code>. If the first parameter is <code>’f’</code>, set the foreground color, instead.</td>
		</tr>
		<tr>
			<td style="vertical-align: top;"><code>set_pos(</code><code><em>&lt;x&gt;</em></code><code>,</code> <code><em>&lt;y&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Move the cursor to position (<code><em>&lt;x&gt;</em></code>, <code><em>&lt;y&gt;</em></code>). The upper-left corner of the window is considered position (0, 0).</td>
		</tr>
		<tr>
			<td style="vertical-align: top;"><code>timestamp()</code></td>
			<td style="vertical-align: top;">Return a high-resolution timestamp in seconds.</td>
		</tr>
	</tbody>
</table>

<p>These functions demonstrate how C code can work with strings on the Lua stack as well as how to return values from a C function back to Lua.</p>

<section data-type="sect2" data-pdf-bookmark="Strings and Multiple Arguments with set_color() and set_pos()"><div class="sect2" id="strings_and_multiple_arguments_with_setu">
<h2>Strings and Multiple Arguments with set_color() and set_pos()</h2>

<p>The new and improved <code>set_color()</code> function now accepts a first argument to determine whether to change the foreground or background color:</p>

<pre data-type="programlisting">
// Part of eatyguy2.c.

// Lua: set_color('b' or 'f', &lt;color&gt;)
int set_color(lua_State *L) {
  const char *b_or_f = lua_tostring(L, 1);
  int color = lua_tonumber(L, 2);
  char cmd[1024];
  snprintf(cmd, 1024, "tput seta%s %d", b_or_f, color);
  system(cmd);
  return 0;
}</pre>

<p>The first two lines extract a string and a number from the Lua stack, which are the first two arguments provided to the Lua function call. Note that these two function calls refer to indexes 1 and 2, respectively, in order to extract values from the first two parameters given on the Lua stack.</p>

<p><a data-type="xref" href="ch02.html#c_api_function_luaunderscoretostringleft">Table 2-6</a> presents the new <code>lua_tostring()</code> function.</p>

<table class="border" id="c_api_function_luaunderscoretostringleft">
	<caption><span class="label">Table 2-6. </span>The C API function <code>lua_tostring()</code> used to implement the updated <code>set_color()</code> function</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>lua_tostring(L,</code> <code><em>&lt;index&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Convert the stack value at <code><em>&lt;index&gt;</em></code> into a string and return a null-terminated C string with the same data. Note that this alters stack values that are not already strings, so it is not strictly a read-only function. The returned string is owned by Lua and is guaranteed to exist only as long as the corresponding stack value remains on the stack.</td>
			<td style="vertical-align: top;"><span class="keep-together">[–0, +0]</span></td>
		</tr>
	</tbody>
</table>

<p>It’s useful to understand how Lua treats its memory with respect to the C API. For the most part, Lua controls its memory allocation by not letting you touch its stuff. If you had a direct pointer to a Lua table, for example, the Lua garbage collector would have a difficult time determining when you were done with that pointer. Instead, Lua holds all complex values exclusively on its stack, and provides access to this data in terms of API calls that read and write primitive values to the stack.</p>

<p>The <code>lua_tostring()</code> function is a rare exception to this rule because you <em>do</em> get a pointer into Lua-owned memory. Lua’s memory management still works because such a string comes with clear rules: don’t edit the string, and don’t rely on the string existing after its originating stack value is off the stack. If you break these rules, everything can explode and Lua can legitimately say, “I told you so!” It’s also worth noting that Lua internally treats strings as [pointer, length] pairs so that a Lua string can contain arbitrarily many null bytes (the byte with all bits set to zero), whereas many C functions assume a C string contains no null bytes except for the last character, which <em>must</em> be a null byte. If you want your C code to receive binary data from Lua that might contain null bytes, you can use <code>lua_tolstring()</code> instead of <code>lua_tostring()</code>.</p>

<p>Now that we’re basically experts at retrieving numbers from the Lua stack, the <code>set_pos()</code> function is straightforward:</p>

<pre class="pagebreak-before" data-type="programlisting">
// Part of eatyguy2.c.

// Lua: set_pos(x, y)
int set_pos(lua_State *L) {
  int x = lua_tonumber(L, 1);
  int y = lua_tonumber(L, 2);
  char cmd[1024];
  // The 'tput cup' command accepts y before x; not a typo.
  snprintf(cmd, 1024, "tput cup %d %d", y, x);
  system(cmd);
  return 0;
}</pre>

<p>All of our Lua-callable functions so far have ended with <code>return 0;</code>. Let’s change that.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Sending a Return Value from C to Lua by Using timestamp()"><div class="sect2" id="sending_a_return_value_from_c_to_lua_by">
<h2>Sending a Return Value from C to Lua by Using timestamp()</h2>

<p>Lua has a function called <code>os.time()</code>, which returns the time in seconds. But this isn’t good enough for a game because <code>os.time()</code> provides an integer, meaning that we can tell when time marches forward only in full second intervals. Call me persnickety, but I’ve noticed that good games tend to draw more than one frame per second, so it would be nice to have a similar function that returns the time in seconds, but with at least millisecond resolution. We can use the <code>gettimeofday()</code> function to achieve that:</p>

<pre data-type="programlisting">
// Part of eatyguy2.c

// This requires us to #include &lt;sys/time.h&gt;.

double gettime() {
  struct timeval tv;
  gettimeofday(&amp;tv, NULL);
  return tv.tv_sec + 1e-6 * tv.tv_usec;
}

// Lua: timestamp()
// Return a high-resolution timestamp in seconds.
int timestamp(lua_State *L) {
  lua_pushnumber(L, gettime());
  return 1;
}</pre>

<p>Did you see that? We have a Lua-callable function that returns 1 instead of 0! Things are getting crazy.</p>

<p>This function works by pushing the current time, theoretically with microsecond resolution, onto the Lua stack, and then returning 1 in C, which indicates that the top 1 value(s) on the stack are to be handed back to the calling Lua function as return value(s).</p>

<p><a data-type="xref" href="ch02.html#c_api_function_luaunderscorepushnumberle">Table 2-7</a> introduces a new function, <code>lua_pushnumber()</code>, that handles this.</p>

<table class="border" id="c_api_function_luaunderscorepushnumberle">
	<caption><span class="label">Table 2-7. </span>The C API function lua_pushnumber() used by timestamp()</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>lua_pushnumber(L,</code> <code><em>&lt;num&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Push <code><em>&lt;num&gt;</em></code> onto the top of the stack.</td>
			<td style="vertical-align: top;">[–0, +1]</td>
		</tr>
	</tbody>
</table>

<p>This function is similar to <code>lua_pushcfunction()</code> in that it takes a C value and pushes the Lua version of it onto the top of the stack. There are multiple variations on this theme; they’re all functions named <code>lua_pushX()</code>, where <code>X</code> can be nil, string, Boolean, or other values.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Fancier Maze Drawing"><div class="sect2" id="fancier_maze_drawing">
<h2>Fancier Maze Drawing</h2>

<p>Now that we’ve updated the functions that Lua can call, including <code>set_color()</code>, we need to upgrade the maze-drawing code that was used in <em>eatyguy1.lua</em> to something a little more sophisticated in <em>eatyguy2.lua</em>. This upgrade reflects the fact that <code>set_color()</code> now accepts two parameters, and that the values in <code>grid</code> will become two-character sequences chosen to graphically represent either a dot that can be eaten or open space (in a moment, we’ll examine other code changes related to the values in <code>grid</code>). Here’s the updated maze-drawing code, which resides inside the <code>eatyguy.init()</code> method, with changes in bold:</p>

<pre data-type="programlisting">
  -- Draw the maze.
  <strong>set_color('f', 7)                  -- White foreground.</strong>
  for y = 0, grid_h + 1 do
    for x = 0, grid_w + 1 do
      if grid[x] and grid[x][y] then
        set_color(<strong>'b'</strong>, 0)            -- Black; open space color.
        <strong>io.write(grid[x][y])</strong>
      else
        set_color(<strong>'b'</strong>, 4)            -- Blue; wall color.
        <strong>io.write('  ')</strong>
      end
      io.flush()                     -- Needed for color output.
    end
    set_color(<strong>'b'</strong>, 0)                -- End the lines in black.
    io.write(' \r\n')                -- Move cursor to next row.
  end</pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Starting, Stopping, and Sharing Functions with Lua"><div class="sect2" id="startingcomma_stoppingcomma_and_sharing">
<h2>Starting, Stopping, and Sharing Functions with Lua</h2>

<p>The demo we’re building works by means of a run loop, meaning that it will execute until we break out of it. Because the code calls <code>system()</code> often and will run in a potentially infinite loop, it’s only polite to make it easier for the user to cleanly exit. Along those lines, we’ll put together C functions called <code>start()</code> and <code>done()</code>, and provide a new <code>main()</code> function that uses them. The code also includes a new <code>getkey()</code> function that can check for keypresses from the user without waiting for them to press anything. (I discuss the workings of <code>getkey()</code> in <a data-type="xref" href="ch03.html#using_lua_values_in_c">Chapter 3</a>, when we talk more about getting input.) This code is an improvement built on the previous <em>eatyguy1.c</em> code. Again, the differences are in bold:</p>

<pre data-type="programlisting">
// This code is part of the file eatyguy2.c, which is the same
// as eatyguy1.c except for lines in bold.

<strong>// This requires us to #include &lt;fcntl.h&gt; and &lt;unistd.h&gt;.</strong>

<strong>// 27 is the decimal representation of Esc in ASCII.</strong>
<strong>#define ESC_KEY 27</strong>

<strong>int getkey() {</strong>

  <strong>// Make reading from stdin nonblocking.</strong>
  <strong>int flags = fcntl(STDIN_FILENO, F_GETFL);</strong>
  <strong>fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK);</strong>

  <strong>int ch = getchar();</strong>

  <strong>// Turn off nonblocking I/O. On some systems, leaving stdin</strong>
  <strong>// nonblocking will also leave stdout nonblocking, which</strong>
  <strong>// can cause printing errors.</strong>
  <strong>fcntl(STDIN_FILENO, F_SETFL, flags);</strong>
  <strong>return ch;</strong>
<strong>}</strong>

<strong>void start() {</strong>

  <strong>// Terminal setup.</strong>
  <strong>system("tput clear");      // Clear the screen.</strong>
  <strong>system("tput civis");      // Hide the cursor.</strong>
  <strong>system("stty raw -echo");  // Improve access to keypresses.</strong>
<strong>}</strong>

<strong>void done() {</strong>

  <strong>// Put the terminal back into a decent state.</strong>
  <strong>system("stty cooked echo");  // Undo init call to "stty raw".</strong>
  <strong>system("tput reset");        // Reset colors and clear screen.</strong>

  <strong>exit(0);</strong>
<strong>}</strong>

int main() {

  <strong>start();</strong>

  // Create a Lua state and load the module.
  lua_State *L = luaL_newstate();
  luaL_openlibs(L);

  <strong>// Make our Lua-callable functions visible to Lua.</strong>
  <strong>lua_register(L, "set_color", set_color);</strong>
  <strong>lua_register(L, "set_pos",   set_pos);</strong>
  <strong>lua_register(L, "timestamp", timestamp);</strong>

  // Load eatyguy2.lua and run the init() function.
  luaL_dofile(L, "eatyguy2.lua");
  lua_setglobal(L, "eatyguy");
  lua_settop(L, 0);
  lua_getglobal(L, "eatyguy");
  lua_getfield(L, -1, "init");  // -1 means stack top.
  lua_call(L, 0, 0);            // 0, 0 = #args, #retvals

  <strong>lua_getglobal(L, "eatyguy");</strong>
  <strong>while (1) {</strong>
    <strong>// Call eatyguy.loop().</strong>
    <strong>lua_getfield(L, -1, "loop");</strong>
    <strong>lua_call(L, 0, 0);</strong>

    <strong>int c = getkey();</strong>
    <strong>if (c == ESC_KEY || c == 'q' || c == 'Q') done();</strong>
  <strong>}</strong>

  return 0;
}</pre>

<p>The <code>lua_register()</code> function shown in <a data-type="xref" href="ch02.html#c_api_function_luaunderscoreregisterleft">Table 2-8</a> is a slightly shorter version of the <code>lua_pushcfunction()</code>/<code>lua_setglobal()</code> combo that was used in <em>eatyguy1.c</em>.</p>

<table class="border" id="c_api_function_luaunderscoreregisterleft">
	<caption><span class="label">Table 2-8. </span>The C API function lua_register()</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>lua_register(L,</code> <code><em>&lt;lua_name&gt;</em></code><code>,</code> <code><em>&lt;c_fn&gt;</em></code><code>)</code></td>
			<td style="vertical-align: top;">Push the C function <code><em>&lt;c_fn&gt;</em></code> onto the stack, set the value of the Lua global variable <code><em>&lt;lua_name&gt;</em></code> equal to this <code><em>&lt;c_fn&gt;</em></code>, and remove <code><em>&lt;c_fn&gt;</em></code> from the stack.</td>
			<td style="vertical-align: top;">[–0, +0]</td>
		</tr>
	</tbody>
</table>

<p>The <code>start()</code> and <code>done()</code> functions set up and tear down the terminal for use as a game interface. It’s nice to make <code>stdin</code> nonblocking so that calls to <code>getchar()</code> return immediately, even when no key has been pressed. This enables the program to continuously draw new frames and still respond immediately when a key is pressed.</p>

<p>The infinite loop in <code>main()</code> operates as follows:</p>

<ol>
	<li>
	<p>Before the loop begins, the <code>eatyguy</code> table is placed on top of the stack.</p>
	</li>
	<li>
	<p><code>eatyguy.loop()</code> is loaded from that table and called.</p>
	</li>
	<li>
	<p>Because <code>lua_call()</code> removes the function it calls, that function must be reloaded with each iteration of the loop.</p>
	</li>
	<li>
	<p>If the call to <code>lua_getglobal()</code> had been inside the <code>while</code> loop, we’d overflow the stack and could end up with an error such as a segmentation fault (not that I made that mistake myself or anything…).</p>
	</li>
</ol>

<p>To help illustrate a correct use of the stack in this loop, here’s a version of the code with more comments:</p>

<pre data-type="programlisting">
  lua_getglobal(L, "eatyguy");
  <strong>// stack   = [.., eatyguy]</strong>
  while (1) {
    // Call eatyguy.loop().
    lua_getfield(L, -1, "loop");
    <strong>// stack = [.., eatyguy, eatyguy.loop]</strong>
    lua_call(L, 0, 0);
    <strong>// stack = [.., eatyguy]</strong>
    <strong>...</strong>
  }</pre>

<p>Comments like these can be useful when you’re learning about or debugging a series of Lua’s C API calls. Another approach to avoiding stack overflow is to use the <code>lua_gettop()</code> function described in <a data-type="xref" href="ch02.html#c_api_function_luaunderscoregettopleft_p">Table 2-9</a>.</p>

<table class="border" id="c_api_function_luaunderscoregettopleft_p">
	<caption><span class="label">Table 2-9. </span>The C API function lua_gettop()</caption>
	<thead>
		<tr>
			<th style="vertical-align: top;"><strong>C API function</strong></th>
			<th style="vertical-align: top;"><strong>Description</strong></th>
			<th style="vertical-align: top;"><strong>Stack use</strong></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="vertical-align: top;"><code>lua_gettop(L)</code></td>
			<td style="vertical-align: top;">Return the number of values on the stack.</td>
			<td style="vertical-align: top;">[–0, +0]</td>
		</tr>
	</tbody>
</table>

<p>If the return value of this function appears to be increasing without bound, your stack is on its way to an overflow. In that case, ensure that your code is designed to use a finite number of stack slots, and look for the point in the code where the stack appears to be growing more than expected.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Game State and Lua’s Event Loop"><div class="sect2" id="game_state_and_luaapostrophes_event_loop">
<h2>Game State and Lua’s Event Loop</h2>

<p>Let’s write <em>eatyguy2.lua</em> to take advantage of the new functionality provided by C. Previously, the Lua code was called a single time in an <code>init()</code> function. Now, however, there is a new <code>loop()</code> function that will be called until the player quits by pressing the Esc key or the Q key. A common pattern for games is to update the state of the game and then render this state visually. We’ll take that approach:</p>

<pre data-type="programlisting">
-- Part of eatyguy2.lua

function eatyguy.loop()
  update()
  draw()
end</pre>

<p>We’ll add two kinds of game state. First, there will be a <code>player</code> character that moves within the maze. Second, the maze will initially be filled with tasty dots, and these dots will disappear as the player eats them. I’m getting hungry just thinking about it!</p>

<p>The player state consists of a position, a direction, and a next-direction, indicating which way the player would like to move when he gets a chance to turn. This can be set up like so:</p>

<pre data-type="programlisting">
-- Part of eatyguy2.lua

local player = {pos      = {1, 1},
                dir      = {1, 0},
                next_dir = {1, 0}}</pre>

<p>The dots can be stored directly in <code>grid</code>. Instead of storing the value <code>'open'</code> for open spaces, we can store the string <code>'. '</code> in spaces with a dot, and the string <code>' '</code> for spaces where the dot has been eaten. Specifically, the first line of <code>drill_path_from()</code> becomes the following:</p>

<pre data-type="programlisting">
grid[x][y] = '. '</pre>

<p>Likewise, any other instance of <code>'open'</code> in the old script also becomes <code>'. '</code> in this new version.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Updating Player State"><div class="sect2" id="updating_player_state">
<h2>Updating Player State</h2>

<p>Here’s the code to update the player state every time <code>loop()</code> is called:</p>

<pre data-type="programlisting">
-- Part of eatyguy2.lua
-- Check whether a character can move in a given direction.
-- Return can_move, new_pos.
local function can_move_in_dir(character, dir)
  local pos = character.pos
  local grid_x, grid_y = pos[1] + dir[1], pos[2] + dir[2]
  local can_move = grid[grid_x] and grid[grid_x][grid_y]
  return can_move, {grid_x, grid_y}
end

local move_delta     = 0.2  -- seconds
local next_move_time = nil

local function update()
  -- Ensure any dot under the player has been eaten.
  local p = player.pos
  grid[p[1]][p[2]] = '  '

  -- Only move every move_delta seconds.
  if next_move_time == nil then
    next_move_time = timestamp() + move_delta
  end
  if timestamp() &lt; next_move_time then return end
  next_move_time = next_move_time + move_delta

  -- Try to change direction; if we can't, next_dir will take
  -- effect at a corner where we can turn in that direction.
  local all_dirs = {{1, 0}, {-1, 0}, {0, 1}, {0, -1}}
  if can_move_in_dir(player, player.next_dir) then
    player.dir      = player.next_dir
    player.next_dir = all_dirs[math.random(4)]
  end

  -- Move in direction player.dir if possible.
  local can_move, new_pos = can_move_in_dir(player, player.dir)
  while not can_move do
    player.dir = all_dirs[math.random(4)]
    can_move, new_pos = can_move_in_dir(player, player.dir)
  end
  player.old_pos = player.pos  -- Save the old position.
  player.pos = new_pos
end</pre>

<p>The function <code>update()</code> begins by ensuring that the dot the player was on has been eaten by updating the <code>grid[x][y]</code> value at that spot. The <code>move_delta</code> controls how often the player can move to a new position. This value is in seconds, and uses the C-implemented <code>timestamp()</code> function to know how many seconds have elapsed since the last move. Player directions are chosen randomly, but if the player can no longer move in his original direction, the code makes sure to pick a new direction in which he <em>can</em> move. This avoids the player repeatedly walking head-first into a wall.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Drawing the Player State"><div class="sect2" id="drawing_the_player_state">
<h2>Drawing the Player State</h2>

<p>Some creativity is needed to make ASCII characters look like game characters. We’ll use an apostrophe and a less-than sign to produce our hero, shown in <a data-type="xref" href="ch02.html#example_rendering_of_the_player_in_eatyg">Figure 2-4</a>.</p>

<figure><div id="example_rendering_of_the_player_in_eatyg" class="figure"><img alt="An example rendering of the player in EatyGuy. The less-than sign represents a mouth, and the apostrophe represents an eyeball." src="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/assets/csal_0204.png" width="168" height="160">
<h6><span class="label">Figure 2-4. </span>An example rendering of the player in EatyGuy; the less-than sign represents a mouth, and the apostrophe represents an eyeball</h6>
</div></figure>

<p>Here’s the code to draw this character:</p>

<pre data-type="programlisting">
-- Part of eatyguy2.lua

local function draw()

  -- Choose the sprite to draw. For example, a right-facing
  -- player is drawn as <span style="background-color:#F1C232;">'&lt;</span> alternated with <span style="background-color:#F1C232;">'-</span>
  local draw_data = {
    [ '1,0'] = {"'&lt;", "'-"},
    ['-1,0'] = {"&gt;'", "-'"},
    [ '0,1'] = {"^'", "|'"},
    ['0,-1'] = {"v.", "'."}
  }
  local anim_timestep = 0.2
  local dirkey   = ('%d,%d'):format(player.dir[1],
                                    player.dir[2])
  -- framekey switches between 1 &amp; 2; basic sprite animation.
  local time     = timestamp()
  local framekey = math.floor(time / anim_timestep) % 2 + 1
  local chars    = draw_data[dirkey][framekey]

  -- Draw the player.
  set_color('b', 3)  -- Yellow background.
  set_color('f', 0)  -- Black foreground.
  local x = 2 * player.pos[1]  -- Each tile is 2 chars wide.
  local y =     player.pos[2]
  set_pos(x, y)
  io.write(chars)
  io.flush()

  -- Erase the old player pos if appropriate.
  if player.old_pos then
    local x = 2 * player.old_pos[1]
    local y =     player.old_pos[2]
    set_pos(x, y)
    set_color('b', 0)  -- Black background.
    io.write('  ')
    io.flush()
    player.old_pos = nil
  end
end</pre>

<p>The <code>draw_data</code> table contains the ASCII characters chosen to animate the character depending on the direction it’s facing. The player’s mouth opens and closes over time, which is captured by the <code>framekey</code> that alternates between 0 and 1. The <code>set_color()</code> and <code>set_pos()</code> functions are used to render the player in yellow and black as well as to erase the old position of the character if it has moved.</p>

<p><a data-type="xref" href="ch02.html#time-lapse_sequence_of_the_player_moving">Figure 2-5</a> depicts the example code in action.</p>

<figure><div id="time-lapse_sequence_of_the_player_moving" class="figure"><img alt="A time-lapse sequence of the player moving through a maze. These are screenshots from eatyguy2, which includes a slightly resized maze." src="https://learning.oreilly.com/library/view/creating-solid-apis/9781491986301/assets/csal_0205.png" width="1565" height="979">
<h6><span class="label">Figure 2-5. </span>A time-lapse sequence of the player moving through a maze; these are screenshots from <em>eatyguy2</em>, which includes a slightly resized maze</h6>
</div></figure>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Calling Lua Functions from C More Effectively"><div class="sect1" id="calling_lua_functions_from_c_more_effect">
<h1>Calling Lua Functions from C More Effectively</h1>

<p>In this chapter, we built something startlingly close to a bare-bones API and used that API to build an app that looks rather like a game. One thing that we <em>haven’t</em> done much of is actively pass data from C to Lua—for example, when C calls <code>init()</code> or <code>loop()</code>, it never provides any arguments. We change this in <a data-type="xref" href="ch03.html#using_lua_values_in_c">Chapter 3</a> by adding the ability to control the hero with the arrow keys.</p>
</div></section>
</div></section></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Running a Lua Script from C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Using Lua Values in C</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag">
        
        

        
          <p>You have 6 days left in your trial, Michaelschiner. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="ch02.html#" class="icon-up" onclick="window.Appcues.track('JumpTop_HeronBook')"><div class="visuallyhidden">Back to top</div></a>
  <ul class='js-footer-nav'>
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">&#169; 2021 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="https://learning.oreilly.com/jsi18n/web/" charset="utf-8"></script>
    <script src="https://learning.oreilly.com/library/jsi18n/appcache/" charset="utf-8"></script>
  </body>
</html>
