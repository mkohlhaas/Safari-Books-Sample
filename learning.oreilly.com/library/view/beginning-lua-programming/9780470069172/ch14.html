<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch14.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch14.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch14.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch14.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><!--<![endif]--><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="author" content="O'Reilly Media" /><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780470069172"/><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico" /><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"/><meta property="twitter:account_id" content="4503599627559754" /><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic' rel='stylesheet' type='text/css'><title>14. Managing Information with Databases - Beginning Lua Programming</title><link rel="stylesheet" href="https://learning.oreilly.com/static/CACHE/css/output.5bdb4fcb2aad.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book"></style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780470069172/chapter/ch14.html",
          "book_id": "9780470069172",
          "chapter_uri": "ch14.html",
          "position": 0,
          "user_uuid": "ce47de5b-ce80-49f0-b5cd-c60d3d33b198",
          "next_chapter_uri": "/library/view/beginning-lua-programming/9780470069172/ch15.html"
        
      },
      title: "Beginning Lua Programming",
      author_list: "Aaron Brown, Kurt Jung",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="https://learning.oreilly.com/static/js/src/modernizr.8e35451ddb64.js"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
        }
      };
  </script><link rel="canonical" href="ch14.html"/><meta name="description" content="Chapter 14. Managing Information with Databases As a programmer, you&#39;ll sooner or later need to store information in between invocations of a program. You can store this information in a ... "><meta property="og:title" content="14. Managing Information with Databases" /><meta itemprop="isPartOf" content="/library/view/beginning-lua-programming/9780470069172/" /><meta itemprop="name" content="14. Managing Information with Databases" /><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch14.html" /><meta property="og:site_name" content="Safari" /><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780470069172/" /><meta property="og:description" itemprop="description" content="Chapter 14. Managing Information with Databases As a programmer, you&#39;ll sooner or later need to store information in between invocations of a program. You can store this information in a ... "><meta itemprop="inLanguage" content="en" /><meta itemprop="publisher" content="Wrox" /><meta property="og:type" content="book" /><meta property="og:book:isbn" itemprop="isbn" content="9780470069172" /><meta property="og:book:author" itemprop="author" content="Aaron Brown" /><meta property="og:book:author" itemprop="author" content="Kurt Jung" /><meta property="og:book:tag" itemprop="about" content="Core Programming" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; URL=https://learning.oreilly.com/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198';
      dataLayer.push({userIdentifier: 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '29964b7b-68d8-4532-9a9b-32e089689c1f';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer src="https://learning.oreilly.com/static/js/build/vendor.0eac897f11ed.js"></script><script defer src="https://learning.oreilly.com/static/js/build/reader.c745ea9296ac.js"></script></head>


<body class="reading sidenav nav-collapsed  scalefonts">

    
  <noscript> 
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="ch14.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z" /></svg><span>Home</span></a></li><li class="search"><a href="ch14.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"/></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="ch14.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"/></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a
                href="ch14.html#"
                class="l1 nav-icn "
                
              ><?xml version="1.0" encoding="UTF-8"?><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O&#39;Reilly</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/profile/"
                    class="l2 nav-icn"
                    
                  ><span>Profile</span></a></li><li><a
                    href="https://learning.oreilly.com/history/"
                    class="l2 nav-icn"
                    
                  ><span>History</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/"
                    class="l2 nav-icn"
                    
                  ><span>Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/u/ce47de5b-ce80-49f0-b5cd-c60d3d33b198/"
                    class="l2 nav-icn"
                    
                  ><span>Highlights</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/answers/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"/></svg><span>Answers</span></a></li><li class="flyout-parent"><a
                href="ch14.html#"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"/></g></svg><span>Explore</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/topics/"
                    class="l2 nav-icn"
                    
                  ><span>All Topics</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert"
                    class="l2 nav-icn"
                    
                  ><span>Most Popular Titles</span></a></li><li><a
                    href="https://learning.oreilly.com/recommendations/"
                    class="l2 nav-icn"
                    
                  ><span>Recommended</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0"
                    class="l2 nav-icn"
                    
                  ><span>Early Releases</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/discover/"
                    class="l2 nav-icn"
                    
                  ><span>Shared Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/resource-centers/"
                    class="l2 nav-icn"
                    
                  ><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch14.html#"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z" /></svg><span>Live Events</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/attend/"
                    class="l2 nav-icn"
                    
                  ><span>All Events</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/architectural-katas/"
                    class="l2 nav-icn"
                    
                  ><span>Architectural Katas</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/ai/"
                    class="l2 nav-icn"
                    
                  ><span>AI &amp; ML</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/strata/"
                    class="l2 nav-icn"
                    
                  ><span>Data Sci &amp; Eng</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/oscon/"
                    class="l2 nav-icn"
                    
                  ><span>Programming</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/infrastructure-ops/"
                    class="l2 nav-icn"
                    
                  ><span>Infra &amp; Ops</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/software-architecture/"
                    class="l2 nav-icn"
                    
                  ><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch14.html#"
                class="l1 nav-icn "
                
              ><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interactive</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=content-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Scenarios</span></a></li><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Sandboxes</span></a></li><li><a
                    href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook"
                    class="l2 nav-icn"
                    
                  ><span>Jupyter Notebooks</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/certifications/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"/></svg><span>Certifications</span></a></li><li ><a
                href="https://learning.oreilly.com/preferences/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"/></g></svg><span>Settings</span></a></li><li ><a
                href="https://learning.oreilly.com/public/support/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z" /></svg><span>Support</span></a></li><li ><a
                href="https://get.oreilly.com/email-signup.html"
                class="l1 nav-icn "
                target=&quot;_blank&quot;
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z" /></svg><span>Newsletters</span></a></li><li ><a
                href="https://learning.oreilly.com/accounts/logout/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z" /></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="ch14.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Beginning Lua Programming
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="ch14.html#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track('SearchBook_HeronBook')"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780470069172/chapter/ch14.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track('AddPlaylist_HeronBook')"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="ch14.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track('ChangeFont_HeronBook')"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="ch14.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track('Share_HeronBook')"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a
        class="twitter share-button t-twitter"
        target="_blank"
        aria-label="Share this section on Twitter"
        title="Share this section on Twitter"
      
        href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch14.html&text=Beginning%20Lua%20Programming&via=OReillyMedia"
      ><span>Twitter</span></a></li><li><a
        class="facebook share-button t-facebook"
        target="_blank"
        aria-label="Share this section on Facebook"
        title="Share this section on Facebook"
        href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch14.html"
      ><span>Facebook</span></a></li><li><a
        class="googleplus share-button t-googleplus"
        target="_blank"
        aria-label="Share this secton on Google Plus"
        title="Share this secton on Google Plus"
        href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch14.html"
      ><span>Google Plus</span></a></li><li><a
        class="email share-button t-email"
        aria-label="Share this section via email"
        title="Share this section via email"
      
        href="mailto:?subject=Safari: 14.%20Managing%20Information%20with%20Databases&body=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch14.html%0D%0Afrom Beginning%20Lua%20Programming%0D%0A"
      ><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer src="https://learning.oreilly.com/static/js/build/djangoMessagesPage.bfaca9fd8619.js"></script>


        <script src="https://fast.appcues.com/48743.js"></script>
<script>
  var userId = "ce47de5b-ce80-49f0-b5cd-c60d3d33b198";

  var userObject = {
    firstName: "Michael",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2021-05-13",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="ch13.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">13. Interfacing Lua with Other Languages</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="ch15.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">15. Programming for the Web</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="managing_information_with_databases"></a>Chapter 14. Managing Information with Databases</h1></div></div></div><p>As a programmer, you'll sooner or later need to store information in between invocations of a program. You can store this information in a text file and decode it with patterns, or you can store it in a Lua file and reloade it with <code class="literal">loadfile</code>. But sometimes these methods aren't sufficiently fast, powerful, flexible, or scalable, in which case, you should store the information in a database. This chapter is a very brief introduction to databases and database systems. It will cover the following:<a id="IDX-CHP-14-0001" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How data is organized in and retrieved from a database</p></li><li class="listitem"><p>SQL, the special-purpose language used to interact with databases</p></li><li class="listitem"><p>LuaSQL, a set of Lua bindings for a number of popular database systems</p></li></ul></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="some_basic_relational_database_concepts"></a>Some Basic Relational Database Concepts</h1></div></div></div><p>This section demonstrates some basic database concepts by having you implement a simple database and a system for retrieving data from it entirely in Lua.</p><p>Almost all databases in use today are what are known as <span class="emphasis"><em>relational databases</em></span> because they are designed to work with relationships between things (the previous generation of databases was not good at this). In the following example, the things in question are customers, products, and orders of an imaginary business. The relational aspect is the fact that the orders are defined in terms of the products ordered and the customers who ordered them.<a id="IDX-CHP-14-0002" class="indexterm"></a><a id="IDX-CHP-14-0003" class="indexterm"></a></p><div class="sidebar"><a id="try_it_out_colon_creating_a_simple_datab"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Creating a Simple Database Entirely in Lua</strong></p></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following as <code class="literal">join.lua</code>:</p><pre class="programlisting">-- A demonstration of a simple relational database with join
-- functionality entirely in Lua.

-- Example database tables:
Cust = {
  {Id = "C001", NameLast = "Bumppo", NameFirst = "Natty"},
  {Id = "C002", NameLast = "Finn", NameFirst = "Huckleberry"},
  {Id = "C003", NameLast = "Darcy", NameFirst = "Fitzwilliam"},
  {Id = "C004", NameLast = "Bennet", NameFirst = "Elizabeth"},
  {Id = "C005", NameLast = "Marner", NameFirst = "Silas"},
}
Product = {
  {Id = "P001", DescStr = "whatchamacallit"},
  {Id = "P002", DescStr = "gizmo"},
  {Id = "P003", DescStr = "gewgaw"},
  {Id = "P004", DescStr = "thingamajig"},
  {Id = "P005", DescStr = "widget"},
  {Id = "P006", DescStr = "doodad"},
  {Id = "P007", DescStr = "whatsit"},
}
Order = {
  {Id = "O001", CustId = "C003", ProductId = "P002", Count = 52},
  {Id = "O002", CustId = "C003", ProductId = "P004", Count = 87},
  {Id = "O003", CustId = "C004", ProductId = "P001", Count = 12},
  {Id = "O004", CustId = "C004", ProductId = "P003", Count = 8},
  {Id = "O005", CustId = "C004", ProductId = "P005", Count = 20},
  {Id = "O006", CustId = "C002", ProductId = "P004", Count = 2},
}

-- Returns a new database table composed of the selected columns of
-- Tbl1 and Tbl2 where WhereFnc is true:
function Join(Tbl1, Tbl1Select, Tbl2, Tbl2Select, WhereFnc)
  local Ret = {}
  -- For each pairing of rows:
  for _, Tbl1Row in ipairs(Tbl1) do
    for _, Tbl2Row in ipairs(Tbl2) do
      if WhereFnc(Tbl1Row, Tbl2Row) then
        -- WhereFnc is true, so include the selected fields of this
        -- pairing in the result:
        local RetRow = {}
        for _, Tbl1Col in ipairs(Tbl1Select) do
          RetRow[Tbl1Col] = Tbl1Row[Tbl1Col]
        end
        for _, Tbl2Col in ipairs(Tbl2Select) do
          RetRow[Tbl2Col] = Tbl2Row[Tbl2Col]
        end
        Ret[#Ret + 1] = RetRow
      end
    end
  end</pre><pre class="programlisting">return Ret
end

-- Space-padding helper function for ShowDbTbl:
local function ShowField(Str, Width, Numeric)
  local Pad = string.rep(" ", Width - string.len(Str))
  if Numeric then
    io.write(Pad, Str, " ")
  else
    io.write(Str, Pad, " ")
  end
end

-- Displays a database table (an array of associative rows):
function ShowDbTbl(Tbl)
  local ColList = {}
  -- Get the width of each column name and type of each column:
  for ColStr, Val in pairs(Tbl[1]) do
    ColList[#ColList + 1] = {Name = ColStr,
      Width = string.len(ColStr), Numeric = type(Val) == "number"}
  end
  -- Get the maximum width of each column:
  for _, Row in ipairs(Tbl) do
    for _, Col in ipairs(ColList) do
      Col.Width = math.max(string.len(Row[Col.Name]), Col.Width)
    end
  end
  -- Display a column header:
  for _, Col in ipairs(ColList) do
    ShowField(Col.Name, Col.Width, Col.Numeric)
  end
  io.write("\n")
  for _, Col in ipairs(ColList) do
    ShowField(string.rep("-", Col.Width), Col.Width, false)
  end
  io.write("\n")
  -- Display the rows:
  for _, Row in ipairs(Tbl) do
     for _, Col in ipairs(ColList) do
        ShowField(Row[Col.Name], Col.Width, Col.Numeric)
     end
     io.write("\n")
  end
end

-- Demonstration:
CustOrder = Join(Cust, {"NameLast"},
   Order, {"ProductId", "Count"},
   function(Cust, Order) return Cust.Id == Order.CustId end)
print("*** Cust joined to Order ***")
ShowDbTbl(CustOrder)
print()
CustOrderProduct = Join(CustOrder, {"NameLast", "Count"},
  Product, {"DescStr"},</pre><pre class="programlisting">function(CustOrder, Product)
    return CustOrder.ProductId == Product.Id
  end)
print("*** Cust joined to Order joined to Product ***")
ShowDbTbl(CustOrderProduct)
print()
Bennet = Join(CustOrder, {"Count"},
  Product, {"DescStr"},
  function(CustOrder, Product)
    return CustOrder.ProductId == Product.Id
      and CustOrder.NameLast == "Bennet"
  end)
print("*** All orders by customer 'Bennet' ***")
ShowDbTbl(Bennet)</pre></li><li class="listitem"><p>Run it with this:</p><pre class="programlisting">lua join.lua</pre><p>The output will be:</p><pre class="programlisting">*** Cust joined to Order ***
Count   NameLast  ProductId
-----   --------  ---------
    2   Finn      P004
   52   Darcy     P002
   87   Darcy     P004
   12   Bennet    P001
    8   Bennet    P003
   20   Bennet    P005

*** Cust joined to Order joined to Product ***
DescStr          Count  NameLast
---------------  -----  --------
thingamajig          2  Finn
gizmo               52  Darcy
thingamajig         87  Darcy
whatchamacallit     12  Bennet
gewgaw               8  Bennet
widget              20  Bennet

*** All orders by customer 'Bennet' ***
Count   DescStr
-----   ---------------
   12   whatchamacallit
    8   gewgaw
   20   widget</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p>The word "table" has two meanings in this chapter. The Lua <code class="literal">Cust, Product</code>, and <code class="literal">Order</code> tables are also <span class="emphasis"><em>tables</em></span> in a database-specific sense. They are called tables because they can be visualized as arrangements of <span class="emphasis"><em>rows</em></span> and <span class="emphasis"><em>columns</em></span>. The columns have names, but the rows don't. For instance, take a look at this table of customers:</p><pre class="programlisting">Cust = {
  {Id = "C001", NameLast = "Bumppo", NameFirst = "Natty"},
  {Id = "C002", NameLast = "Finn", NameFirst = "Huckleberry"},
  {Id = "C003", NameLast = "Darcy", NameFirst = "Fitzwilliam"},
  {Id = "C004", NameLast = "Bennet", NameFirst = "Elizabeth"},
  {Id = "C005", NameLast = "Marner", NameFirst = "Silas"},
}</pre><p>The following table shows how you can visualize this.</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"><col class="col2"><col class="col3"></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Id</p></th><th style="text-align: left" valign="bottom"><p>NameLast</p></th><th style="text-align: left" valign="bottom"><p>NameFirst</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>C001</p></td><td style="text-align: left" valign="top"><p>Bumppo</p></td><td style="text-align: left" valign="top"><p>Natty</p></td></tr><tr><td style="text-align: left" valign="top"><p>C002</p></td><td style="text-align: left" valign="top"><p>Finn</p></td><td style="text-align: left" valign="top"><p>Huckleberry</p></td></tr><tr><td style="text-align: left" valign="top"><p>C003</p></td><td style="text-align: left" valign="top"><p>Darcy</p></td><td style="text-align: left" valign="top"><p>Fitzwilliam</p></td></tr><tr><td style="text-align: left" valign="top"><p>C004</p></td><td style="text-align: left" valign="top"><p>Bennet</p></td><td style="text-align: left" valign="top"><p>Elizabeth</p></td></tr><tr><td style="text-align: left" valign="top"><p>C005</p></td><td style="text-align: left" valign="top"><p>Marner</p></td><td style="text-align: left" valign="top"><p>Silas</p></td></tr></tbody></table></div><p>An array of associative tables is just one of several ways to conveniently represent a database table as a Lua table.</p><p>In another intersection with Lua terminology, database column names (such as <code class="literal">NameLast</code>) can also be called <span class="emphasis"><em>field names</em></span>, and particular columns in particular rows can be called <span class="emphasis"><em>fields</em></span>. For example, the <code class="literal">NameLast</code> field of the second row in the previous table is "Finn."</p><p>The following call does what is known as a <span class="emphasis"><em>join</em></span> between the <code class="literal">Cust</code> table and the <code class="literal">Order</code> table:</p><pre class="programlisting">CustOrder = Join(Cust, {"NameLast"},
   Order, {"ProductId", "Count"},
   function(Cust, Order) return Cust.Id == Order.CustId end)</pre><p>The <code class="literal">Join</code> function takes a database table (a table in the previously described row/column format), a (not necessarily exhaustive) list of field names from that table, another table, a list of field names from <span class="emphasis"><em>that</em></span> table, and a two-argument function. Using nested <code class="literal">for</code> loops, it goes through every possible pairing of one row from the first table and one from the second (in this case, five times six = thirty pairings) as follows:</p><pre class="programlisting">function Join(Tbl1, Tbl1Select, Tbl2, Tbl2Select, WhereFnc)
  local Ret = {}
  for _, Tbl1Row in ipairs(Tbl1) do
    for _, Tbl2Row in ipairs(Tbl2) do
      if WhereFnc(Tbl1Row, Tbl2Row) then</pre><p>If a pairing makes <code class="literal">WhereFnc</code> return <code class="literal">true</code>, then the selected fields of that pairing are added to the table to be returned (which itself is a row/column-formatted database table) like this:</p><pre class="programlisting">if WhereFnc(Tbl1Row, Tbl2Row) then
      local RetRow = {}
      for _, Tbl1Col in ipairs(Tbl1Select) do
        RetRow[Tbl1Col] = Tbl1Row[Tbl1Col]</pre><pre class="programlisting">end
    for _, Tbl2Col in ipairs(Tbl2Select) do
        RetRow[Tbl2Col] = Tbl2Row[Tbl2Col]
    end
    Ret[#Ret + 1] = RetRow
  end</pre><p>So <span class="emphasis"><em>joining</em></span> two tables means getting the selected fields for all pairings of rows where <code class="literal">WhereFnc</code> is <code class="literal">true</code> (which is why it's called <code class="literal">WhereFnc</code>). In the join between <code class="literal">Cust</code> and <code class="literal">Order</code>, the <code class="literal">WhereFnc</code> returns <code class="literal">true</code> only if <code class="literal">Cust</code>'s <code class="literal">Id</code> is equal to <code class="literal">Order</code>'s <code class="literal">CustId</code>. Because each row of <code class="literal">Order</code> has a unique <code class="literal">Id</code>, and each of <code class="literal">Order</code>'s <code class="literal">CustId</code> fields has a corresponding <code class="literal">Id</code> field in <code class="literal">Cust</code>, this join returns one row for every row in <code class="literal">Order</code>. Specifically it returns the following for every order:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The last name of the customer who made the order</p></li><li class="listitem"><p>The product ID</p></li><li class="listitem"><p>The quantity of the product ordered</p></li></ul></div><p>For example, this shows that Huckleberry Finn ordered two of product <code class="literal">P004</code>:</p><pre class="programlisting">*** Cust joined to Order ***
Count  NameLast  ProductId
-----  --------  ---------
    2  Finn      P004
   52  Darcy     P002
   87  Darcy     P004
   12  Bennet    P001
    8  Bennet    P003
   20  Bennet    P005</pre><p>This <code class="literal">Join</code> function operates on only two database tables at a time, but because the result is itself a database table, it can be joined with yet another table. That's how the product descriptions for each order are retrieved—the join between <code class="literal">CustOrder</code> and <code class="literal">Product</code> gets every order's customer name, count, and product description as follows:</p><pre class="programlisting">CustOrderProduct = Join(CustOrder, {"NameLast", "Count"},
  Product, {"DescStr"},
  function(CustOrder, Product)
    return CustOrder.ProductId == Product.Id
  end)</pre><p>The result shows that the product (<code class="literal">P004</code>) that Huckleberry Finn ordered two of is a thingamajig:</p><pre class="programlisting">*** Cust joined to Order joined to Product ***
DescStr          Count  NameLast
---------------  -----  --------
thingamajig          2  Finn
gizmo               52  Darcy
thingamajig         87  Darcy
whatchamacallit     12  Bennet
gewgaw               8  Bennet
widget              20  Bennet</pre><p>The two joins used their <code class="literal">WhereFnc</code>s to determine which rows of one table go with which rows of the other. The third join's <code class="literal">WhereFnc</code> does this, but then it disqualifies some of those rows for not having the right <code class="literal">NameLast</code> field, as follows:</p><pre class="programlisting">Bennet = Join(CustOrder, {"Count"},
  Product, {"DescStr"},
  function(CustOrder, Product)
    return CustOrder.ProductId == Product.Id
      and CustOrder.NameLast == "Bennet"
  end)</pre><p>The result shows only Elizabeth Bennet's three orders and none of the other customers' orders:</p><pre class="programlisting">*** All orders by customer 'Bennet' ***
Count  DescStr
-----  ---------------
   12  whatchamacallit
    8  gewgaw
   20  widget</pre></div><p>If a <code class="literal">WhereFnc</code> always returns <code class="literal">true</code>, it pairs every row of the first table with every row of the second table, even if those rows have nothing to do with each other. To demonstrate this, run the Lua interpreter (in the same directory as <code class="literal">join.lua</code>) and type:</p><pre class="programlisting">&gt; <strong class="userinput"><code>dofile("join.lua")</code></strong></pre><p>The <code class="literal">join.lua</code> functions and database tables are global, so after it's done printing, you can do the following:</p><pre class="programlisting">&gt; <strong class="userinput"><code>ShowDbTbl(Join(Cust, {"NameLast"},</code></strong>
&gt;&gt;    <strong class="userinput"><code>Order, {"ProductId", "Count"},</code></strong>
&gt;&gt;    function() return true end))</pre><p>This will print out 30 rows. Here are the first 10:</p><pre class="programlisting">Count  NameLast  ProductId
-----  --------  ---------
   52  Bumppo    P002
   87  Bumppo    P004
   12  Bumppo    P001
    8  Bumppo    P003
   20  Bumppo    P005
    2  Bumppo    P004
   52  Finn      P002
   87  Finn      P004
   12  Finn      P001
    8  Finn      P003</pre><p>This (joining every row of one table with every row of the other) is called a <span class="emphasis"><em>cross join</em></span> or <span class="emphasis"><em>Cartesian product</em></span>. It is important for two reasons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>It is the theoretical basis for all other joins. (A cross join will have as many rows as the <code class="literal">Join</code> function's nested loops have iterations.)</p></li><li class="listitem"><p>You may sometimes do it by mistake.</p></li></ul></div><p>An example of doing it by mistake would be leaving out the <code class="literal">CustOrder.ProductId-==-Product.Id</code> condition in the <code class="literal">WhereFnc</code> to get all of Elizabeth Bennet's orders:</p><pre class="programlisting">Bennet = Join(CustOrder, {"Count"},
  Product, {"DescStr"},
  function(CustOrder, Product)
    return CustOrder.NameLast == "Bennet" -- UH-OH, CROSS JOIN!
  end)
ShowDbTbl(Bennet)</pre><p>This will print Elizabeth's three orders, mixed in with 18 orders that don't even exist (they're junk generated by the cross join). Another way of putting that is that it prints each of Elizabeth's three orders seven times, with only one of the seven having the right <code class="literal">DescStr</code>, as shown here:</p><pre class="programlisting">Count  DescStr
-----  ---------------
   12  whatchamacallit
   12  gizmo
   12  gewgaw
   12  thingamajig
   12  widget
   12  doodad
   12  whatsit
    8  whatchamacallit
    8  gizmo
    8  gewgaw
    8  thingamajig
    8  widget
    8  doodad
    8  whatsit
   20  whatchamacallit
   20  gizmo
   20  gewgaw
   20  thingamajig
   20  widget
   20  doodad
   20  whatsit</pre><p>In addition to showing what tables, rows, columns, and joins are, <code class="literal">join.lua</code> demonstrates a few other things.</p><p>One is a principle of database design: don't duplicate information. The <code class="literal">Order</code> table could have looked like this:</p><pre class="programlisting">Order = {
  {Id = "O001", NameLast = "Darcy", NameFirst = "Fitzwilliam",
    DescStr = "gizmo", Count = 52},
  {Id = "O002", NameLast = "Darcy", NameFirst = "Fitzwilliam",
    DescStr = "thingamajig", Count = 87},
  {Id = "O003", NameLast = "Bennet", NameFirst = "Elizabeth",
    DescStr = "whatchamacallit", Count = 12},
  {Id = "O004", NameLast = "Bennet", NameFirst = "Elizabeth",
    DescStr = "gewgaw", Count = 8},
  {Id = "O005", NameLast = "Bennet", NameFirst = "Elizabeth",
    DescStr = "widget", Count = 20},
  {Id = "O006", NameLast = "Finn", NameFirst = "Huckleberry",
    DescStr = "thingamajig", Count = 2},
}</pre><p>This would have made <code class="literal">Cust</code> and <code class="literal">Product</code> unnecessary, but if Elizabeth Bennet got married to Fitzwilliam Darcy and needed to change her last name, it would need to be changed in three places rather than one, which is a hassle and an opportunity for error. Also, real-world database systems generally don't do the string interning discussed in <a class="link" href="ch10.html" title="Chapter 10. Looking Under the Hood">Chapter 10</a>, which means that three occurrences of "<code class="literal">Bennet</code>" take up three times as much space as one.</p><p>If you read up on databases, you'll find out about "normal forms," which for the most part are applications of the "don't duplicate information" principle. The principle is sometimes disobeyed for reasons of efficiency and simplicity.</p><p>Another lesson of <code class="literal">join.lua</code> is that a real database system needs to be more optimized. Imagine if there were a thousand customers and one hundred thousand orders. Finding all orders with the last name "Bennet" would make the nested loop in <code class="literal">Join</code> do <span class="emphasis"><em>one hundred million</em></span> iterations.</p><p>This is solved in real database systems by using <span class="emphasis"><em>indexes</em></span>. This is yet another meaning for a word already well-laden with meanings. In this case, you should think of an index in the back of a book, which lets you go right to the page or pages where a topic is mentioned. An index for <code class="literal">Cust</code>'s <code class="literal">NameLast</code> field might look like this:</p><pre class="programlisting">{Bumppo = {1}, Finn = {2}, Darcy = {3}, Bennet = {4},
  Marner = {5}}</pre><p>If <code class="literal">Join</code> were able to look inside the <code class="literal">WhereFnc</code> and see that the last name "Bennet" was being sought, the table would tell it that the fourth element of <code class="literal">Cust</code> had that last name. (The reason the numbers are wrapped in arrays is in case multiple customers share a last name.)</p><p>The previous table wouldn't speed up a search for "all customers whose last names start with B," but an index that would speed it up might look like this:</p><pre class="programlisting">{{NameLast = "Bennet", 4},
  {NameLast = "Bumppo", 1},
  {NameLast = "Darcy", 3},
  {NameLast = "Finn", 2},
  {NameLast = "Marner", 5}}</pre><p>This array is sorted by last name, so a technique called <span class="emphasis"><em>binary search</em></span> can be used to do the following:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Jump into the middle of the array.</p></li><li class="listitem"><p>If the array element in the middle's <code class="literal">NameLast</code> starts with "<code class="literal">B</code>", then the B's have been found.</p></li><li class="listitem"><p>If not, repeat these steps with the first half or the second half of the array, depending on whether the just-tested element's <code class="literal">NameLast</code> starts with a letter after or before "<code class="literal">B</code>".</p></li></ol></div><p>If there are a lot of customers, this method is much faster than searching through every single customer, because with every iteration, the distance to the thing being searched for is halved or more than halved.<a id="IDX-CHP-14-0004" class="indexterm"></a></p><p>Use of database indexes is outside the scope of this chapter, but all serious database systems offer some way to control what indexes are created.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="sql_comma_luasql_comma_and_mysql"></a>SQL, LuaSQL, and MySQL</h1></div></div></div><p>Most database systems use a language called SQL to express interaction with a database. (It's pronounced "ESS-CUE-ELL," or sometimes even "SEE-kwuhll," and it stands for Structured Query Language, but nobody actually uses the full name.) SQL was designed specifically for this purpose, and is not really usable as a general-purpose language, so it is generally combined with a language (like Lua) that <span class="emphasis"><em>is</em></span> good for general-purpose programming. A program that needs to interact with a database is written in the general-purpose language, except for those parts of program that deal with the database, which are written in SQL.<a id="IDX-CHP-14-0005" class="indexterm"></a></p><p>There are many database systems, all with their own pluses and minuses (and all with their own slightly different dialects of SQL). One is SQLite, which you met in <a class="link" href="ch12.html" title="Chapter 12. Using Community Libraries">Chapter 12</a>. Another popular one is MySQL (pronounced "MY-ESS-CUE-ELL").<a id="IDX-CHP-14-0006" class="indexterm"></a><a id="IDX-CHP-14-0007" class="indexterm"></a></p><p>LuaSQL is a collection of Lua bindings to these and other database systems (PostgreSQL, ODBC, JDBC, Oracle, and ADO). In the remainder of this chapter, you'll be using the LuaSQL binding to MySQL.<a id="IDX-CHP-14-0008" class="indexterm"></a><a id="IDX-CHP-14-0009" class="indexterm"></a></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>LuaSQL currently only exists for Lua 5.0. (That's why the examples here use <code class="literal">string.len</code> instead of #.)</p></div><p>MySQL and LuaSQL are available respectively on <code class="literal"><code class="systemitem">dev.mysql.com</code></code> and <code class="literal"><code class="systemitem">www.keplerproject.org/luasql/</code></code>. You will need to download and install both (according to the instructions on their websites) for the following example to work.</p><p>LuaSQL is part of the Kepler project (<code class="systemitem">www.keplerproject.org</code>), so if you have Kepler installed, then you already have LuaSQL. The following example assumes that a Lua 5.0 interpreter called <code class="literal">lua50</code> is in your search path. If this is not the case, give the full path to the interpreter, changing the following line:</p><pre class="programlisting">lua50 mysql.lua Create</pre><p>to this (for example):</p><pre class="programlisting">"C:\Program Files\Kepler\lua50" mysql.lua Create</pre><p>The script <code class="literal">init.lua</code> in the Kepler directory makes sure that <code class="literal">require</code> knows where to look for the LuaSQL module. The Kepler installer sets your shell's <code class="literal">LUA_INIT</code> environment variable to <code class="literal">@C:\Program Files\Kepler\init.lua</code> (or something similar, depending on where Kepler is installed). This value for <code class="literal">LUA_INIT</code> causes Lua to run <code class="literal">init.lua</code> before running <code class="literal">mysql.lua</code>. (<code class="literal">init.lua</code> has no effect on Lua 5.1.)</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="sql_comma_luasql_comma_and_mysq"></a></h2></div></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_creating_a_customers_co"></a>Try It Out: Creating a Customers, Products, and Orders Table in MySQL</h3></div></div></div><p>In this exercise, you programmatically interact with the MySQL database server by means of a Lua script.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>At your shell, use the following <code class="literal">mysqladmin</code> function to create a new MySQL database called <code class="literal">Lua</code>":</p><pre class="programlisting">mysqladmin -u root -p create Lua</pre><p>You'll be prompted for a password. If you set up a password for the <code class="literal">root</code> (administrator) account when you installed MySQL, type that one. If no password has been set, press Enter.</p></li><li class="listitem"><p>Invoke the MySQL client application as follows:</p><pre class="programlisting">mysql -u root -p</pre><p>After submitting the MySQL root password, you'll see a <code class="literal">mysql&gt;</code> prompt.</p></li><li class="listitem"><p>At the <code class="literal">mysql&gt;</code> prompt, create a new MySQL user account with the username <code class="literal">Lua</code> by typing the following:</p><div class="blockquote"><blockquote class="blockquote"><p><code class="literal">'SmPlPaSs'</code> is the new account's password in this example.</p></blockquote></div><pre class="programlisting">GRANT ALL PRIVILEGES ON Lua.* TO 'Lua'@'localhost'
  IDENTIFIED BY 'SmPlPaSs';</pre></li><li class="listitem"><p>Type <span class="strong"><strong>exit, quit</strong></span>, or \<span class="strong"><strong>q</strong></span> to leave the MySQL client.</p></li><li class="listitem"><p>With your text editor, create a file with the following contents and save it as <code class="literal">mysql.lua</code>:</p><pre class="programlisting">require("luasql.mysql")

-- Executes all of the the SQL statements in List (stopping if one
-- fails):
function ExecSqlList(Conn, List)
  local Succ, ErrStr
  for _, SqlStr in ipairs(List) do
    Succ, ErrStr = Conn:execute(SqlStr)
    if not Succ then break end -- BREAK ON ERROR.
  end
  return Succ, ErrStr
end

-- Space-padding helper function for ShowCursor:
local function ShowField(Str, Width, Numeric)
  local Pad = string.rep(" ", Width - string.len(Str))
  if Numeric then
    io.write(Pad, Str, " ")
  else
    io.write(Str, Pad, " ")
  end
end

-- Displays all the rows in a database cursor, then closes the
-- cursor:
function ShowCursor(Cursor)</pre><pre class="programlisting">---- Get the name of each column and that name's width:
 local ColNames = Cursor:getcolnames()
 local ColWidths = {}
 for I, Name in ipairs(ColNames) do
   ColWidths[I] = string.len(Name)
 end
 -- Find out which columns hold numbers:
 local ColTypes = Cursor:getcoltypes()
 local ColIsNums = {}
 for I, Type in ipairs(ColTypes) do
   if string.sub(Type, 1, 6) == "number" then
     ColIsNums[I] = true
   else
     ColIsNums[I] = false
   end
 end

 -- A wrapper for Cursor:fetch that lets it return a table without
 -- being given one:
 local function RowsIter()
   local Row = {}
   return Cursor:fetch(Row)
 end

 -- Store all rows and the maximum widths of all columns:
 local Rows = {}
 for Row in RowsIter do
   table.insert(Rows, Row)
   for I, Field in ipairs(Row) do
     ColWidths[I] = math.max(ColWidths[I], string.len(Field))
   end
 end
 -- Display a column header:
 for I, ColName in ipairs(ColNames) do
   ShowField(ColName, ColWidths[I], ColIsNums[I])
 end
 io.write("\n")
 for I, ColWidth in ipairs(ColWidths) do
   ShowField(string.rep("-", ColWidth), ColWidth, false)
 end
 io.write("\n")
 -- Display the rows:
 for _, Row in ipairs(Rows) do
   for I, Field in ipairs(Row) do
     ShowField(Field, ColWidths[I], ColIsNums[I])
   end
   io.write("\n")
 end
 Cursor:close()
end

-- Creates the Cust, Product, and Ord tables:
function Create(Conn)
  return ExecSqlList(Conn, {[[
    CREATE TABLE Cust (</pre><pre class="programlisting">Id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    NameLast CHAR(50),
    NameFirst CHAR(50))]], [[
  CREATE TABLE Product (
    Id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    DescStr CHAR(50))]], [[
  CREATE TABLE Ord (
    Id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    CustId INT UNSIGNED,
    ProductId INT UNSIGNED,
    Count INT UNSIGNED)]]})
end

-- Puts rows into Cust, Product, and Ord:
function Populate(Conn)
  return ExecSqlList(Conn, {[[
    TRUNCATE TABLE Cust]], [[
    INSERT INTO Cust (NameLast, NameFirst) VALUES
      ('Bumppo', 'Natty'),
      ('Finn', 'Huckleberry'),
      ('Darcy', 'Fitzwilliam'),
      ('Bennet', 'Elizabeth'),
      ('Marner', 'Silas')]], [[
   TRUNCATE TABLE Product]], [[
   INSERT INTO Product (DescStr) VALUES
     ('whatchamacallit'), ('gizmo'), ('gewgaw'), ('thingamajig'),
     ('widget'), ('doodad'), ('whatsit')]], [[
  TRUNCATE TABLE Ord]], [[
  -- These CustIds and ProductIds are hardcoded, which means this
  -- INSERT would break if the previous INSERTs' auto-increment IDs
  -- didn't start at 1, but the TRUNCATEs make sure they do:
  INSERT INTO Ord (CustId, ProductId, Count) VALUES
    (3, 2, 52),
    (3, 4, 87),
    (4, 1, 12),
    (4, 3, 8),
    (4, 5, 20),
    (2, 4, 2)]]})
end

-- Does some sample SELECTs (joins) and displays the results:
function Test(Conn)
  locasl Cursor, ErrStr
  Cursor, ErrStr = Conn:execute([[
    SELECT NameLast, ProductId, Count
    FROM Cust, Ord
    WHERE Cust.Id = Ord.CustId]])
  if Cursor then
    print(" Cust joined to Order ")
    ShowCursor(Cursor)
    print()
    Cursor, ErrStr = Conn:execute([[
      SELECT NameLast, Count, DescStr
      FROM Cust, Ord, Product
      WHERE Cust.Id = Ord.CustId</pre><pre class="programlisting">AND Ord.ProductId = Product.Id]])
  if Cursor then
    print(" Cust joined to Order joined to Product ")
    ShowCursor(Cursor)
    print()
    Cursor, ErrStr = Conn:execute([[
      SELECT Count, DescStr
      FROM Cust, Ord, Product
      WHERE Cust.Id = Ord.CustId
        AND Ord.ProductId = Product.Id
        AND Cust.NameLast = 'Bennet']])
    if Cursor then
      print(" All orders by customer 'Bennet' ")
      ShowCursor(Cursor)
    end
  end
 end
 return not ErrStr, ErrStr
end

-- Drops the Cust, Product, and Ord tables:
function Drop(Conn)
  return Conn:execute("DROP TABLE IF EXISTS Cust, Product, Ord")
end

-- Get what the LuaSQL documentation calls an "environment":
local MysqlEnv, ErrStr = luasql.mysql()
if MysqlEnv then
  -- Get a connection to the "Lua" database as the user "Lua":
  local Conn
  Conn, ErrStr = MysqlEnv:connect("Lua", "Lua", "SmPlPaSs")
  if Conn then
    -- Obey the command given as a command-line argument:
    local Cmd = arg[1]
    local Succ
    if Cmd == "Create" then
      Succ, ErrStr = Create(Conn)
      if Succ then
        print("Successfully created Cust, Product, and Ord tables")
      end
    elseif Cmd == "Populate" then
      Succ, ErrStr = Populate(Conn)
      if Succ then
        print("Successfully populated Cust, Product, and Ord tables")
      end
    elseif Cmd == "Test" then
      Succ, ErrStr = Test(Conn)
    elseif Cmd == "Drop" then
      Succ, ErrStr = Drop(Conn)
      if Succ then
        print("Successfully dropped Cust, Product, and Ord tables")
      end
    else
      ErrStr = "A command-line argument of 'Create', 'Populate',"
        .. " 'Test', or 'Drop' is required"</pre><pre class="programlisting">end
    Conn:close()
  end
  MysqlEnv:close()
end
if ErrStr then
  io.stderr:write(ErrStr, "\n")
end</pre></li><li class="listitem"><p>At the shell, run it with the <code class="literal">Create</code> command-line argument as follows:</p><pre class="programlisting">lua50 mysql.lua Create</pre><p>It will print this:</p><pre class="programlisting">Successfully created Cust, Product, and Ord tables</pre></li><li class="listitem"><p>Run it again with the <code class="literal">Populate</code> command-line argument as follows:</p><pre class="programlisting">lua50 mysql.lua Populate</pre><p>It will print this:</p><pre class="programlisting">Successfully populated Cust, Product, and Ord tables</pre></li><li class="listitem"><p>Run it one more time with the <code class="literal">Test</code> command-line argument as follows:</p><pre class="programlisting">lua50 mysql.lua Test</pre></li></ol></div><p>It will print this:</p><pre class="programlisting">*** Cust  joined to  Order ***
NameLast  ProductId   Count
--------  ---------   -----
Finn              4       2
Darcy             2      52
Darcy             4      87
Bennet            1      12
Bennet            3       8
Bennet            5      20

*** Cust  joined  to  Order joined to Product ***
NameLast   Count      DescStr
--------  ------      ---------------
Finn           2      thingamajig
Darcy         52      gizmo
Darcy         87      thingamajig
Bennet        12      whatchamacallit
Bennet         8      gewgaw
Bennet        20      widget

*** All orders by customer 'Bennet' ***
Count    DescStr
-----    ---------------
    12   whatchamacallit
     8   gewgaw
    20   widget</pre></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-042"></a>How It Works</h3></div></div></div><p><code class="literal">require("luasql.mysql")</code> creates the <code class="literal">luasql</code> namespace table and puts a function in it called <code class="literal">mysql</code>. With this function, an object (called an environment in the LuaSQL documentation) is created. This object has a <code class="literal">connect</code> method, with which a connection is opened to the database <code class="literal">Lua</code> as the user <code class="literal">Lua</code> with the password <code class="literal">SmPlPaSs</code>:<a id="IDX-CHP-14-0010" class="indexterm"></a><a id="IDX-CHP-14-0011" class="indexterm"></a></p><pre class="programlisting">Conn, ErrStr = MysqlEnv:connect("Lua", "Lua", "SmPlPaSs")</pre><p>After this connection object is obtained, the command-line argument decides which function to run. The first one run is <code class="literal">Create</code>, which calls the function <code class="literal">ExecSqlList</code> with the connection object and a three-element array as arguments. The array's first element is this string:</p><pre class="programlisting">CREATE TABLE Cust (
  Id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  NameLast CHAR(50),
  NameFirst CHAR(50))</pre><p>This is what SQL looks like. SQL keywords, function names, and so on are case-insensitive, but they are often typed in all-uppercase as shown. This is partly to make SQL's rather baroque syntax a bit easier to process visually, and partly just out of tradition. In MySQL, column names are case-sensitive, but database names and table names are only case-sensitive if the filesystem where the database is stored is case-sensitive.</p><p>The preceding <code class="literal">CREATE-TABLE</code> statement creates a table called <code class="literal">Cust</code> with columns <code class="literal">Id, NameLast</code>, and <code class="literal">NameFirst</code>. In MySQL, as in most database systems (SQLite being a notable exception), a given column can hold only one datatype. The <code class="literal">CHAR(50)</code> after <code class="literal">NameLast</code> and <code class="literal">NameFirst</code> means that those columns can each hold a string of up to 50 characters. The <code class="literal">INT-UNSIGNED-NOT-NULL</code> after <code class="literal">Id</code> means that <code class="literal">Id</code> can hold an unsigned integer, but cannot hold the special value <code class="literal">NULL. PRIMARY-KEY</code> has to do with the indexing described at the end of the previous section. (<code class="literal">AUTO_INCREMENT</code> will be explained later.)</p><p>This and the two other <code class="literal">CREATE-TABLE</code> statements are passed to <code class="literal">ExecSqlList</code>, which uses the connection object's <code class="literal">execute</code> method to execute them, creating three tables.</p><div class="blockquote"><blockquote class="blockquote"><p>The <code class="literal">Order</code> table from the example earlier in this chapter was renamed <code class="literal">Ord</code> here because <code class="literal">Order</code> is a reserved word in MySQL.</p></blockquote></div><p>Next, the <code class="literal">Populate</code> function is called, which fills the three tables with data. The <code class="literal">TRUNCATE</code> statements clean out anything that's already in the tables (so that things will still work if you run <code class="literal">Populate</code> twice), and the <code class="literal">INSERT-INTO</code> statements do the actual insertion of data.</p><p>Notice that values are inserted into all the columns except for the <code class="literal">Id</code> columns. This is because the <code class="literal">Id</code> columns of all three tables are <span class="emphasis"><em>auto-increment</em></span> columns, which means that the first row inserted into a given table will get an <code class="literal">Id</code> of <code class="literal">1</code>, the next will get an <code class="literal">Id</code> of <code class="literal">2</code>, and so on. In this example, where all the data is being loaded at once, it would be just as easy to hard-code the <code class="literal">Id</code> fields, but the auto-increment functionality shows its usefulness in more realistic programs, where non-hardcoded rows are added one at a time.</p><p>Finally, <code class="literal">Test</code> is called. It executes three <code class="literal">SELECT</code> statements and uses <code class="literal">ShowCursor</code> to display the results. Each of these <code class="literal">SELECT</code>s consists of three parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A <code class="literal">SELECT</code> clause, which names the columns that will be in the result. This is equivalent to the second and fourth arguments of the <code class="literal">Join</code> function from earlier in the chapter.</p></li><li class="listitem"><p>A <code class="literal">FROM</code> clause, which names the tables that the previously selected columns are in. This is equivalent to the first and third arguments of <code class="literal">Join</code>.</p></li><li class="listitem"><p>A <code class="literal">WHERE</code> clause, which constrains which rows will be in the result. This is equivalent to <code class="literal">Join</code>'s fifth (<code class="literal">WhereFnc</code>) argument. If no <code class="literal">WHERE</code> clause is given, but multiple tables are given in the <code class="literal">FROM</code> clause, then a cross join is done.</p></li></ul></div><p>In both the <code class="literal">SELECT</code> clause and the <code class="literal">WHERE</code> clause, a column can be specified with or without its table name: <code class="literal">TblName.ColName</code> or <code class="literal">ColName</code>. The first form is mandatory if the same column name is used in two tables named in the <code class="literal">FROM</code> clause. This <code class="literal">WHERE</code> clause:</p><pre class="programlisting">SELECT NameLast, ProductId, Count
FROM Cust, Ord
WHERE Cust.Id = Ord.CustId</pre><p>could have been written <code class="literal">WHERE Cust.Id</code><strong class="userinput"><code>-</code></strong><code class="literal">=</code><strong class="userinput"><code>-</code></strong><code class="literal">CustId</code>, because <code class="literal">Cust</code> doesn't have a <code class="literal">CustId</code> column, but not <code class="literal">WHERE-Id</code><strong class="userinput"><code>-</code></strong><code class="literal">=</code><strong class="userinput"><code>-</code></strong><code class="literal">CustId</code>, because <code class="literal">Ord</code> does have an <code class="literal">Id</code> column. (The <code class="literal">=</code> in SQL means the same thing as <code class="literal">==</code> in Lua.)</p><p>More than two tables can be joined by one <code class="literal">SELECT</code> statement, by including them all in the <code class="literal">FROM</code> clause and the appropriate join conditions in the <code class="literal">WHERE</code> clause. If the <code class="literal">FROM</code> clause only names one table, then just rows from that table are selected, and no join is done.</p><p>These <code class="literal">SELECT</code>s are executed by the connection object's <code class="literal">execute</code> method:</p><pre class="programlisting">local Cursor, ErrStr
Cursor, ErrStr = Conn:execute([[
  SELECT NameLast, ProductId, Count</pre><p>When <code class="literal">execute</code> is given a statement that doesn't return any data, like <code class="literal">CREATE</code> or <code class="literal">INSERT</code>, it returns a success Boolean. When it is given a <code class="literal">SELECT</code>, it returns a <span class="emphasis"><em>cursor</em></span> object that is used to read the <code class="literal">SELECT</code>'s results. The cursor has the following methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">getcolnames</code>: Returns an array of the result's column names.</p></li><li class="listitem"><p><code class="literal">getcoltypes</code>: Returns an array of the datatypes of the result's columns.</p></li><li class="listitem"><p><code class="literal">fetch</code>: Returns the first row the first time it's called, the second row the second time it's called, and so on. It returns <code class="literal">nil</code> when there are no more rows.</p></li><li class="listitem"><p><code class="literal">close</code>: Closes the cursor.</p></li></ul></div><p>The <code class="literal">fetch</code> method takes two optional arguments. If given no arguments, it returns as many values as there are columns. If given a Lua table as a first argument, it puts the columns of the row being returned into that table and returns it. If the second argument is not given or if it is "<code class="literal">n</code>" (for "numeric"), then the returned Lua table is an array indexed by column number such as the following:</p><pre class="programlisting">{"Finn", "4", "2"}</pre><p>If the second argument is "<code class="literal">a</code>" (alphanumeric), then the returned table is associative by column name, like this:</p><pre class="programlisting">{NameLast = "Finn", ProductId = "4", Count = "2"}</pre><p>Notice also that LuaSQL's MySQL driver (as of this writing) returns even numeric values as strings.</p><p>The <code class="literal">ShowCursor</code> function uses these methods to display all the rows in the cursor given to it. Most of the work it does is formatting: getting the maximum width of each column and making sure that strings are left-justified and numbers are right-justified.</p><p>If you want to delete the <code class="literal">Cust, Product</code>, and <code class="literal">Ord</code> tables and start over, use <code class="literal">Drop</code> as a command-line argument to <code class="literal">mysql.lua</code>.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="summary-043"></a>Summary</h1></div></div></div><p>This has been a very brief introduction to databases. You haven't even learned about <code class="literal">UPDATE</code> and <code class="literal">DELETE</code>, the SQL statements that change and remove rows, nor have you learned about the nonintuitive behavior of the SQL value <code class="literal">NULL</code>. That information is available in the many books and websites about SQL.</p><p>Here are the highlights of what this chapter did cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Relational databases store data in tables, which are organized in rows and columns.</p></li><li class="listitem"><p>Combining the data from multiple tables is called joining those tables.</p></li><li class="listitem"><p>Combining every single row of one table with every single row of another table is called a cross join.</p></li><li class="listitem"><p>Duplication of data in a database should be avoided when possible.</p></li><li class="listitem"><p>Database systems use indexes for faster searching.</p></li><li class="listitem"><p>SQL is a special-purpose language for interacting with databases.</p></li><li class="listitem"><p>The SQL <code class="literal">CREATE</code> statement creates a table. The <code class="literal">INSERT-INTO</code> statement puts rows into a table. The <code class="literal">SELECT</code> statement reads rows from a table.</p></li><li class="listitem"><p>LuaSQL is a set of Lua bindings for a number of popular database systems, including MySQL.</p></li><li class="listitem"><p>LuaSQL returns the results of a <code class="literal">SELECT</code> as a cursor object with <code class="literal">getcolnames, getcoltypes, fetch</code>, and <code class="literal">close</code> methods.</p></li></ul></div><p>Before you go on to the next chapter, which is about web programming, check out these exercises. (Answers are in the appendix.)</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-044"></a>Exercises</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Write a function that takes a LuaSQL cursor and returns a table in the format used by <code class="literal">Join</code> (an array of associative tables).</p></li><li class="listitem"><p>The following <code class="literal">SELECT</code> doesn't work—it returns an error message. Why?</p></li></ol></div><pre class="programlisting">SELECT Id, CustId, NameLast, ProductId, DescStr, Count
FROM Cust, Ord, Product
WHERE Cust.Id = Ord.CustId
  AND Ord.ProductId = Product.Id</pre></div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="ch13.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">13. Interfacing Lua with Other Languages</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="ch15.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">15. Programming for the Web</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag">
        
        

        
          <p>You have 6 days left in your trial, Michaelschiner. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="ch14.html#" class="icon-up" onclick="window.Appcues.track('JumpTop_HeronBook')"><div class="visuallyhidden">Back to top</div></a>
  <ul class='js-footer-nav'>
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">&#169; 2021 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="https://learning.oreilly.com/jsi18n/web/" charset="utf-8"></script>
    <script src="https://learning.oreilly.com/library/jsi18n/appcache/" charset="utf-8"></script>
  </body>
</html>
