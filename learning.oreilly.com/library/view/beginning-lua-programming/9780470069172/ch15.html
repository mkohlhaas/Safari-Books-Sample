<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch15.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch15.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch15.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch15.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><!--<![endif]--><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="author" content="O'Reilly Media" /><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780470069172"/><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico" /><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"/><meta property="twitter:account_id" content="4503599627559754" /><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic' rel='stylesheet' type='text/css'><title>15. Programming for the Web - Beginning Lua Programming</title><link rel="stylesheet" href="https://learning.oreilly.com/static/CACHE/css/output.5bdb4fcb2aad.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book"></style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780470069172/chapter/ch15.html",
          "book_id": "9780470069172",
          "chapter_uri": "ch15.html",
          "position": 0,
          "user_uuid": "ce47de5b-ce80-49f0-b5cd-c60d3d33b198",
          "next_chapter_uri": "/library/view/beginning-lua-programming/9780470069172/ch16.html"
        
      },
      title: "Beginning Lua Programming",
      author_list: "Aaron Brown, Kurt Jung",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="https://learning.oreilly.com/static/js/src/modernizr.8e35451ddb64.js"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
        }
      };
  </script><link rel="canonical" href="ch15.html"/><meta name="description" content="Chapter 15. Programming for the Web Although the Internet is the infrastructure for a myriad of protocols, e-mail and the Web are the two services most people associate with it. ... "><meta property="og:title" content="15. Programming for the Web" /><meta itemprop="isPartOf" content="/library/view/beginning-lua-programming/9780470069172/" /><meta itemprop="name" content="15. Programming for the Web" /><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch15.html" /><meta property="og:site_name" content="Safari" /><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780470069172/" /><meta property="og:description" itemprop="description" content="Chapter 15. Programming for the Web Although the Internet is the infrastructure for a myriad of protocols, e-mail and the Web are the two services most people associate with it. ... "><meta itemprop="inLanguage" content="en" /><meta itemprop="publisher" content="Wrox" /><meta property="og:type" content="book" /><meta property="og:book:isbn" itemprop="isbn" content="9780470069172" /><meta property="og:book:author" itemprop="author" content="Aaron Brown" /><meta property="og:book:author" itemprop="author" content="Kurt Jung" /><meta property="og:book:tag" itemprop="about" content="Core Programming" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; URL=https://learning.oreilly.com/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198';
      dataLayer.push({userIdentifier: 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '29964b7b-68d8-4532-9a9b-32e089689c1f';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer src="https://learning.oreilly.com/static/js/build/vendor.0eac897f11ed.js"></script><script defer src="https://learning.oreilly.com/static/js/build/reader.c745ea9296ac.js"></script></head>


<body class="reading sidenav nav-collapsed  scalefonts">

    
  <noscript> 
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="ch15.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z" /></svg><span>Home</span></a></li><li class="search"><a href="ch15.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"/></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="ch15.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"/></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a
                href="ch15.html#"
                class="l1 nav-icn "
                
              ><?xml version="1.0" encoding="UTF-8"?><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O&#39;Reilly</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/profile/"
                    class="l2 nav-icn"
                    
                  ><span>Profile</span></a></li><li><a
                    href="https://learning.oreilly.com/history/"
                    class="l2 nav-icn"
                    
                  ><span>History</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/"
                    class="l2 nav-icn"
                    
                  ><span>Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/u/ce47de5b-ce80-49f0-b5cd-c60d3d33b198/"
                    class="l2 nav-icn"
                    
                  ><span>Highlights</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/answers/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"/></svg><span>Answers</span></a></li><li class="flyout-parent"><a
                href="ch15.html#"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"/></g></svg><span>Explore</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/topics/"
                    class="l2 nav-icn"
                    
                  ><span>All Topics</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert"
                    class="l2 nav-icn"
                    
                  ><span>Most Popular Titles</span></a></li><li><a
                    href="https://learning.oreilly.com/recommendations/"
                    class="l2 nav-icn"
                    
                  ><span>Recommended</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0"
                    class="l2 nav-icn"
                    
                  ><span>Early Releases</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/discover/"
                    class="l2 nav-icn"
                    
                  ><span>Shared Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/resource-centers/"
                    class="l2 nav-icn"
                    
                  ><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch15.html#"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z" /></svg><span>Live Events</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/attend/"
                    class="l2 nav-icn"
                    
                  ><span>All Events</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/architectural-katas/"
                    class="l2 nav-icn"
                    
                  ><span>Architectural Katas</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/ai/"
                    class="l2 nav-icn"
                    
                  ><span>AI &amp; ML</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/strata/"
                    class="l2 nav-icn"
                    
                  ><span>Data Sci &amp; Eng</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/oscon/"
                    class="l2 nav-icn"
                    
                  ><span>Programming</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/infrastructure-ops/"
                    class="l2 nav-icn"
                    
                  ><span>Infra &amp; Ops</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/software-architecture/"
                    class="l2 nav-icn"
                    
                  ><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch15.html#"
                class="l1 nav-icn "
                
              ><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interactive</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=content-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Scenarios</span></a></li><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Sandboxes</span></a></li><li><a
                    href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook"
                    class="l2 nav-icn"
                    
                  ><span>Jupyter Notebooks</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/certifications/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"/></svg><span>Certifications</span></a></li><li ><a
                href="https://learning.oreilly.com/preferences/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"/></g></svg><span>Settings</span></a></li><li ><a
                href="https://learning.oreilly.com/public/support/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z" /></svg><span>Support</span></a></li><li ><a
                href="https://get.oreilly.com/email-signup.html"
                class="l1 nav-icn "
                target=&quot;_blank&quot;
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z" /></svg><span>Newsletters</span></a></li><li ><a
                href="https://learning.oreilly.com/accounts/logout/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z" /></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="ch15.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Beginning Lua Programming
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="ch15.html#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track('SearchBook_HeronBook')"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780470069172/chapter/ch15.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track('AddPlaylist_HeronBook')"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="ch15.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track('ChangeFont_HeronBook')"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="ch15.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track('Share_HeronBook')"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a
        class="twitter share-button t-twitter"
        target="_blank"
        aria-label="Share this section on Twitter"
        title="Share this section on Twitter"
      
        href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch15.html&text=Beginning%20Lua%20Programming&via=OReillyMedia"
      ><span>Twitter</span></a></li><li><a
        class="facebook share-button t-facebook"
        target="_blank"
        aria-label="Share this section on Facebook"
        title="Share this section on Facebook"
        href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch15.html"
      ><span>Facebook</span></a></li><li><a
        class="googleplus share-button t-googleplus"
        target="_blank"
        aria-label="Share this secton on Google Plus"
        title="Share this secton on Google Plus"
        href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch15.html"
      ><span>Google Plus</span></a></li><li><a
        class="email share-button t-email"
        aria-label="Share this section via email"
        title="Share this section via email"
      
        href="mailto:?subject=Safari: 15.%20Programming%20for%20the%20Web&body=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch15.html%0D%0Afrom Beginning%20Lua%20Programming%0D%0A"
      ><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer src="https://learning.oreilly.com/static/js/build/djangoMessagesPage.bfaca9fd8619.js"></script>


        <script src="https://fast.appcues.com/48743.js"></script>
<script>
  var userId = "ce47de5b-ce80-49f0-b5cd-c60d3d33b198";

  var userObject = {
    firstName: "Michael",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2021-05-13",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="ch14.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">14. Managing Information with Databases</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="ch16.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">16. Connecting to a Larger World</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="programming_for_the_web"></a>Chapter 15. Programming for the Web</h1></div></div></div><p>Although the Internet is the infrastructure for a myriad of protocols, e-mail and the Web are the two services most people associate with it. In this chapter, you'll learn how nicely Lua fits into the Web part of the equation. In this chapter, you learn about the following:<a id="IDX-CHP-15-0001" class="indexterm"></a><a id="IDX-CHP-15-0002" class="indexterm"></a><a id="IDX-CHP-15-0003" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The basic operation of web servers</p></li><li class="listitem"><p>Generating web content dynamically with Lua</p></li><li class="listitem"><p>Issues with serving dynamic content</p></li><li class="listitem"><p>Handling input from users by means of forms</p></li><li class="listitem"><p>The basics of the Lua-based Kepler web server environment</p></li></ul></div><p>Along the way, you'll see how Lua can make use of community libraries to dynamically generate attractive, informative web pages.</p><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="a_web_server_primer"></a>A Web Server Primer</h1></div></div></div><p>To generate web pages using Lua, you should have a comfortable grasp on how web servers operate. This understanding will let you develop Lua programs that focus on the Web's strengths and deal with the Web's limitations in as graceful a manner as possible. As you'll see in this chapter, a successful web application draws on many different tools, with the web server itself playing the central role.</p><p>Conceptually, a web server is pretty simple. It's an application that runs on a host and listens for inbound connections. It has access to resources, generally web pages, that are handed out in response to requests made by other applications, usually web browsers. These requests and responses conform to a standard known as hypertext transfer protocol, or HTTP. Unlike many other protocols that define how two applications can have an ongoing conversation, HTTP defines a self-contained transaction. It describes how one application, the client, can properly initiate a request and how another application, the server, can properly respond to that request. The lack of dialog is the reason HTTP is often referred to as a connectionless protocol.<a id="IDX-CHP-15-0004" class="indexterm"></a><a id="IDX-CHP-15-0005" class="indexterm"></a><a id="IDX-CHP-15-0006" class="indexterm"></a><a id="IDX-CHP-15-0007" class="indexterm"></a><a id="IDX-CHP-15-0008" class="indexterm"></a></p><p>The notion of the World Wide Web derives from the presence of many web servers and many web browsers throughout the Internet. The one-shot nature of HTTP transactions simplifies the construction of web servers and allows them to scale efficiently to support frequent requests from many clients. The original intent of the Web as a collection of static, browsable, hyperlinked documents was served quite well by this simple model. The web pages themselves are usually prepared in HTML (HyperText Markup Language), a standard that defines how tags are used to define a page's structure, appearance, and links to other pages.<a id="IDX-CHP-15-0009" class="indexterm"></a></p><p>The request/response model has simplicity going for it, but it's got two drawbacks: poor performance and poor memory. Performance suffers when a client needs to connect repeatedly to the same server to retrieve related resources such as the images, scripts, and style sheets associated with a given page. Version 1.1 of the HTTP standard addresses this by specifying that connections be kept alive by default. The second drawback deals with the server's inability to retain the context of a series of transactions. Each transaction, even one that occurs over a keepalive connection, appears to the server as a brand new request from an unknown client. This is not a problem for static documents, but it becomes an issue for dynamically generated content in which a server response depends on the transactions that precede it. One solution to this deficiency is for the server to embed a limited amount of contextual information in the hyperlinks or HTML forms that are part of a dynamically created page. Requests that are based on these links or forms return this information to the server where it can be used to reconstruct the context of the transaction. Another method is for the server to use a cookie, which is a small packet of information that is optionally stored by a web browser at the request of a server and is returned by the browser when making a request of that server. Often, the information passed between the client and web server is simply a small identifier that indexes more information stored on the server.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="dynamic_web_content"></a>Dynamic Web Content</h1></div></div></div><p>Much of what you see in your web browser is generated on the server after you submit an HTTP request. This is where Lua fits into the picture, because it will be called on to generate web pages dynamically. There are two basic server configurations that are responsible: the embedded web server and the extended web server.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="embedded_web_server"></a>Embedded Web Server</h2></div></div></div><p>A limited web server is simple enough to embed into even small applications. A growing number of devices, such as network routers, are implemented this way. One advantage of this approach is that managing the user interface can be made trivially easy. Another advantage is that resources such as file handles or database connections can be kept open for the duration of the application. For the purposes of most applications, an embedded web server needs only a small number of features that a mainstream web server would require. Even a file system is not required.</p><p>Embedding a web server is suitable for applications of all types, not just hardware devices. For example, using the LuaSocket library, you can write a short Lua script that opens a database connection and begins accepting connections on some specific port. Interaction between the user and the database can occur without the overhead of reestablishing the database connection for each transaction.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="extended_web_server"></a>Extended Web Server</h2></div></div></div><p>A general-purpose web server can be extended to run an application that it knows nothing about, as long as it and the application both agree on how to communicate. Mainstream web servers all implement a standard named the Common Gateway Interface (CGI). In this model, when a client requests a resource that specifies a program, the server invokes that program, passing it information about the client, server, and the request itself. The output of the program is then returned to the client. CGI is often associated with HTML forms and user interaction, but at its root, it simply specifies how a web server interfaces with external programs. Much of the dynamically created content on the web is generated this way.<a id="IDX-CHP-15-0010" class="indexterm"></a><a id="IDX-CHP-15-0011" class="indexterm"></a><a id="IDX-CHP-15-0012" class="indexterm"></a><a id="IDX-CHP-15-0013" class="indexterm"></a><a id="IDX-CHP-15-0014" class="indexterm"></a><a id="IDX-CHP-15-0015" class="indexterm"></a><a id="IDX-CHP-15-0016" class="indexterm"></a></p><p>FastCGI is an optimized variation of CGI in which the application and its resources remain active between HTTP transactions.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="creating_content_at_run_time_with_lua"></a>Creating Content at Run Time with Lua</h2></div></div></div><p>For many applications, Lua is the ideal language with which to write CGI programs. One complaint that is leveled against CGI is that each request for dynamic content requires an external program to be executed. Large or otherwise slow programs can degrade performance noticeably. Lua, however, is known for its small footprint and its fast loading and execution of scripts, so it fits in nicely with the CGI model. Lua's flexible text handling and ability to connect with low-level libraries are features that definitely enhance the creation of web applications.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="executing_cgi_scripts"></a>Executing CGI Scripts</h1></div></div></div><p>A key to configuring CGI is to make sure the web server can distinguish programs from static deliverable resources. When a web server identifies a CGI program, it hands the task of actually executing it to the operating system. In order to function properly, the CGI program generally requires some information about the request, network connection, client, and server.<a id="IDX-CHP-15-0017" class="indexterm"></a></p><p>When you tell a web client to request a resource from a server, whether by clicking a hyperlink or using a browser address bar, you are submitting a uniform resource locator (URL, which is pronounced you-are-ell) to the client. Here is an example of a URL:</p><pre class="programlisting">http://localhost/cgi-bin/date.lua?num=3</pre><p>In this example, <code class="literal">http://</code> is the scheme, <code class="literal">localhost</code> is the server, <code class="literal">/cgi-bin/date.lua</code> is the path, and <code class="literal">num=3</code> is the query. In a hyperlink, the scheme and server are often left out, in which case, the browser uses the values that apply to the page that contains the link. The question mark and query apply only when a dynamic resource is requested and even then only sometimes.</p><p>When a web client like a browser contacts a web server, it submits a packet of information that starts with a command that looks like this:</p><pre class="programlisting">POST /cgi-bin/postform.lua HTTP/1.1</pre><p>or this:</p><pre class="programlisting">GET /cgi-bin/submit.lua?name=Natty&amp;number=11 HTTP/1.1</pre><p>Other types of web clients, such as <code class="literal">curl</code>, can request that the web server accept a file for upload using a command like this:<a id="IDX-CHP-15-0018" class="indexterm"></a><a id="IDX-CHP-15-0019" class="indexterm"></a><a id="IDX-CHP-15-0020" class="indexterm"></a><a id="IDX-CHP-15-0021" class="indexterm"></a><a id="IDX-CHP-15-0022" class="indexterm"></a><a id="IDX-CHP-15-0023" class="indexterm"></a></p><pre class="programlisting">PUT /address.html HTTP/1.1</pre><p>In all cases, the command line is followed by headers that provide more details about the transaction. The web server conveys the command and headers to the CGI program by means of the shell environment, a per-process collection of key/value pairs.</p><p>You can recognize the portion of text immediately following the command as the URL with the scheme and server removed. In particular, notice in the <code class="literal">GET</code> example that the query is intact. This is one way of transferring user-provided information to the web server.</p><p>The other way of conveying information to the server is to include it in the information packet. This is how content is uploaded with the <code class="literal">POST</code> and <code class="literal">PUT</code> commands. As you can see from the examples of those commands, the information doesn't appear in the HTTP command. In this case, the headers are followed by the submitted data with one blank line in between. This submitted data will be delivered to the CGI program through a standard pipeline. This conduit connects the standard output of the web server to the standard input of the CGI program, permitting a large amount of data to be streamed efficiently.</p><p>All of the content that the CGI program generates, regardless of the initial command, is returned to the web server through a similar pipeline in the reverse direction. This model simplifies the creation of CGI programs because it keeps network communication issues with the web server and application details with the external program.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="cgi_scripts_on_unix-type_systems"></a>CGI Scripts on Unix-Type Systems</h2></div></div></div><p>On Unix-type systems, scripts may begin with a line (known as a <span class="emphasis"><em>shebang</em></span>) that specifies the path of the interpreter that is to process the program. For example, if a Lua script is marked as executable and begins with the following line, the system will invoke <code class="literal">/usr/local/bin/lua</code> with the name of the script as an argument:<a id="IDX-CHP-15-0024" class="indexterm"></a></p><pre class="programlisting">#!/usr/local/bin/lua</pre><p>The Lua interpreter will skip the first line of a script if it begins with the <code class="literal">#</code> character. This can be a convenience for general scripting because it allows you to launch a Lua script directly from a shell prompt without explicitly invoking <code class="literal">lua</code> itself. With CGI, however, it is imperative, because without the special first line, the system wouldn't know what to do with the script. If you installed Lua in another directory, make the appropriate change.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="cgi_scripts_on_windows"></a>CGI Scripts on Windows</h2></div></div></div><p>In general, Windows examines the extension of a script to determine how to launch it. You need to add some entries into the registry to tell Windows how to properly invoke Lua scripts. The following registry script will set things up for you. Make the appropriate changes if you installed Lua in a different location from the one shown here. Create a new file called <code class="literal">lua.reg</code> and put the following lines into it:</p><pre class="programlisting">REGEDIT4

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\.lua]</pre><pre class="programlisting">@="luafile"
 "Content Type"="application/lua"

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\.luac]
 @="luafile"
 "Content Type"="application/lua"

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\luafile]
 @="Lua script"

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\luafile\DefaultIcon]
 @="C:\\Program Files\\utility\\lua.ico,0"

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\luafile\Shell]

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\luafile\Shell\open]

 [HKEY_LOCAL_MACHINE\SOFTWARE\Classes\luafile\Shell\open\command]
 @="\"c:\\program files\\utility\\lua.exe\" \"%1\""</pre><p>To add the entries to the registry from the Windows Explorer, double-click the file. Alternatively, from the command shell, you can issue this command:<a id="IDX-CHP-15-0025" class="indexterm"></a></p><pre class="programlisting">start lua.reg</pre><p>In either case, choose Yes when you are asked if you want to add the entries.</p><p>Additionally, for recent versions of Windows, an environment variable named <code class="literal">PATHEXT</code> can be augmented with the <code class="literal">.lua</code> extension so that the system recognizes Lua scripts as executable. The value of this variable is a semicolon-delimited series of extensions including the period. To edit it, go to the environment variables dialog box in the control panel systems applet. After this is done, you can type the name of a script directly without specifying its extension.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="installing_a_web_server"></a>Installing a Web Server</h1></div></div></div><p>You'll need access to a working web server with CGI capability to proceed with the exercises in this chapter. Even if your Internet service provider has given you everything you need to create and run CGI scripts, you'll likely find it beneficial to develop and test your Lua CGI scripts with a local web server. Doing so will obviate the need to frequently upload scripts or edit them remotely.<a id="IDX-CHP-15-0026" class="indexterm"></a></p><p>The following sections focus on Apache and a small Win32 server named TinyWeb. Another excellent multi-platform web server is Abyss from Aprelium Technologies. Abyss is highly configurable using a web browser. Kepler is a Lua-based web server environment that will be covered briefly in a later section.<a id="IDX-CHP-15-0027" class="indexterm"></a><a id="IDX-CHP-15-0028" class="indexterm"></a></p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="apache"></a>Apache</h2></div></div></div><p>Apache is an excellent, free choice for your local web server. It operates smoothly and dependably on a wide variety of platforms. Although it is highly configurable, its default settings should need little or no adjustment after you install it. Should you decide to learn its advanced features, your knowledge can be applied to Apache installations on any platform. Source and precompiled binary distributions are available from <code class="systemitem">http://d.apache.org</code>. If you are a Windows user, you'll find the Apache setup program to be a straightforward way of installing this web server on your system.<a id="IDX-CHP-15-0029" class="indexterm"></a><a id="IDX-CHP-15-0030" class="indexterm"></a><a id="IDX-CHP-15-0031" class="indexterm"></a><a id="IDX-CHP-15-0032" class="indexterm"></a></p><p>On Windows, Apache will install an entry in the programs menu. When started, this server will place an icon in the task bar tray. You can right-click this tray icon to restart or stop the server. Apache on Unix-type systems will typically have a script in the <code class="literal">/etc/rc.d</code> directory to manage starting, restarting, and stopping the server.<a id="IDX-CHP-15-0033" class="indexterm"></a></p><p>After installing Apache, you'll need to make an adjustment to its configuration file, <code class="literal">httpd.conf</code>, to make it work with Lua.</p><p>For security reasons, Apache will not make its own environment fully available to the CGI programs it launches. This means that the usual <code class="literal">LUA_PATH</code> and <code class="literal">LUA_CPATH</code> environment variables will not be available to CGI scripts by default. One way or another, you'll need to let Lua scripts know where to look for the modules they need. One way would be to explicitly assign values to the <code class="literal">package.path</code> and <code class="literal">package.cpath</code> variables at the beginning of scripts that require modules. Alternatively, Apache lets you set environment variables for all or parts of its web directory tree. Here you will make the <code class="literal">LUA_PATH</code> and <code class="literal">LUA_CPATH</code> variables known throughout the entire tree. First, retrieve the current values of the variables. From a command shell, execute the following to scroll through the environment listing:</p><pre class="programlisting">set | more</pre><p>If your system has <code class="literal">grep</code>, you can use it as follows to focus the output:</p><pre class="programlisting">set | grep LUA</pre><p>Back up Apache's configuration file, <code class="literal">httpd.conf</code>, and then open it for editing. You'll find this file in the <code class="literal">conf</code> subdirectory of Apache's installation directory. Locate the following line:</p><pre class="programlisting">&lt;Directory /&gt;</pre><p>Beneath it, add two lines such as the following, making the appropriate substitutions for your system's particular values and platform:</p><pre class="programlisting">SetEnv LUA_CPATH "/usr/local/lib/lua/5.1/?.so"
 SetEnv LUA_PATH "?.lua;/usr/local/lib/lua/5.1/?.lua"</pre><p>Restart Apache to make the changes take effect.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="tinyweb"></a>TinyWeb</h2></div></div></div><p>For Windows users looking for a very lightweight web server with CGI capabilities, TinyWeb from Ritlabs may be a suitable choice. It is free, easy to install, and consumes few resources. Obtain the <code class="literal">tinyweb.zip</code> package from <code class="systemitem">www.ritlabs.com/en/products/tinyweb</code>.<a id="IDX-CHP-15-0034" class="indexterm"></a><a id="IDX-CHP-15-0035" class="indexterm"></a></p><p>In a command shell, set up your server environment as follows:</p><div class="blockquote"><blockquote class="blockquote"><p>The instructions shown here assume this will be beneath <code class="literal">c:\program files</code>.</p></blockquote></div><pre class="programlisting">c:
 cd "\program files"
 md tinyweb
 cd tinyweb
 md package
 md htdocs
 md log
 cd htdocs
 echo Hello from TinyWeb &gt; index.html
 md cgi-bin
 md images
 md scripts
 md css</pre><p>To start up properly, TinyWeb needs to find an index file. The one created here is not valid HTML, but it will satisfy the startup requirement.</p><p>Unzip the <code class="literal">tinyweb</code> package in the package subdirectory as follows:</p><div class="blockquote"><blockquote class="blockquote"><p>The 7-zip utility is used here, but any unzipping utility should work.</p></blockquote></div><pre class="programlisting">cd ..\package
 7z x tinyweb.zip</pre><p>Start TinyWeb in its log directory as follows:</p><pre class="programlisting">c:
 cd "\program files\tinyweb\log"
 start ..\package\tiny "c:\program files\tinyweb\htdocs"</pre><p>The argument to <code class="literal">tiny</code> specifies the document root. It must be fully specified. You can create a batch file with these lines to facilitate starting the web server.</p><p>TinyWeb buffers its log files, so in general, you won't be able to read log entries right after submitting a request to the server or encountering a problem. If you need to do this, obtain <code class="literal">sync</code>, which is a free command-line program from <code class="systemitem">www.sysinternals.com</code>. Place <code class="literal">sync</code> in a directory that is in the Windows search path, for example the utility directory recommended in <a class="link" href="ch01.html" title="Chapter 1. Getting Situated">Chapter 1</a>. Invoking the following command commits all pending file buffers on the C drive:</p><pre class="programlisting">sync c</pre><p>To stop TinyWeb, terminate it with the task manager.</p><p>Every file in TinyWeb's <code class="literal">cgi-bin</code> directory (and in every subdirectory you may make beneath it) needs to be a program that can be run from the command shell. As long as Lua has been registered properly (as described in the "<a class="link" href="ch15.html#cgi_scripts_on_windows" title="CGI Scripts on Windows">CGI Scripts on Windows</a>" section earlier in this chapter), you should have no problems running the Lua scripts you place in this directory. TinyWeb does not filter its own environment when executing a CGI program, so it will pass the <code class="literal">LUA_PATH</code> and <code class="literal">LUA_CPATH</code> variables intact to the Lua scripts it runs. Consequently, nothing special needs to be done to make sure that your Lua CGI scripts will be able to successfully load the modules they need.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="testing_your_web_server_with_static_cont"></a>Testing Your Web Server with Static Content</h1></div></div></div><p>In the following sections, you will be accessing your web server by means of a web browser. Make sure your web server has been started before proceeding. The following examples assume you have installed the web server on your own machine. By default, a web server will listen on all network interfaces of the machine on which it is running. For example, if the machine you start the web server on is part of a network and is reachable with the name <code class="literal">schubert</code>, then the web server can be reached from a browser with both this:<a id="IDX-CHP-15-0036" class="indexterm"></a><a id="IDX-CHP-15-0037" class="indexterm"></a><a id="IDX-CHP-15-0038" class="indexterm"></a><a id="IDX-CHP-15-0039" class="indexterm"></a></p><pre class="programlisting">http://localhost/</pre><p>and this:</p><pre class="programlisting">http://schubert/</pre><p>The localhost address works only on the same machine as the web server. The following examples assume this to be the case. Make the appropriate changes if your setup is different.</p><p>Make sure that your web server is functioning properly by asking it for a static page. Point your browser to the following URL to verify that it is serving static pages correctly:<a id="IDX-CHP-15-0040" class="indexterm"></a></p><pre class="programlisting">http://localhost/</pre><p>In the case shown here, the trailing slash following the server name means that you are asking for the default page in the web server's <span class="emphasis"><em>document root</em></span>, a directory that the web server is configured to treat as the topmost folder. Usually this refers to a page named <code class="literal">index.html</code>, although this can typically be configured to something else. If your browser reports that it cannot establish a connection with localhost, your web server has not been started or is somehow not listening on the right interface or port. If it reports a permissions problem, then the server doesn't have authority to read the page. In most cases, the error log of the web server will contain more details about the problem than will be reported to the client. Other problems here will almost certainly involve a visit to the web server's documentation.<a id="IDX-CHP-15-0041" class="indexterm"></a></p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="serving_dynamic_web_content"></a>Serving Dynamic Web Content</h1></div></div></div><p>When your server is delivering static pages properly, test it to see how it does with CGI scripts. This is where you'll start using Lua in a web server environment.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="serving_dynamic_web_conten"></a></h2></div></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_creating_a_simple_time"></a>Try It Out: Creating a Simple Time Server</h3></div></div></div><p>In this Try It Out, you arrange to have your web server call Lua to fulfill a dynamic resource request. Lua will generate a plain-text page with the appropriate header and a line containing the server time.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>In your web server's <code class="literal">cgi-bin</code> directory, make a file called <code class="literal">date.lua</code> with the following line:</p><pre class="programlisting">io.write('Content-Type: text/plain\n\n', os.date(), '\n')</pre></li><li class="listitem"><p>On Unix-type systems that require scripts to have an interpreter path, insert the following line at the top:</p><p><span class="emphasis"><em>If</em></span> <code class="literal">lua</code> <span class="emphasis"><em>is installed somewhere else on your system, modify this line accordingly</em></span>.<a id="IDX-CHP-15-0042" class="indexterm"></a><a id="IDX-CHP-15-0043" class="indexterm"></a><a id="IDX-CHP-15-0044" class="indexterm"></a><a id="IDX-CHP-15-0045" class="indexterm"></a></p><pre class="programlisting">#!/usr/local/bin/lua</pre></li><li class="listitem"><p>On Unix-type systems, mark the script as readable and executable by the web server, as follows:</p><pre class="programlisting">chmod a+rx date.lua</pre></li><li class="listitem"><p>Request the following resource with your web browser:</p><pre class="programlisting">http://localhost/cgi-bin/date.lua</pre><p>The response should be a simple, unformatted display of the system date.</p></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-045"></a>How It Works</h3></div></div></div><p>If you receive the system date in an unadorned web page, the web server correctly identified <code class="literal">date.lua</code> as a script, executed it with Lua, and returned the content that the script generated. In this case, the groundwork is in place to develop more advanced CGI programs in Lua. You may want to examine your web server's log to see how it records a successful CGI transaction.</p><p>If you don't receive the expected page, note the response that you get instead. Your browser will typically report a status code, but you should consult your web server's error log for more details. The following section covers the problems you are most likely to encounter.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="problems_with_cgi_scripts"></a>Problems with CGI Scripts</h2></div></div></div><p>A response from a web server is always accompanied by a three-digit response code. Values in the 200s indicate success; values in the 400s and 500s indicate problems.</p><p>When a CGI request goes bad, the error that is reported is generally one of these:</p><pre class="programlisting">400 Bad Request
 401 Unauthorized
 403 Forbidden
 404 Not Found
 500 Internal Server Error</pre><p>Problems with CGI scripts usually involve one of the following usual suspects:<a id="IDX-CHP-15-0046" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The server mistakes the script for a static page. In this case, the server happily returns the file to your browser, which in turn may display the source code or ask you where you want to save it. This is a web server configuration issue. Remedy this by taking the steps needed to convince your web server that it's dealing with a CGI program, which generally entails placing the script in the designated <code class="literal">cgi-bin</code> directory or configuring the server to allow CGI execution in the script's directory.</p></li><li class="listitem"><p>The server doesn't have authority to run the script. This stems from a permissions problem with the operating system and results in a <code class="literal">403 Forbidden</code> response. When it comes to CGI programs, getting permissions right is an important task. You should run the web server as a user with very limited authority, because CGI scripts can be a source of security breaches. On Unix-type systems, this user (often <code class="literal">nobody</code>) should <span class="emphasis"><em>never</em></span> be a member of groups that would widen its authority. However, this can make it tricky for a CGI developer to assign correct privileges to a script. A reasonable policy is to require all CGI scripts to be cleared by an administrator who has the necessary privileges to place the script in the <code class="literal">cgi-bin</code> directory and to change the script's permissions to make it executable by the web server.<a id="IDX-CHP-15-0047" class="indexterm"></a><a id="IDX-CHP-15-0048" class="indexterm"></a><a id="IDX-CHP-15-0049" class="indexterm"></a><a id="IDX-CHP-15-0050" class="indexterm"></a><a id="IDX-CHP-15-0051" class="indexterm"></a></p></li><li class="listitem"><p>The script itself has an error. Lua's error message may be reported as a web page, or you may get a rather vague message like <code class="literal">Premature end of script headers</code>. In the latter case, the web server's error log should contain the full error message. Running a CGI script from the command shell can be a good way to make sure it doesn't contain errors. In general, it's easier to diagnose problems this way than in a web server environment. With a little effort, more sophisticated CGI scripts that depend on environment variables and possibly standard input can be made to work as well. If you are simply interested in catching syntax errors, you can use <code class="literal">luac</code> to compile it.</p></li><li class="listitem"><p>Your CGI script may have executed properly, but it sent back content that your browser doesn't know how to render. For example, content of type <code class="literal">text/plain</code> cannot be displayed by older versions of Internet Explorer.</p></li><li class="listitem"><p>On Unix-like systems, or on Windows when you have configured Apache to emulate Unix-type behavior, your Lua script may lack or have an improperly specified shebang. This is the first line of the script that looks like <code class="literal">#!/usr/local/bin/lua</code>.</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="asynchronous_calls_to_the_server"></a>Asynchronous Calls to the Server</h2></div></div></div><p>The previous example uses a standard synchronous call to the web server to request the output of the <code class="literal">date.lua</code> CGI script. Each time you refresh the page, the contents of the page (which is not a whole lot in this example) are entirely replaced. Modern browsers support an asynchronous method of calling the server as well. In this case, your browser issues a standard request of the server, but rather than waiting for the server's response, it returns control immediately. Then, when the server does respond, a handler is called that can programmatically deal with the returned content, often by making localized changes to the displayed page.<a id="IDX-CHP-15-0052" class="indexterm"></a></p><p>In the following examples, a JavaScript page named <code class="literal">AjaxRequest.js</code> will be used to simplify the process of making asynchronous calls. It can be obtained freely from here:<a id="IDX-CHP-15-0053" class="indexterm"></a><a id="IDX-CHP-15-0054" class="indexterm"></a></p><pre class="programlisting">http://www.ajaxtoolbox.com/request/full/AjaxRequest.js</pre><p>If it doesn't already exist, create a directory named <code class="literal">scripts</code> beneath the document root of your web server. Place <code class="literal">AjaxRequest.js</code> in this directory. You can test whether it is properly accessible by requesting it explicitly. Point your browser to the following URL and verify that the script is returned:</p><pre class="programlisting">http://localhost/scripts/AjaxRequest.js</pre><div class="sidebar"><a id="try_it_out_colon_implementing_the_time_s"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Implementing the Time Server using AJAX</strong></p></div></div></div><p>Enhance the previous server time example with an asynchronous call to the server. To do this, you'll use HTML which links in the AJAX toolkit script.<a id="IDX-CHP-15-0055" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>With your text editor, create a new file and copy the following lines to it:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

   &lt;html&gt;

   &lt;head&gt;

     &lt;title&gt;Server time&lt;/title&gt;

     &lt;script type="text/javascript" src="/scripts/AjaxRequest.js"&gt;&lt;/script&gt;

     &lt;script type="text/javascript"&gt;

       function NodeReplace(NodeStr, ValStr) {
         var El = document.getElementById(NodeStr);
         var TxtNode = document.createTextNode(ValStr);
         El.replaceChild(TxtNode, El.firstChild);
       } // NodeReplace

       function Get(UrlStr, NodeStr) {
         function LclPrint(Req) {
           NodeReplace(NodeStr, Req.responseText);
         } // LclPrint
         var Req = { 'url':UrlStr, 'onSuccess':LclPrint }
         AjaxRequest.get(Req);
         return false;
       } // Get

     &lt;/script&gt;

   &lt;/head&gt;

 &lt;body&gt;

 &lt;p&gt;&lt;a href="#" onclick="return Get('/cgi-bin/date.lua', 'time');"&gt;Server
 time&lt;/a&gt; &lt;i&gt;&lt;span id="time"&gt; &lt;/span&gt;&lt;/i&gt;&lt;/p&gt;

 &lt;/body&gt;

 &lt;/html&gt;</pre></li><li class="listitem"><p>Save this file as <code class="literal">date.html</code> in your web server's document root directory. Request the following page with your browser:</p><pre class="programlisting">http://localhost/date.html</pre></li><li class="listitem"><p>Click the Server Time hyperlink at intervals to update the time display.</p></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p>Clicking the hyperlink initiates a request for the output of the <code class="literal">date.lua</code> script. Rather than waiting for this call to return, the JavaScript call to the server returns immediately. When the updated system time does arrive, only its designated area (specifically, the span block with the <code class="literal">id</code> value "<code class="literal">time"</code>) on the page is updated. Each time you click the server time link, another call is made, and when the response is received, the contents of the time compartment are updated. The browser page history is not modified, which means that clicking your browser's back button will not take you back to a page with the previous time.</p><p>AJAX is strictly a client-side mechanism. From the web server's point of view, the synchronous and asynchronous calls to <code class="literal">date.lua</code> are indistinguishable.</p><p>If, as you study this example, you begin to imagine a browser that supports a &lt;script type="text/lua"&gt; script tag and the use of Lua coroutines as an elegant replacement for event handlers, you are not alone. But for now, the province of browser scripting belongs to JavaScript.<a id="IDX-CHP-15-0056" class="indexterm"></a><a id="IDX-CHP-15-0057" class="indexterm"></a><a id="IDX-CHP-15-0058" class="indexterm"></a><a id="IDX-CHP-15-0059" class="indexterm"></a><a id="IDX-CHP-15-0060" class="indexterm"></a></p></div><p>For security reasons, an asynchronous call cannot be made to a web server other than the one that served the current page. If it's crucial for you to contact multiple servers from your application, you may need to add a level of indirection by sending all of your asynchronous requests to only one server. This server can then make calls to other web servers and return the content to the original requester.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="producing_a_calendar_dynamically"></a>Producing a Calendar Dynamically</h2></div></div></div><p>A CGI script is essentially a noninteractive program and can call any library function that applies in that context. The following example demonstrates this by presenting a script that, except for producing HTML rather than plain text, functions just as well in a command shell as a web server environment.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_displaying_a_calendar_o"></a>Try It Out: Displaying a Calendar of the Current Month</h3></div></div></div><p>Prepare a script that displays the current month with the current day highlighted. The script will make use of the <code class="literal">os.date</code> function to determine attributes of the current month, such as the day of week that the first day of the month falls on.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following file as <code class="literal">calendar.lua</code> to your web server's <code class="literal">cgi-bin</code> directory:</p><pre class="programlisting">#!/usr/local/bin/lua

 local Cn = {}

 Cn.HdrStr = [[Content-Type: text/html

 &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

 &lt;html&gt;

 &lt;head&gt;

  &lt;title&gt;Calendar&lt;/title&gt;

  &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;

  &lt;link rel="stylesheet" href="/css/general.css" type="text/css" /&gt;

  &lt;style type="text/css"&gt;

  table.data td {border-right : 1px solid; border-bottom : 1px solid;
  border-color:inherit; color:#404040; background-color:#FFFFFF;
  vertical-align:top; width:14%;}

  table.data td.today {background-color:#f0f0ff;}

  table.data td.name {font-weight:bold; text-align:center; color:#505060;</pre><pre class="programlisting">background-color:#f0f0ff;}

  table.data td.edge {width:15%;}

  &lt;/style&gt;

 &lt;/head&gt;

 &lt;body&gt;

 ]]

 Cn.FtrStr = "&lt;/body&gt;\n\n&lt;/html&gt;"

 local DaysInMonth = { 31, 0, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 }

 -- For the specified month and year, this function returns the day of week of
 -- the first day in the month, and the number of days in the month.

 local function Calendar(Year, Month)
   assert(Year &gt; 1900 and Year &lt; 2100, "Year out of range")
   assert(Month &gt;= 1 and Month &lt;= 12, "Month out of range")
   local Rec = os.date("*t", os.time{year = Year, month = Month, day = 1})
   local DayMax = DaysInMonth[Rec.month]
   if DayMax == 0 then
     DayMax = math.mod(Rec.year, 4) == 0 and 29 or 28
   end
   return Rec.wday, DayMax
 end

 local Today = os.date("*t")
 local Dow, DayMax = Calendar(Today.year, Today.month)

 io.write(Cn.HdrStr)

 io.write('&lt;table class="data shade" border="0" cellspacing="0" ',
   'cellpadding="5" summary="" width="100%"&gt;\n',
   '&lt;tbody&gt;\n',
   '&lt;tr&gt;&lt;th colspan="7"&gt;', os.date('%B'), '&lt;/th&gt;&lt;/tr&gt;\n',
   '&lt;tr&gt;\n')
 local Base = 8 - Dow -- Map day to column
 for Col = 1, 7 do
   local Wd = (Col == 1 or Col == 7) and ' edge' or ''
   io.write('&lt;td class="name', Wd, '"&gt;', os.date("%a",
     os.time{year = Today.year, month = Today.month, day = Base + Col}),
     '&lt;/td&gt;\n')
 end
 io.write('&lt;/tr&gt;\n')
 local Day = 2 - Dow -- Map day to column
 while Day &lt;= DayMax do
   io.write('&lt;tr&gt;')
   for Col = 1, 7 do
     io.write(Today.day == Day and '&lt;td class="today"&gt;' or '&lt;td&gt;',
       (Day &gt;= 1 and Day &lt;= DayMax) and Day or '&amp;nbsp;', '&lt;/td&gt;\n')</pre><pre class="programlisting">Day = Day + 1
   end
   io.write("&lt;/tr&gt;\n")
 end
 io.write('&lt;/tbody&gt;&lt;/table&gt;\n')
 io.write(Cn.FtrStr)</pre></li><li class="listitem"><p>This script and others in this chapter generate web pages that refer to the following style sheet. Create a subdirectory named <code class="literal">css</code> in your web server's document. Save the following contents to a file named <code class="literal">general.css</code> in the <code class="literal">css</code> directory:</p><pre class="programlisting">body {background-color : #FFFFFF; color : #404040; font: 9pt/13pt arial;
 margin-left:4em; margin-top:2em; margin-bottom:1em; margin-right:4em;}

 .hdr {padding:3pt; padding-left:1em; font-weight:bold; border-style: solid;
 border-width:1px;}

 .shade {color:#505060; background-color:#D0D0F0; border-color:#B0B0D0;}

 .white {background-color:#FFFFFF;}

 .top {vertical-align:top;}

 .note {font: 8pt/12pt arial; color: #606060; margin-top: 0px;}

 h1 {font: 11pt/15pt arial; color: #606060; font-weight:bold;}

 .right {text-align: right;}

 span.super {vertical-align: super; font-size: smaller;}

 table.data {border-style:solid; border-top-width:1px; border-left-width:1px;
 border-right-width:0px; border-bottom-width:0px;}

 table.data tbody {border-color:inherit; font: 9pt/13pt arial;}

 table.data tr {padding-top:0px; padding-bottom:0px; border-color:inherit;}

 table.data th {border-right : 1px solid; border-bottom : 1px solid;
 border-color:inherit;}

 table.data td {border-right : 1px solid; border-bottom : 1px solid;
 border-color:inherit; color:#404040; background-color:#f6f6ff;}

 table.data td.in {padding-left:16px;}

 form table {border: 1px solid; padding: 6px;}

 form table td {border-right: 0px; border-bottom: 0px;}

 form table td.label {text-align: right; font-weight:bold;}

 form table td.input {text-align: left;}</pre></li><li class="listitem"><p>Verify that your web server can read this page by requesting the following page:<a id="IDX-CHP-15-0061" class="indexterm"></a><a id="IDX-CHP-15-0062" class="indexterm"></a><a id="IDX-CHP-15-0063" class="indexterm"></a><a id="IDX-CHP-15-0064" class="indexterm"></a><a id="IDX-CHP-15-0065" class="indexterm"></a><a id="IDX-CHP-15-0066" class="indexterm"></a></p><pre class="programlisting">http://localhost/css/general.css</pre></li></ol></div><p><a class="link" href="ch15.html#figure_15-1" title="Figure 15.1. Figure 15-1">Figure 15-1</a> shows the kind of page you should see when you request the following URL with your browser:</p><pre class="programlisting">http://localhost/cgi-bin/calendar.lua</pre><div class="figure"><a id="figure_15-1"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1501.png" height="338" alt="Figure 15-1" width="539"></div></div><p class="title"><strong>Figure 15.1. Figure 15-1</strong></p></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-046"></a>How It Works</h3></div></div></div><p>The calendar script is invoked by the web server as a CGI program. It uses date arithmetics to construct the calendar's attributes, and writes out this calendar using a styled table. Notice that the function <code class="literal">Calendar</code> is independent of the script's web context. This makes it a prime candidate for inclusion in a general date module.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="producing_charts_dynamically"></a>Producing Charts Dynamically</h2></div></div></div><p>Charts and other graphs in your web pages are a great way to present at-a-glance data aggregation and to offer insights into informational patterns. The <code class="literal">gd</code> graphics library that you became familiar with in <a class="link" href="ch12.html" title="Chapter 12. Using Community Libraries">Chapter 12</a> is ideally suited for this because with it you can create images programmatically. In this section, you'll learn how to use the <code class="literal">gd</code> library to generate a bar chart that can be presented in a dynamically built web page.<a id="IDX-CHP-15-0067" class="indexterm"></a></p><p>Usually when you place a graph based on some live data in a web page, you want supporting textual details to accompany it. For example, in a business environment, you may want to produce a web page that details recent customer or vendor transactions. In this page, you may want to place a bar chart that summarizes this activity. Embedding the image right into the dynamically created page would be nice, but this isn't the way HTML works. An image in a web page must be referenced as a separate resource using the <code class="literal">src</code> attribute with the <code class="literal">&lt;img&gt;</code> tag. This presents a problem, because you've got two dynamically generated resources—the web page and the chart—that must somehow remain synchronized.<a id="IDX-CHP-15-0068" class="indexterm"></a></p><p>The solution presented here works as follows. When a request is made for a dynamic page, the appropriate CGI script is called. It produces a web page with the appropriate details, usually gleaned from a database. In this page, there is a reference to the image. The <code class="literal">src</code> attribute of the <code class="literal">&lt;img&gt;</code> tag identifies a CGI script that will actually produce the graph. The details of what the graph should look like are submitted as part of the query. This way, the web page details and the query that specifies the appearance of the graph are bound together and any synchronization issues are avoided.</p><p>In the <code class="literal">cgi-bin</code> directory of your web server, create a file with the following contents and name it <code class="literal">bar.lua</code>, marking the file as executable and readable by the web server where necessary:</p><pre class="programlisting">#!/usr/local/bin/lua

 require "gd"
 require "iomode"

 io.modeset(io.stdin, "binary")
 io.modeset(io.stdout, "binary")

 local function LclPng(Str)

  local ValMax = 1 -- Prevent subsequent division by zero
  local ValList = {}
  local ValCount = 0
  local ClrList = {}
  local Factor, Ht, Wd, BarWd, Gap, Hnd, PngStr, ErrStr

  Str = "_" .. string.gsub(string.lower(Str), "_", "__") .. "_"

  local function LclPrm(Prefix, Default)
    local PatStr = "_" .. Prefix .. "(%d+)_"
    local Pos, Pos, NumStr = string.find(Str, PatStr)
    return Pos and tonumber(NumStr) or Default
  end

  Ht = LclPrm("h", 200)
  BarWd = LclPrm("b", 12)
  Gap = LclPrm("g", 4)
  for ValStr in string.gmatch(Str, "_([%.%d%:]+)_") do
    local Pos, NumStr, ClrStr, Val
    Pos, Pos, NumStr, ClrStr = string.find(ValStr, "([%d%.]+)%:(%d+)")
    Val = tonumber(Pos and NumStr or ValStr)
    if Val &gt; ValMax then
      ValMax = Val
    end
    table.insert(ValList, { Val, tonumber(ClrStr) })
    ValCount = ValCount + 1
  end
  if ValCount &gt; 0 then
    Wd = ValCount * (Gap + BarWd) + Gap + 1</pre><pre class="programlisting">Factor = (Ht - Gap) / ValMax
    Hnd = gd.createPalette(Wd, Ht)
    if Hnd then
      -- Background is first color allocated
      ClrList.White = Hnd:colorAllocate(255, 255, 255)
      ClrList.Gray = Hnd:colorAllocate(150, 150, 150)
      ClrList.Black = Hnd:colorAllocate(0, 0, 0)
      -- Allocate colors specified in query string
      for Mode, RdStr, GrStr, BlStr in string.gmatch(Str,
        "_([cfl])(%x%x)(%x%x)(%x%x)_") do
        local Clr = Hnd:colorAllocate(tonumber(RdStr, 16),
          tonumber(GrStr, 16), tonumber(BlStr, 16))
        if Mode == 'c' then
          table.insert(ClrList, Clr)
        elseif Mode == 'l' then
          ClrList.Line = Clr
        else
          ClrList.Fill = Clr
        end
     end
     local ClrDef = ClrList[1] or ClrList.Gray
     ClrList.Line = ClrList.Line or ClrList.Gray
     -- By default, background color is the first color allocated. If a fill
     -- color was specified, fill in the image now.
     if ClrList.Fill then
       Hnd:filledRectangle(1, 1, Wd, Ht, ClrList.Fill)
     end
     local X = Gap
     for J = 1, ValCount do
       local Y = Factor * ValList[J][1]
       local ClrPos = ValList[J][2] or 0
       local Clr = ClrList[ClrPos] or ClrDef
       Hnd:filledRectangle(X, Ht - Y, X + BarWd,
         Ht, ClrList.Line)
       Hnd:filledRectangle(X + 1, Ht + 1 - Y, X + BarWd - 1,
         Ht, Clr)
      X = X + Gap + BarWd
    end
    -- Create border around image
    Hnd:line(0, 0, 0, Ht, ClrList.Line)
    Hnd:line(0, 0, Wd, 0, ClrList.Line)
    Hnd:line(Wd - 1, 0, Wd - 1, Ht - 1, ClrList.Line)
    Hnd:line(0, Ht - 1, Wd - 1, Ht - 1, ClrList.Line)
    -- Load image into Lua string
    PngStr = gd.pngStr(Hnd)
    if not PngStr then
      ErrStr = "Error generating PNG image."
    end
    Hnd = nil
  else
    ErrStr = "Error creating palette-based PNG image."
  end</pre><pre class="programlisting">else
    ErrStr = "No values retrieved from query string."
  end
  return PngStr, ErrStr
 end

 local Http, PngStr, ErrStr, QueryStr

 Http = os.getenv("SERVER_SOFTWARE")
 QueryStr = arg[1] or os.getenv("QUERY_STRING")
 if QueryStr then
   PngStr, ErrStr = LclPng(QueryStr)
 else
   ErrStr = "Error retrieving query string."
 end
 if PngStr then
   if Http then
     io.write('Date: ', os.date(), '\r\n')
     io.write('X-Scripting-Engine: ', _VERSION, '\r\n')
     io.write('X-Graphics-Library: ', gd.VERSION, '\r\n')
     io.write("Content-Transfer-Encoding: binary\r\n")
     io.write('Content-Length: ', string.len(PngStr), '\r\n')
     io.write("Content-Type: image/png\r\n\r\n");
   end
   io.write(PngStr)
 else
   io.write(Http and 'Content-Type: text/plain\r\n\r\n' or '', ErrStr, "\r\n")
 end</pre><p>This script uses the <code class="literal">gd</code> library to create a simple bar chart in <code class="literal">PNG</code> format based only on the arguments that are passed to it. This makes it easy for other dynamic scripts to include charts since no images need to be cached on the server.<a id="IDX-CHP-15-0069" class="indexterm"></a></p><p>Notice the following lines in <code class="literal">bar.lua</code>:</p><pre class="programlisting">Http = os.getenv("SERVER_SOFTWARE")
 QueryStr = arg[1] or os.getenv("QUERY_STRING")</pre><p>These lines let the script know with a moderate degree of certainty whether it is being run in a web server environment or in a command shell. If <code class="literal">Http</code> is not <code class="literal">nil</code>, an HTTP header will be written before the <code class="literal">PNG</code> file contents. This is the response a web browser expects from its request. This technique is useful when developing a CGI script. It is generally easier to develop a script while working in a command shell than while working with a web server, and this practice permits the script to be run in either environment without modification.</p><p>To test <code class="literal">bar.lua</code> from a command shell, invoke it as in the following example:</p><pre class="programlisting">lua bar.lua 12_23_34 &gt; test.png</pre><p>The string of numbers delimited with underscores is used by <code class="literal">bar.lua</code> to construct a simple bar chart. You can view the resulting test image with a web browser by opening it as a file.<a id="IDX-CHP-15-0070" class="indexterm"></a><a id="IDX-CHP-15-0071" class="indexterm"></a></p><p>To generate the same chart in a web server environment, request the following:</p><pre class="programlisting">http://localhost/cgi-bin/bar.lua?12_23_34</pre><p>The question mark after <code class="literal">bar.lua</code> in this reference separates the resource name from the arguments to be submitted by the web server to the CGI script.</p><p>To include a chart in a web page, reference it as follows:</p><pre class="programlisting">&lt;img src="/cgi-bin/bar.lua?12_23_34" alt="Chart" /&gt;</pre><p>The arguments to a CGI script are conventionally divided into key/value pairs. For example:</p><pre class="programlisting">height=200&amp;width=500</pre><p>To save some space in the URL, the bar chart script deviates from this practice and uses its own format. The argument string comprises a series of tokens that are separated from one another with an underscore character. Basically, you specify the height of each vertical bar in order. The following sequence creates a chart with bars of height 12, 23, and 34, scaled so that the tallest bar just fits into the height of the chart:</p><pre class="programlisting">12_23_34</pre><p>To specify the same chart with a non-default height, use a sequence like this:</p><pre class="programlisting">H150_12_23_34</pre><p>The token <code class="literal">H150</code> indicates a chart height of 150 pixels.</p><p>The following table shows all of the supported tokens. Prefixes and hexadecimal numbers can be specified in either uppercase or lowercase.<a id="IDX-CHP-15-0072" class="indexterm"></a></p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"><col class="col2"><col class="col3"><col class="col4"></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Prefix</p></th><th style="text-align: left" valign="bottom"><p>Numeric Type</p></th><th style="text-align: left" valign="bottom"><p>Description</p></th><th style="text-align: left" valign="bottom"><p>Default</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">H</code></p></td><td style="text-align: left" valign="top"><p>Integer</p></td><td style="text-align: left" valign="top"><p>Chart height in pixels</p></td><td style="text-align: left" valign="top"><p><code class="literal">200</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">B</code></p></td><td style="text-align: left" valign="top"><p>Integer</p></td><td style="text-align: left" valign="top"><p>Bar width in pixels</p></td><td style="text-align: left" valign="top"><p><code class="literal">12</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">G</code></p></td><td style="text-align: left" valign="top"><p>Integer</p></td><td style="text-align: left" valign="top"><p>Gap between bars in pixels</p></td><td style="text-align: left" valign="top"><p><code class="literal">4</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">C</code></p></td><td style="text-align: left" valign="top"><p>Hexadecimal</p></td><td style="text-align: left" valign="top"><p>Bar color</p></td><td style="text-align: left" valign="top"><p><code class="literal">969696</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">F</code></p></td><td style="text-align: left" valign="top"><p>Hexadecimal</p></td><td style="text-align: left" valign="top"><p>Chart background fill color</p></td><td style="text-align: left" valign="top"><p><code class="literal">FFFFFF</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">L</code></p></td><td style="text-align: left" valign="top"><p>Hexadecimal</p></td><td style="text-align: left" valign="top"><p>Chart line color</p></td><td style="text-align: left" valign="top"><p><code class="literal">969696</code></p></td></tr><tr><td style="text-align: left" valign="middle"> </td><td style="text-align: left" valign="top"><p>Float or Integer</p></td><td style="text-align: left" valign="top"><p>Height of bar</p></td><td style="text-align: left" valign="middle"> </td></tr></tbody></table></div><p>The color prefixes (<code class="literal">C, F</code>, and <code class="literal">L</code>) are followed by a six-digit hexadecimal number in which the first pair of digits is red, the middle pair is green, and the last pair is blue. For example, the following specifies bright red for the bar color:<a id="IDX-CHP-15-0073" class="indexterm"></a><a id="IDX-CHP-15-0074" class="indexterm"></a></p><pre class="programlisting">CFF0000</pre><p>The first bar color value that you specify is used for each of the bars, unless the bar height token is followed by a colon and a bar color position. For example, this sequence results in a chart with three bars, with the first and last bars in red and the middle bar in blue:</p><pre class="programlisting">CFF0000_C0000FF_12_23:2_34</pre><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_creating_a_simulated_re"></a>Try It Out: Creating a Simulated Report with Bar Chart</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Using the bar chart script, generate a live report. Create a new file and copy in these lines:</p><pre class="programlisting">#!/usr/local/bin/lua

 local Cn = {}

 Cn.HdrStr = [[Content-Type: text/html

 &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

 &lt;html&gt;

 &lt;head&gt;

   &lt;title&gt;Bogosity Index&lt;/title&gt;

   &lt;link rel="stylesheet" href="/css/general.css" type="text/css" /&gt;

 &lt;/head&gt;

 &lt;body&gt;

 ]]

 Cn.FtrStr = "&lt;/body&gt;\n\n&lt;/html&gt;"

 -- This function returns an indexed table and bar chart specifier. The table
 -- contains DayCount (default 31) simulated data records. Each record is an
 -- indexed table of the form {date, value}. The chart specifier is a string
 -- with each value separated by an underscore.

 local function LclDataRetrieve(DayCount)
   DayCount = DayCount or 31
   local Lo, Hi, SecPerDay = −0.3, 2.3, 60 * 60 * 24
   local Tm = os.time() - DayCount * SecPerDay
   local ValList, RecList = {}, {}</pre><pre class="programlisting">for J = Lo, Hi, (Hi - Lo) / DayCount do
      local DtStr = string.gsub(os.date("%A %d %B", Tm), " 0", " ")
      Tm = Tm + SecPerDay
      local Val = 100 + math.floor(300 * math.sin(J) + math.random(0, 60))
      table.insert(RecList, {DtStr, Val})
      table.insert(ValList, Val)
    end
    return RecList, table.concat(ValList, "_")
  end

  local Out = io.write
  local CnColCount = 3
  local List, UrlStr = LclDataRetrieve()
  local RowCount = #List
  local Split = math.ceil(RowCount / CnColCount)

  Out(Cn.HdrStr, '&lt;h1&gt;Recent Bogon Flux Averages&lt;/h1&gt;\n',
    '&lt;div&gt;&lt;img src="/cgi-bin/bar.lua?h50_cD0D0F0_l9090B0_ff6f6ff_', UrlStr,
    '" alt="Bogosity chart" /&gt;&lt;/div&gt;\n',
    '&lt;p class="note"&gt;Average bogon flux values (10&lt;span class="super"&gt;9&lt;/span&gt; ',
    'bogons / m&lt;span class="super"&gt;2&lt;/span&gt;) from ', List[1][1],
    ' to ', List[RowCount][1], '&lt;/p&gt;\n',
    '&lt;table summary=""&gt;&lt;tbody&gt;&lt;tr&gt;\n')
 local Row = 1
 for Col = 1, CnColCount do
   Out('&lt;td&gt;&lt;table class="data shade" border="0" cellspacing="0" ',
   'cellpadding="5" summary=""&gt;\n',
   '&lt;tbody&gt;\n',
   '&lt;tr&gt;&lt;th&gt;Date&lt;/th&gt;&lt;th&gt;Bogon Flux&lt;/th&gt;&lt;/tr&gt;\n')
   for J = 1, Split do
     local Dt, Val
     local Rec = List[Row]
     if Rec then
       Dt, Val = Rec[1], Rec[2]
       Row = Row + 1
     else
       Dt, Val = "&amp;nbsp;", "&amp;nbsp;"
     end
     Out('&lt;tr&gt;&lt;td&gt;', Dt, '&lt;/td&gt;&lt;td class="right"&gt;', Val, '&lt;/td&gt;&lt;/tr&gt;\n')
   end
   Out('&lt;/tbody&gt;\n&lt;/table&gt;&lt;/td&gt;\n')
 end
 Out('&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n', Cn.FtrStr)</pre></li><li class="listitem"><p>Save this file as <code class="literal">bogosity.lua</code> in your web server's <code class="literal">cgi-bin</code> directory. As always, make sure the permissions are set so that the web server can read and execute the script.</p></li><li class="listitem"><p>Request <code class="systemitem">http://localhost/cgi-bin/bogosity.lua</code> in your web browser. <a class="link" href="ch15.html#figure_15-2" title="Figure 15.2. Figure 15-2">Figure 15-2</a> shows the kind of page you can expect.<a id="IDX-CHP-15-0075" class="indexterm"></a></p></li></ol></div><div class="figure"><a id="figure_15-2"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1502.png" width="549" alt="Figure 15-2" height="500"></div></div><p class="title"><strong>Figure 15.2. Figure 15-2</strong></p></div><p><span class="strong"><strong><a class="link" href="ch15.html#figure_15-2" title="Figure 15.2. Figure 15-2">Figure 15-2</a></strong></span></p></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-047"></a>How It Works</h3></div></div></div><p>When you request the <code class="literal">bogosity.lua</code> resource, your web server recognizes it as a CGI script. During execution, it obtains a table of information to display. In this case, the data is generated internally, but it would be typical for this information to come from a database, system logs, or some other external source. It then writes out the text of what will become a valid HTML page. Note that the bar chart graphic is not created in this step; it is only specified in the <code class="literal">&lt;img&gt;</code> tag. When the browser displays the page, it makes another call to the server to obtain the chart. All of the information needed to produce the graph is passed along with the URL.</p><p>Even though the contents of this page are nonsensical, the script provides a good platform on which to base dynamic, informative pages.</p><p>A graph generated this way is limited by the amount of descriptive information you can convey to the script that creates it. Browsers and servers may each impose limits on the number of characters that can be transferred as part of URL. If you must submit more information than can fit within several hundred characters, you may need to devise an alternate method of describing the graph. For example, you could encode the bar heights in base 64 (a common method of expressing binary data using a set of 64 characters). Each bar could then be specified with two such characters (allowing a range from 0 to 4095), making the bar height delimiters unnecessary. Additionally, you could predefine a color table in <code class="literal">bar.lua</code> and specify colors by table offset rather than 24-bit values.<a id="IDX-CHP-15-0076" class="indexterm"></a><a id="IDX-CHP-15-0077" class="indexterm"></a><a id="IDX-CHP-15-0078" class="indexterm"></a><a id="IDX-CHP-15-0079" class="indexterm"></a><a id="IDX-CHP-15-0080" class="indexterm"></a></p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="interactive_cgi_applications"></a>Interactive CGI Applications</h1></div></div></div><p>The dynamic pages you've generated so far have not been interactive. You'll now learn about HTML forms that allow you to write scripts that process information provided by the user. HTML forms are rather primitive when compared with most desktop applications, and the simple HTTP request/response model that works so well with static content is decidedly clumsy with interactive content. However, even with its limitations, the interactive web is an integral part of the Internet experience.<a id="IDX-CHP-15-0081" class="indexterm"></a></p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="cgi_helper_routines"></a>CGI Helper Routines</h2></div></div></div><p>The following file, <code class="literal">cgi.lua</code>, includes several routines that simplify writing CGI scripts in Lua. Place it in your server's module directory (as discussed in <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a>).<a id="IDX-CHP-15-0082" class="indexterm"></a></p><pre class="programlisting">local Cgi = {}

 -- Return a urlencoded copy of Str. For example,
 -- "Here &amp; there + 97% of other places"
 -- is encoded as
 -- "Here%20%26%20there%20%2B%2097%25%20of%20other%20places"

 function Cgi.Encode(Str)
   return string.gsub(Str, '%W', function(Str)
     return string.format('%%%02X', string.byte(Str)) end )
 end

 -- Returns a urldecoded copy of Str. This function reverses the effects of
 -- Cgi.Encode.

 function Cgi.Decode(Str)
   Str = string.gsub(Str, '%+', ' ')
   Str = string.gsub(Str, '%%(%x%x)', function(Str)
     return string.char(tonumber(Str, 16)) end )
   return Str
 end

 -- Returns an escaped copy of Str in which the characters &amp;&lt;&gt;" are escaped for
 -- display in HTML documents.

 function Cgi.Escape(Str)
   Str = string.gsub(Str or "", "%&amp;", "&amp;")
   Str = string.gsub(Str, '%"', "&amp;quot;")
   Str = string.gsub(Str, "%&lt;", "&lt;")
   return string.gsub(Str, "%&gt;", "&gt;")
 end</pre><pre class="programlisting">-- This function returns an associative array with the parsed contents of the
 -- urlencoded string Str. Multiple values with the same name are placed into an
 -- indexed table with the name.

 local function LclParse(Str)
   local Decode, Tbl = Cgi.Decode, {}
   for KeyStr, ValStr in string.gmatch(Str .. '&amp;', '(.-)%=(.-)%&amp;') do
   local Key = Decode(KeyStr)
   local Val = Decode(ValStr)
   local Sub = Tbl[Key]
   local SubCat = type(Sub)
   -- If there are multiple values with the same name, place them in an
   -- indexed table.
   if SubCat == "string" then -- replace string with table
     Tbl[Key] = { Sub, Val }
   elseif SubCat == "table" then -- insert into existing table
     table.insert(Sub, Val)
   else -- add as string field
     Tbl[Key] = Val
   end
 end
 return Tbl
end

-- Returns an associative array with both the GET and POST contents which
-- accompany an HTTP request. Multi-part form data, usually used with uploaded
-- files, is not currently supported.

function Cgi.Params()
  local PostLen, GetStr, PostStr, KeyList, Obj
  KeyList = {
    'PATH_INFO',
    'PATH_TRANSLATED',
    'REMOTE_HOST',
    'REMOTE_ADDR',
    'GATEWAY_INTERFACE',
    'SCRIPT_NAME',
    'REQUEST_METHOD',
    'HTTP_ACCEPT',
    'HTTP_ACCEPT_CHARSET',
    'HTTP_ACCEPT_ENCODING',
    'HTTP_ACCEPT_LANGUAGE',
    'HTTP_FROM',
    'HTTP_HOST',
    'HTTP_REFERER',
    'HTTP_USER_AGENT',
    'QUERY_STRING',
    'SERVER_SOFTWARE',
    'SERVER_NAME',
    'SERVER_PROTOCOL',
    'SERVER_PORT',
    'CONTENT_TYPE',
    'CONTENT_LENGTH',
    'AUTH_TYPE' }</pre><pre class="programlisting">Obj = {}
  for J, KeyStr in ipairs(KeyList) do
    Obj[KeyStr] = os.getenv(KeyStr)
  end
  if not Obj.SERVER_SOFTWARE then -- Command line invocation
    Obj.QUERY_STRING = arg[1]
    PostStr = arg[2]
  elseif "application/x-www-form-urlencoded" == Obj.CONTENT_TYPE then
    -- Web server invocation with posted urlencoded content
    PostLen = tonumber(Obj.CONTENT_LENGTH)
    if PostLen and PostLen &gt; 0 then
      PostStr = io.read(PostLen)
    end
  end
  PostStr = PostStr or ""
  Obj.Post = LclParse(PostStr)
  Obj.POST_STRING = PostStr
  GetStr = Obj.QUERY_STRING or ""
  Obj.Get = LclParse(GetStr)
  return Obj
end

return Cgi</pre><p>Your CGI scripts can then make use of this module as follows:<a id="IDX-CHP-15-0083" class="indexterm"></a></p><pre class="programlisting">local Cgi = require("cgi")</pre><p>The module provides some routines that facilitate the transfer of information between the script and the web server. In particular, the <code class="literal">Cgi.Params</code> function makes it easy to collect information that a user has submitted in a form. <code class="literal">Cgi.Escape</code> prepares text for display in an HTML document by replacing the ampersand, less than, greater than and double quote characters with symbolic replacements. Similarly, <code class="literal">Cgi.Encode</code> makes character substitutions to prepare text for inclusion in a URL. This process is known as urlencoding. <code class="literal">Cgi.Decode</code> reverses this process to extract information.</p><p>The following Try It Out demonstrates how user input is processed by a CGI script.</p><div class="sidebar"><a id="try_it_out_colon_specifying_a_simple_for"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Specifying a Simple Form</strong></p></div></div></div><p>The advantages of inspecting Lua values apply as much to web applications as to other kinds of programs. Here, you will specify a form in a static web page. When you submit the form, a request for the <code class="literal">cgishow.lua</code> resource is made. This is a CGI program that simply displays the values that are part of this request.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Place the following <code class="literal">form.html</code> file in the document root of your web server, and then make sure it is readable by the web server:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

 &lt;html&gt;</pre><pre class="programlisting">&lt;head&gt;

  &lt;title&gt;Simple HTML Form&lt;/title&gt;

  &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;

  &lt;link rel="stylesheet" href="/css/general.css" type="text/css" /&gt;

 &lt;/head&gt;

 &lt;body&gt;

  &lt;h1&gt;Simple form demonstration&lt;/h1&gt;

  &lt;form action="/cgi-bin/cgishow.lua?Number=42" method="get"&gt;

  &lt;div&gt;&lt;input type="hidden" name="Number" value="42" /&gt;&lt;/div&gt;

  &lt;table class="shade" summary=""&gt;&lt;tbody&gt;

  &lt;tr&gt;

    &lt;td class="label"&gt;User&lt;/td&gt;

    &lt;td&gt;&lt;input type="text" size="20" name="User" /&gt;&lt;/td&gt;

    &lt;td class="label"&gt;Password&lt;/td&gt;

    &lt;td&gt;&lt;input type="password" size="20" name="Pass" /&gt;&lt;/td&gt;

  &lt;/tr&gt;

  &lt;tr&gt;

    &lt;td class="label top"&gt;Site(s)&lt;/td&gt;&lt;td&gt;

    &lt;select name="Site" size="4" multiple="multiple"&gt;
      &lt;option value="1"&gt;Abbey of Pomposa, near Ferrara&lt;/option&gt;
      &lt;option value="2"&gt;Castle del Monte, Apulia&lt;/option&gt;
      &lt;option value="3"&gt;Cathedral of Pisa, Pisa&lt;/option&gt;
      &lt;option value="4"&gt;Chancellery Palace, Rome&lt;/option&gt;
      &lt;option value="5"&gt;Church of San Spirito, Florence&lt;/option&gt;
      &lt;option value="6"&gt;Doge's Palace, Venice&lt;/option&gt;
      &lt;option value="7"&gt;Ducal Palace, Urbino&lt;/option&gt;
      &lt;option value="8"&gt;Florence Cathedral, Florence&lt;/option&gt;
      &lt;option value="9"&gt;Leaning Tower, Pisa&lt;/option&gt;
      &lt;option value="10"&gt;Orvieto Cathedral, Orvieto&lt;/option&gt;
      &lt;option value="11"&gt;Ospedale Degli Innocenti, Florence&lt;/option&gt;
      &lt;option value="12"&gt;Palazzo Strozzi, Florence&lt;/option&gt;
      &lt;option value="13"&gt;Pazzi Chapel, Florence&lt;/option&gt;
      &lt;option value="14"&gt;Piazza del Campo, Siena&lt;/option&gt;
      &lt;option value="15"&gt;Ponte Vecchio, Florence&lt;/option&gt;</pre><pre class="programlisting">&lt;option value="16"&gt;S. Andrea, Mantua&lt;/option&gt;
      &lt;option value="17"&gt;S. Maria Della Pace, Rome&lt;/option&gt;
      &lt;option value="18"&gt;S. Maria Novella, Florence&lt;/option&gt;
      &lt;option value="19"&gt;S. Maria degli Angeli, Florence&lt;/option&gt;
      &lt;option value="20"&gt;San Lorenzo, Florence, Florence&lt;/option&gt;
      &lt;option value="21"&gt;San Sebastiano, at Mantua&lt;/option&gt;
      &lt;option value="22"&gt;San Zeno Maggiore, Verona&lt;/option&gt;
      &lt;option value="23"&gt;St. Mark's, Venice&lt;/option&gt;
    &lt;/select&gt;

    &lt;/td&gt;

    &lt;td class="label top"&gt;Remarks&lt;/td&gt;

    &lt;td&gt;&lt;textarea name="Text" rows="3" cols="32"&gt;&lt;/textarea&gt;&lt;/td&gt;

  &lt;/tr&gt;

  &lt;tr&gt;

    &lt;td class="label"&gt;Artist&lt;/td&gt;

    &lt;td colspan="3"&gt;

    &lt;input type="radio" name="Artist" value="1" checked="checked" /&gt;
      Filippo Brunelleschi
    &lt;input type="radio" name="Artist" value="2" /&gt;Leon Battista Alberti
    &lt;input type="radio" name="Artist" value="3" /&gt;Donato Bramante

    &lt;/td&gt;

  &lt;/tr&gt;

  &lt;tr&gt;

    &lt;td class="label"&gt;Art&lt;/td&gt;

    &lt;td colspan="3"&gt;

    &lt;input type="checkbox" name="Art" value="Arch" checked="checked" /&gt;Architecture
    &lt;input type="checkbox" name="Art" value="Paint" /&gt;Painting
    &lt;input type="checkbox" name="Art" value="Sculpt" /&gt;Sculpture

  &lt;/td&gt;

  &lt;/tr&gt;

  &lt;tr&gt;

    &lt;td class="right" colspan="4"&gt;&lt;input type="submit" value="Submit" /&gt;&lt;/td&gt;

  &lt;/tr&gt;</pre><pre class="programlisting">&lt;/tbody&gt;&lt;/table&gt;

  &lt;/form&gt;

 &lt;/body&gt;

 &lt;/html&gt;</pre></li><li class="listitem"><p>Place the following <code class="literal">cgishow.lua</code> file in the web server's <code class="literal">cgi-bin</code> directory, and then make sure it is readable and executable by the web server:</p><pre class="programlisting">#!/usr/local/bin/lua

 local Cgi = require("cgi")
 require("show")

 local Cn = {}

 Cn.HdrStr = [[Content-Type: text/html

 &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

 &lt;html&gt;

 &lt;head&gt;

   &lt;title&gt;CGI Environment&lt;/title&gt;

   &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;

   &lt;link rel="stylesheet" href="/css/general.css" type="text/css" /&gt;

 &lt;/head&gt;

 &lt;body&gt;

 ]]

 Cn.FtrStr = "&lt;/body&gt;\n\n&lt;/html&gt;"

 local Prm = Cgi.Params()
 local List = {}
 ObjectDescribe(List, Prm, "CGI parameters")
 io.write(Cn.HdrStr, '&lt;p class="hdr shade"&gt;CGI Environment&lt;/p&gt;\n')
 for J, Rec in ipairs(List) do
   local Key, Val = string.match(Rec[2], '^%[%"?(.-)%"?%]%s+(.+)$')
   if Key then
     io.write('&lt;div style="margin-left:', Rec[1] * 0.5, 'cm;"&gt;',
     '&lt;b&gt;', Cgi.Escape(Key), '&lt;/b&gt; ', Cgi.Escape(Val), '&lt;/div&gt;\n')
   else</pre><pre class="programlisting">io.write(Rec[2], '&lt;br /&gt;\n')
  end
end
io.write(Cn.FtrStr)</pre><p>Two files, <code class="literal">show.lua</code> (introduced in <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a>) and <code class="literal">cgi.lua</code>, need to be located in Lua's module directory.</p><p>The <code class="literal">general.css</code> style sheet (which was used in a previous example) is used by both <code class="literal">form.html</code> and <code class="literal">cgishow.lua</code>. It must be located in <code class="literal">css</code> subdirectory beneath the document root.</p></li><li class="listitem"><p>With your web browser, request the following resource:</p><pre class="programlisting">http://localhost/form.html</pre><p>The resulting page should look like the one shown in <a class="link" href="ch15.html#figure_15-3" title="Figure 15.3. Figure 15-3">Figure 15-3</a>.</p><div class="figure"><a id="figure_15-3"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1503.png" height="306" alt="Figure 15-3" width="549"></div></div><p class="title"><strong>Figure 15.3. Figure 15-3</strong></p></div></li><li class="listitem"><p>Fill in the various fields and click the Submit button. <a class="link" href="ch15.html#figure_15-4" title="Figure 15.4. Figure 15-4">Figure 15-4</a> shows the kind of page you will get.<a id="IDX-CHP-15-0084" class="indexterm"></a></p><div class="figure"><a id="figure_15-4"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1504.png" width="549" alt="Figure 15-4" height="534"></div></div><p class="title"><strong>Figure 15.4. Figure 15-4</strong></p></div></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p>In <code class="literal">form.html</code>, the following line specifies where the form contents should be sent (in this case, <code class="literal">/cgi-bin/cgishow.lua</code>) and in what manner (using the <code class="literal">GET</code> command in this example):</p><pre class="programlisting">&lt;form action="/cgi-bin/cgishow.lua" method="get"&gt;</pre><p>Because the scheme and server segments are missing from the action URL, the values of the current page (<code class="literal">http://localhost</code>) are used.</p><p>The <code class="literal">GET</code> command instructs the browser to append a question mark, followed by the name/value fields from the form, to the end of the URL. The principal advantage of this method is that the full URL can be saved and later used to request the resulting page without needing to revisit the initial form page. This is valuable in the case of a search engine. From another perspective, however, the <code class="literal">GET</code> method can be undesirable because it places the form's name/value pairs out in the open where they can show up in server logs and bookmarks. Examine the URL of the <code class="literal">cgishow.lua</code> page, and you'll see the unmasked password value. Also, nothing prevents you from pasting a very large amount of text into a form's text field, but limitations with the web browser and web server may prevent your CGI script from actually receiving the complete text.<a id="IDX-CHP-15-0085" class="indexterm"></a><a id="IDX-CHP-15-0086" class="indexterm"></a><a id="IDX-CHP-15-0087" class="indexterm"></a><a id="IDX-CHP-15-0088" class="indexterm"></a></p><p>The <code class="literal">POST</code> method places the form's name/value pairs after the HTTP headers, away from the URL. Try changing the form method in <code class="literal">form.html</code> from <code class="literal">get</code> to <code class="literal">post</code> and examine the differences in the CGI parameters table as shown in the resulting page.</p><p>A remark should be made regarding the way multiline text appears in the <code class="literal">cgishow.lua</code> page. If you type the following into a <code class="literal">&lt;textarea&gt;</code> control:</p><pre class="programlisting">Line 1
 Line 2
 Line 3</pre><p>it will appear as this in the display page:</p><pre class="programlisting">Line 1\013\010Line 2\013\010Line 3</pre><p>The actual data contains carriage returns (\013) and newlines (\010); the backslash notation is used by the show module to present control characters and conforms with Lua's method of embedding binary data in a string.</p></div><p>When you develop a CGI program in Lua, it's helpful to have a glimpse into the data that is transferred to your script. You can temporarily set the <code class="literal">action</code> attribute of a form to <code class="literal">cgishow.lua</code> in order to examine what your CGI script can expect.</p><p>The CGI module presented here supports only urlencoded data uploads. This method is always used with a <code class="literal">GET</code> command and is used by default with a <code class="literal">POST</code> command. Control characters such a carriage returns are always coded into a printable form in this type of encoding.</p><p>If you want to extend the module to accept uploaded files, you'll need to write a routine to handle data that has been encoded with the multipart/form-data method. This type of encoding uses a special form of delimiter that separates the various uploaded field values. These values can contain binary data and, on the Windows platform, special attention must be paid to avoid problems while reading from the standard input stream. Your script, or the revised CGI script, will need to call the following after requiring the <code class="literal">iomode</code> module:</p><pre class="programlisting">io.modeset(io.stdin, "binary")</pre><p>Without this, the content read from the standard input stream will have had carriage returns removed. In addition to corrupting binary uploads, this will cause the content to be smaller than the <code class="literal">CONTENT_LENGTH</code> value indicates. This discrepancy will cause <code class="literal">io.read</code> to block indefinitely as it attempts to read data that isn't there.</p></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="developing_cgi_scripts"></a>Developing CGI Scripts</h2></div></div></div><p>As helpful as <code class="literal">cgishow.lua</code> is in developing CGI applications, the cycle of editing a Lua script and then testing it with a web browser can be tedious. Here are some hints to expedite the development process:<a id="IDX-CHP-15-0089" class="indexterm"></a><a id="IDX-CHP-15-0090" class="indexterm"></a><a id="IDX-CHP-15-0091" class="indexterm"></a><a id="IDX-CHP-15-0092" class="indexterm"></a><a id="IDX-CHP-15-0093" class="indexterm"></a><a id="IDX-CHP-15-0094" class="indexterm"></a><a id="IDX-CHP-15-0095" class="indexterm"></a><a id="IDX-CHP-15-0096" class="indexterm"></a><a id="IDX-CHP-15-0097" class="indexterm"></a><a id="IDX-CHP-15-0098" class="indexterm"></a><a id="IDX-CHP-15-0099" class="indexterm"></a><a id="IDX-CHP-15-0100" class="indexterm"></a><a id="IDX-CHP-15-0101" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Modularize your application by factoring out parts that don't involve the user interface. Place these in modules if appropriate.</p></li><li class="listitem"><p>Test scripts in a command shell. Any error messages will be displayed in the same console window from which you launch the script, making it unnecessary to examine web server logs.<a id="IDX-CHP-15-0102" class="indexterm"></a></p></li><li class="listitem"><p>Make a development replacement for <code class="literal">Cgi.Params</code> that fills the fields you require with test data.</p></li><li class="listitem"><p>Make sure your script generates standard HTML. The Html Validator extension for Firefox is a convenient and valuable tool in this regard.</p></li><li class="listitem"><p>Consider writing a Lua script that automates the testing of your dynamic web pages. Tools such as <code class="literal">wget</code> or <code class="literal">curl</code> can be used from the command shell to submit HTTP requests. Both allow you to specify posted content.</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="security_issues"></a>Security Issues</h2></div></div></div><p>The CGI mechanism allows web users to run designated scripts from your web server. Your primary concern when developing CGI scripts is the validity of submitted form data. Put simply, expect the worst. HTML forms support enumerated selections and JavaScript can validate data at the browser, but don't for a moment think that these features do anything except make it easier for a well-intentioned user to enter data.</p><p>Lua's <code class="literal">tonumber</code> function can be used to validate numeric input. Regular expressions, covered in <a class="link" href="ch05.html" title="Chapter 5. Using Strings">Chapter 5</a>, are very useful in validating and cleaning data in your CGI script. Apply these techniques prior to including any user-provided data into a command to be executed by Lua, a database server, or some other interpreter. For example, if you expect numeric data from a particular field, use a command like this:</p><pre class="programlisting">local Quantity = tonumber(Prm.Post.Quantity)
 if Quantity and Quantity &gt;= Cn.QuantityLow and
  Quantity &lt;= Cn.QuantityHigh then
  -- database code goes here
 end</pre><p>A very common practice is to construct a database or system command dynamically. When you do this, be especially wary of any quotes that are submitted in form data. Devious quoting can allow a malicious user to alter the intent of your command.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="the_kepler_project"></a>The Kepler Project</h1></div></div></div><p>Kepler is a versatile Lua-based web server environment that supports a number of extensions that facilitate web applications. It is named after the German astronomer Johannes Kepler (1571—nd1630), who mathematically described the motion of orbiting bodies. Follow the link to the Kepler project on LuaForge (<code class="literal">luaforge.net/</code>) to read about Kepler and download the package. A mailing list for Kepler is hosted by LuaForge at <code class="literal">lists.luaforge.net/pipermail/kepler-project</code>.</p><p>Kepler's objective is to provide an integrated web development environment that functions with all mainstream web servers as well as Xavante, its own web server. The project comprises many interrelated components. One of them, CGILua, manages user interface issues, while the others provide support for services such as database connectivity, session management, FastCGI on Apache and platform-independent filesystem access. Kepler is compatible with the LuaBinaries distribution, and a Windows installer for it is available. Lua enthusiasts are encouraged to explore its many features.<a id="IDX-CHP-15-0103" class="indexterm"></a><a id="IDX-CHP-15-0104" class="indexterm"></a><a id="IDX-CHP-15-0105" class="indexterm"></a></p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="cgi_the_kepler_way"></a>CGI the Kepler Way</h2></div></div></div><p>The following examples assume that you have Kepler installed and are using the Xavante web server with its default configuration. Examine the Lua configuration files for <code class="literal">cgilua</code> and <code class="literal">xavante</code> to see more details about how Kepler is set up.</p><p>CGILua is the layer between the web server and your CGI scripts. With it, you can register handlers to process scripts based on their extension.</p><p>As a first step in using Kepler, this Try It Out re-implements the time server covered earlier in this chapter.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_creating_a_time_server"></a>Try It Out: Creating a Time Server with Kepler</h3></div></div></div><p>This Try It Out generates a simple page with the current server time. It demonstrates how headers and ordinary content are output in the Kepler web environment.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>In the Kepler installation directory, locate the subdirectory named <code class="literal">web</code>. In this directory, create two new subdirectories named <code class="literal">cgi-bin</code> and <code class="literal">scripts</code>, as follows:</p><pre class="programlisting">cd web
 mkdir cgi-bin
 mkdir scripts</pre></li><li class="listitem"><p>Using your text editor, prepare a CGI script that shows the system date. Save the following file as <code class="literal">date.lua</code> in the <code class="literal">cgi-bin</code> directory created in the previous step:</p><pre class="programlisting">cgilua.contentheader("text", "plain")
 cgilua.put(os.date())</pre></li><li class="listitem"><p>Copy <code class="literal">AjaxRequest.js</code> to the <code class="literal">scripts</code> directory created in step 1.</p></li><li class="listitem"><p>With your web browser, request the following:</p><pre class="programlisting">http://localhost/cgi-bin/date.lua</pre><p>You should see the system date displayed in plain text.</p></li><li class="listitem"><p>Copy <code class="literal">date.html</code> from the AJAX-based server date example to the <code class="literal">web</code> directory and verify that it works as expected with the new <code class="literal">date.lua</code>.</p></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-048"></a>How It Works</h3></div></div></div><p>With Kepler, writing to standard output does not work as it does with the CGI scripts you've seen so far. Instead, Lua scripts use functions in the <code class="literal">cgilua</code> namespace. There are many functions and variables in this namespace that help with tasks such as encoding issues and error handling. This module is included automatically with Kepler CGI scripts.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="lua_pages"></a>Lua Pages</h2></div></div></div><p>A Lua page is a hybrid between a static HTML page and a Lua script. In the examples you've worked with so far, you generated HTML output completely within Lua CGI scripts. With Lua pages, that approach is turned around so that you embed Lua code into an HTML page. The Lua page handler in CGILua processes the embedded Lua and replaces each Lua snippet with the content it generates.<a id="IDX-CHP-15-0106" class="indexterm"></a><a id="IDX-CHP-15-0107" class="indexterm"></a></p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="try_it_out_colon_displaying_the_server_t"></a>Try It Out: Displaying the Server Time Using a Lua Page</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Generate an HTML page with the system time using a Lua page. Save the following file as <code class="literal">date.lp</code> in Xavante's web directory:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Server time&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;The system time is &lt;i&gt;&lt;% cgilua.put(os.date()) %&gt;&lt;/i&gt;.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></li><li class="listitem"><p>With your web browser, request this:</p><pre class="programlisting">http://localhost/date.lp</pre><p>The system date is displayed in an HTML page.</p></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="how_it_works-049"></a>How It Works</h3></div></div></div><p>The Lua page handler in CGILua copies the content of an <code class="literal">.lp</code> file verbatim, except for the text beginning with <code class="literal">&lt;%</code> and ending with <code class="literal">%&gt;</code>. It considers the text between these markers to be Lua code. It executes this code and replaces the entire sequence with whatever content is generated. The Lua code doesn't actually have to generate any content; it can contain variables, even local variables, that are referenced in Lua code elsewhere in the Lua page. For example, near the top of <code class="literal">date.lp</code> you could have this line:</p><pre class="programlisting">&lt;% local function TimePut() cgilua.put(os.date()) end %&gt;</pre><p>And, in the body of the page, you could have this line:</p><pre class="programlisting">&lt;p&gt;The system time is &lt;i&gt;&lt;% TimePut() %&gt;&lt;/i&gt;.&lt;/p&gt;</pre><p>The function declaration doesn't generate any content, so the sequence is replaced with nothing.</p><p>CGILua will detect the <code class="literal">&lt;% and %&gt;</code> markers even within Lua strings. If you want to display them in HTML or a Lua string, represent them as <code class="literal">&lt;%</code> and <code class="literal">%&gt;</code> respectively.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="summary-050"></a>Summary</h1></div></div></div><p>In this chapter, you had a chance to use Lua to dynamically generate web content. In particular, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Some details about how the Common Gateway Interface (CGI) works</p></li><li class="listitem"><p>How to implement CGI scripts in Lua</p></li><li class="listitem"><p>A method for presenting dynamically generated graphics in your web pages</p></li><li class="listitem"><p>How to retrieve and examine user-provided data from HTML forms</p></li><li class="listitem"><p>The rudiments of using Lua pages with Kepler</p></li></ul></div><p>Before you head to the next chapter, where you'll learn how to use Lua in a wider variety of network applications, try out your new skills with the following exercises.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-051"></a>Exercises</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Write a CGI script that displays a message like "Good Afternoon" based on the system time. Follow this with the value of the Name parameter on the URL. For example:</p><pre class="programlisting">http://localhost/cgi-bin/ex1.lua?Name=Kit</pre><p>should result in a message like this:</p><pre class="programlisting">Good afternoon, Kit!</pre></li><li class="listitem"><p>Write an HTML form that accepts a name from the user. When the form is submitted, call the CGI script from the previous exercise appropriately.</p></li><li class="listitem"><p>Modify the calendar script to accept a month and year as follows:</p><pre class="programlisting">http://localhost/cgi-bin/calendar.lua?Month=3&amp;Year=2007</pre><p>If you're feeling ambitious, obtain these values from an HTML form. And if you really want to go the extra mile, set the default values in this form to the current month and year.</p></li></ol></div></div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="ch14.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">14. Managing Information with Databases</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="ch16.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">16. Connecting to a Larger World</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag">
        
        

        
          <p>You have 6 days left in your trial, Michaelschiner. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="ch15.html#" class="icon-up" onclick="window.Appcues.track('JumpTop_HeronBook')"><div class="visuallyhidden">Back to top</div></a>
  <ul class='js-footer-nav'>
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">&#169; 2021 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="https://learning.oreilly.com/jsi18n/web/" charset="utf-8"></script>
    <script src="https://learning.oreilly.com/library/jsi18n/appcache/" charset="utf-8"></script>
  </body>
</html>
