<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch12.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch12.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch12.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch12.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><!--<![endif]--><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="author" content="O'Reilly Media" /><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780470069172"/><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico" /><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"/><meta property="twitter:account_id" content="4503599627559754" /><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic' rel='stylesheet' type='text/css'><title>12. Using Community Libraries - Beginning Lua Programming</title><link rel="stylesheet" href="https://learning.oreilly.com/static/CACHE/css/output.5bdb4fcb2aad.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book"></style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780470069172/chapter/ch12.html",
          "book_id": "9780470069172",
          "chapter_uri": "ch12.html",
          "position": 0,
          "user_uuid": "ce47de5b-ce80-49f0-b5cd-c60d3d33b198",
          "next_chapter_uri": "/library/view/beginning-lua-programming/9780470069172/ch13.html"
        
      },
      title: "Beginning Lua Programming",
      author_list: "Aaron Brown, Kurt Jung",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="https://learning.oreilly.com/static/js/src/modernizr.8e35451ddb64.js"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
        }
      };
  </script><link rel="canonical" href="ch12.html"/><meta name="description" content="Chapter 12. Using Community Libraries In Chapter 7, you learned how to modularize your Lua programs and why it&#39;s a good practice to do so. At the end of ... "><meta property="og:title" content="12. Using Community Libraries" /><meta itemprop="isPartOf" content="/library/view/beginning-lua-programming/9780470069172/" /><meta itemprop="name" content="12. Using Community Libraries" /><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch12.html" /><meta property="og:site_name" content="Safari" /><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780470069172/" /><meta property="og:description" itemprop="description" content="Chapter 12. Using Community Libraries In Chapter 7, you learned how to modularize your Lua programs and why it&#39;s a good practice to do so. At the end of ... "><meta itemprop="inLanguage" content="en" /><meta itemprop="publisher" content="Wrox" /><meta property="og:type" content="book" /><meta property="og:book:isbn" itemprop="isbn" content="9780470069172" /><meta property="og:book:author" itemprop="author" content="Aaron Brown" /><meta property="og:book:author" itemprop="author" content="Kurt Jung" /><meta property="og:book:tag" itemprop="about" content="Core Programming" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; URL=https://learning.oreilly.com/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198';
      dataLayer.push({userIdentifier: 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '29964b7b-68d8-4532-9a9b-32e089689c1f';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer src="https://learning.oreilly.com/static/js/build/vendor.0eac897f11ed.js"></script><script defer src="https://learning.oreilly.com/static/js/build/reader.c745ea9296ac.js"></script></head>


<body class="reading sidenav nav-collapsed  scalefonts">

    
  <noscript> 
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="ch12.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z" /></svg><span>Home</span></a></li><li class="search"><a href="ch12.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"/></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="ch12.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"/></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a
                href="ch12.html#"
                class="l1 nav-icn "
                
              ><?xml version="1.0" encoding="UTF-8"?><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O&#39;Reilly</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/profile/"
                    class="l2 nav-icn"
                    
                  ><span>Profile</span></a></li><li><a
                    href="https://learning.oreilly.com/history/"
                    class="l2 nav-icn"
                    
                  ><span>History</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/"
                    class="l2 nav-icn"
                    
                  ><span>Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/u/ce47de5b-ce80-49f0-b5cd-c60d3d33b198/"
                    class="l2 nav-icn"
                    
                  ><span>Highlights</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/answers/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"/></svg><span>Answers</span></a></li><li class="flyout-parent"><a
                href="ch12.html#"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"/></g></svg><span>Explore</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/topics/"
                    class="l2 nav-icn"
                    
                  ><span>All Topics</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert"
                    class="l2 nav-icn"
                    
                  ><span>Most Popular Titles</span></a></li><li><a
                    href="https://learning.oreilly.com/recommendations/"
                    class="l2 nav-icn"
                    
                  ><span>Recommended</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0"
                    class="l2 nav-icn"
                    
                  ><span>Early Releases</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/discover/"
                    class="l2 nav-icn"
                    
                  ><span>Shared Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/resource-centers/"
                    class="l2 nav-icn"
                    
                  ><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch12.html#"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z" /></svg><span>Live Events</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/attend/"
                    class="l2 nav-icn"
                    
                  ><span>All Events</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/architectural-katas/"
                    class="l2 nav-icn"
                    
                  ><span>Architectural Katas</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/ai/"
                    class="l2 nav-icn"
                    
                  ><span>AI &amp; ML</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/strata/"
                    class="l2 nav-icn"
                    
                  ><span>Data Sci &amp; Eng</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/oscon/"
                    class="l2 nav-icn"
                    
                  ><span>Programming</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/infrastructure-ops/"
                    class="l2 nav-icn"
                    
                  ><span>Infra &amp; Ops</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/software-architecture/"
                    class="l2 nav-icn"
                    
                  ><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch12.html#"
                class="l1 nav-icn "
                
              ><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interactive</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=content-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Scenarios</span></a></li><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Sandboxes</span></a></li><li><a
                    href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook"
                    class="l2 nav-icn"
                    
                  ><span>Jupyter Notebooks</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/certifications/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"/></svg><span>Certifications</span></a></li><li ><a
                href="https://learning.oreilly.com/preferences/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"/></g></svg><span>Settings</span></a></li><li ><a
                href="https://learning.oreilly.com/public/support/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z" /></svg><span>Support</span></a></li><li ><a
                href="https://get.oreilly.com/email-signup.html"
                class="l1 nav-icn "
                target=&quot;_blank&quot;
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z" /></svg><span>Newsletters</span></a></li><li ><a
                href="https://learning.oreilly.com/accounts/logout/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z" /></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="ch12.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Beginning Lua Programming
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="ch12.html#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track('SearchBook_HeronBook')"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780470069172/chapter/ch12.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track('AddPlaylist_HeronBook')"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="ch12.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track('ChangeFont_HeronBook')"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="ch12.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track('Share_HeronBook')"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a
        class="twitter share-button t-twitter"
        target="_blank"
        aria-label="Share this section on Twitter"
        title="Share this section on Twitter"
      
        href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch12.html&text=Beginning%20Lua%20Programming&via=OReillyMedia"
      ><span>Twitter</span></a></li><li><a
        class="facebook share-button t-facebook"
        target="_blank"
        aria-label="Share this section on Facebook"
        title="Share this section on Facebook"
        href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch12.html"
      ><span>Facebook</span></a></li><li><a
        class="googleplus share-button t-googleplus"
        target="_blank"
        aria-label="Share this secton on Google Plus"
        title="Share this secton on Google Plus"
        href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch12.html"
      ><span>Google Plus</span></a></li><li><a
        class="email share-button t-email"
        aria-label="Share this section via email"
        title="Share this section via email"
      
        href="mailto:?subject=Safari: 12.%20Using%20Community%20Libraries&body=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch12.html%0D%0Afrom Beginning%20Lua%20Programming%0D%0A"
      ><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer src="https://learning.oreilly.com/static/js/build/djangoMessagesPage.bfaca9fd8619.js"></script>


        <script src="https://fast.appcues.com/48743.js"></script>
<script>
  var userId = "ce47de5b-ce80-49f0-b5cd-c60d3d33b198";

  var userObject = {
    firstName: "Michael",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2021-05-13",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="ch11.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">11. Exploring Lua&#39;s Libraries</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="ch13.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">13. Interfacing Lua with Other Languages</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="using_community_libraries"></a>Chapter 12. Using Community Libraries</h1></div></div></div><p>In <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a>, you learned how to modularize your Lua programs and why it's a good practice to do so. At the end of that chapter, you saw that you can write modules in languages like C as well as Lua. Throughout the remaining chapters of this book, the term <span class="emphasis"><em>library</em></span> will refer to a collection of one or more routines that have been compiled from a lower-level language like C, C++ or Pascal. Depending on the context, a library may or may not have anything to do with Lua. A library that acts as an intermediary between Lua and another library is often called a <span class="emphasis"><em>binding</em></span>.<a id="IDX-CHP-12-0001" class="indexterm"></a><a id="IDX-CHP-12-0002" class="indexterm"></a><a id="IDX-CHP-12-0003" class="indexterm"></a></p><p>This chapter extends the topic of libraries and how they interact with Lua. In it, you will become familiar with some libraries and bindings that have been made available to the open source community. The bindings cover a small cross-section of the many ways you can enhance Lua, including the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Structuring binary data</p></li><li class="listitem"><p>Constructing dynamic graphics</p></li><li class="listitem"><p>Transferring files with various Internet protocols</p></li><li class="listitem"><p>Interfacing with a relational database</p></li></ul></div><p>Seeing how these libraries work with Lua should allow you to make use of a large number of other libraries. Plan on visiting the LuaForge site to see what's available. <a class="link" href="ch13.html" title="Chapter 13. Interfacing Lua with Other Languages">Chapter 13</a> will extend this topic to applications and libraries that you write yourself.</p><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="library_overview"></a>Library Overview</h1></div></div></div><p>A <span class="emphasis"><em>library</em></span> is a collection of routines and variables that can be linked to an executable program such as a web browser or the Lua interpreter. By providing a well-established interface to common functionality, the use of libraries helps to modularize and standardize an application. For example, the standard C runtime library used by many programs (not just those written in C) implements a wide range of application tasks, including dynamic memory management, file handling, and string operations.<a id="IDX-CHP-12-0004" class="indexterm"></a></p><p>Most libraries can be linked to an application either <span class="emphasis"><em>statically</em></span>, in which portions of a library are directly embedded, or <span class="emphasis"><em>dynamically</em></span>, in which portions of a library are shared concurrently among applications. An application that is statically linked to its libraries is operationally simpler, and consequently easier to deploy, than its dynamically linked counterpart. Such an application is also larger and needs to be relinked if it is to take advantage of updates to any of its libraries.<a id="IDX-CHP-12-0005" class="indexterm"></a><a id="IDX-CHP-12-0006" class="indexterm"></a><a id="IDX-CHP-12-0007" class="indexterm"></a><a id="IDX-CHP-12-0008" class="indexterm"></a><a id="IDX-CHP-12-0009" class="indexterm"></a><a id="IDX-CHP-12-0010" class="indexterm"></a><a id="IDX-CHP-12-0011" class="indexterm"></a></p><p>However, any system like Lua that uses modules loaded at runtime has its own problems with static libraries. The problem has to do with multiple copies of certain library functions linked to the main application and one or more of its loaded modules. In many cases, multiple copies of a statically linked function simply waste space, but with functions that share some internal state, like dynamic memory management functions, it is possible that synchronization problems will occur. For example, if memory is allocated using one copy of the C library and freed using another copy, it is inevitable that unpleasant memory bugs will result.</p><p>The solution is to make sure that only one copy of each library is used throughout an application and its loaded modules. This is best managed though libraries that are linked dynamically.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="dynamically_linked_libraries"></a>Dynamically Linked Libraries</h2></div></div></div><p>Modern operating systems support libraries that can be linked to multiple running processes. On Unix-like systems, these are generally known as <span class="emphasis"><em>shared libraries</em></span>; on Windows, these are usually referred to as <span class="emphasis"><em>dynamic-link libraries</em></span>. A common abbreviation for dynamic-link library is DLL.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="resolving_external_references"></a>Resolving External References</h3></div></div></div><p>The source code in a particular file typically contains references to functions and variables that are defined externally, such as in some other application file or in a library. It is one of the compiler's jobs to create object code that handles these references properly. For example, it sets up calls to external functions using the correct calling convention and arguments. One thing the compiler doesn't know, however, is where in memory these functions will actually reside when the application is executed. When source code is compiled into an object module, enough information to resolve these unknown addresses is provided by the compiler. It is the linker's job to knit the related object modules and any statically linked libraries together into a single application. While doing this, it resolves the addresses that it knows about. However, at this stage, the linker doesn't know the addresses of functions and variables that are part of dynamic-link libraries.</p><p>An application can be configured to have dynamic-link addresses resolved when it is loaded by the operating system. Alternatively, an application can explicitly assign dynamic-link addresses to variables using a system-provided function. The first approach is used by Lua for functions such as <code class="literal">sprintf</code> from the C library. The second approach is used by Lua when loading modules dynamically.</p></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="configuration_options"></a>Configuration Options</h3></div></div></div><p>You can configure the Lua interpreter (or any program that embeds it) in one of two ways so that only one copy of a library is present when running. In the proceeding figures, the application is represented with a bold rectangle and each dynamic-link library with a thin rectangle. <a class="link" href="ch12.html#figure_12-1" title="Figure 12.1. Figure 12-1">Figure 12-1</a> shows a configuration in which Lua's core functionality is part of the application's main file. The application reaches into the module to run its initialization function (for example, <code class="literal">luaopen_pack</code>), represented here with the right-pointing arrow. The left pointing arrow indicates that the module reaches into the application to make use of Lua's C interface.<a id="IDX-CHP-12-0012" class="indexterm"></a><a id="IDX-CHP-12-0013" class="indexterm"></a><a id="IDX-CHP-12-0014" class="indexterm"></a><a id="IDX-CHP-12-0015" class="indexterm"></a></p><div class="figure"><a id="figure_12-1"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1201.png" height="77" alt="Figure 12-1" width="485"></div></div><p class="title"><strong>Figure 12.1. Figure 12-1</strong></p></div><p>By default, Lua is built this way on Unix-like systems. The advantage is that Lua's executable program file (usually named <code class="literal">lua</code>) is never separated from its core functionality. Windows supports this scheme, but it has been reported that some software development kits don't implement it well. <a class="link" href="ch12.html#figure_12-2" title="Figure 12.2. Figure 12-2">Figure 12-2</a> shows the typical configuration for Windows.</p><div class="figure"><a id="figure_12-2"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1202.png" height="63" alt="Figure 12-2" width="549"></div></div><p class="title"><strong>Figure 12.2. Figure 12-2</strong></p></div><p>Here, Lua's core functionality is placed into its own dynamic-link library and shared by both the application and its modules.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="libraries_built_from_source_code"></a>Libraries Built from Source Code</h2></div></div></div><p>If the operating system you use is mainstream, you'll find many libraries that work very well on it. Due to the large number of platforms that Lua runs on, libraries are typically provided in the form of source code. As you saw in <a class="link" href="ch01.html" title="Chapter 1. Getting Situated">Chapter 1</a>, this approach enables you to compile applications and libraries that are tailor-made to your operating system and its particular configuration.<a id="IDX-CHP-12-0016" class="indexterm"></a></p><p>If you want to press ahead with Lua libraries, refer to <a class="link" href="ch01.html" title="Chapter 1. Getting Situated">Chapter 1</a> for instructions on setting up development tools for your operating system. Start by following the instructions in that chapter to build Lua itself. In general, doing this will be easier than compiling libraries and will verify that your tools are properly configured.</p><p>In the overviews in this chapter, it will be assumed that you're familiar with the basic tasks of compiling an application or library. This includes downloading source packages, extracting the contents of tarballs and zip files, invoking a compiler and linker, and copying files from one location to another. <a class="link" href="ch01.html" title="Chapter 1. Getting Situated">Chapter 1</a> covers these operations in enough detail to enable you to build the libraries discussed in this chapter.</p><p>Some of the commands shown in the proceeding sections require that your system environment have certain variables assigned. A helpful diagnostic to make sure these commands are doing what you expect them to is to precede them with <code class="literal">echo</code>. For example, on Unix-like systems, do this:</p><pre class="programlisting">echo cp *.so $LUA_DIR/</pre><p>Or, if you're on Windows, do this:</p><pre class="programlisting">echo xcopy *.dll "%LUA_DIR%\*.*"</pre><p>If the resulting output shows that the environment variable has been properly replaced, you can recall the command, remove the <code class="literal">echo</code> portion, and execute the revised command. Most shells will let you recall a command by pressing the up arrow key.<a id="IDX-CHP-12-0017" class="indexterm"></a><a id="IDX-CHP-12-0018" class="indexterm"></a></p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_libraries_on_unix-like_systems"></a>Building Libraries on Unix-Like Systems</h3></div></div></div><p>In general, the makefiles used to build many libraries that interface with Lua will reflect a bias toward Unix-style systems. These makefile scripts often work with little or no fuss. Most source packages include text files named README and INSTALL that contain essential information. Modifications to makefiles should be minimal, although you may need to change pathnames such as the one that identifies the location of the Lua header files. It is prudent to save a copy of any script that you modify.</p><p>The proceeding instructions assume the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">LUA_DIR</code> environment variable specifies the location where you put Lua modules, whether they are Lua scripts or compiled libraries.</p></li><li class="listitem"><p>The <code class="literal">LUA_PATH</code> environment variable has the value <code class="literal">?.lua;$LUA_DIR/?.lua</code>.</p></li><li class="listitem"><p>The <code class="literal">LUA_CPATH</code> environment variable has the value <code class="literal">?.so;$LUA_DIR/?.so</code>.</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_libraries_on_windows"></a>Building Libraries on Windows</h3></div></div></div><p>The instructions in this chapter assume you are using version 6 of Microsoft's Visual C++ software development kit. Other mainstream C compiler kits usually work well, too, but note the following caveats:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Make sure the SDK you use can link properly with the standard Windows library MSVCRT.DLL that some prebuilt libraries use.</p></li><li class="listitem"><p>You may need to adjust some of the compiler and linker commands shown here.</p></li></ul></div><p>Unfortunately, the small TCC compiler that builds Lua so well is harder to use for compiling libraries because of limitations with this development kit's header file collection.</p><p>The proceeding instructions assume the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Whatever SDK you use, it is assumed that its installation directory contains the standard <code class="literal">bin, lib</code>, and <code class="literal">include</code> subdirectories.</p></li><li class="listitem"><p>The <code class="literal">SDK_DIR</code> environment variable specifies the location of your software development kit.</p></li><li class="listitem"><p>The <code class="literal">LIB</code> environment variable has the value <code class="literal">%SDK_DIR%\lib;%SDK_DIR%\lib\usr</code>.</p></li><li class="listitem"><p>The <code class="literal">INCLUDE</code> environment variable has the value <code class="literal">%SDK_DIR%\include;%SDK_DIR%\include\usr</code>.</p></li><li class="listitem"><p>The import library for the Lua DLL, <code class="literal">lua5.1.lib</code>, has been copied to <code class="literal">%SDK_DIR%\lib\usr</code>.</p></li><li class="listitem"><p>The public header files for Lua—<code class="literal">lua.h, luaconf.h, lualib.h</code>, and <code class="literal">lauxlib.h</code>—have been copied to <code class="literal">%SDK_DIR%\include\usr</code>.</p></li><li class="listitem"><p>The <code class="literal">LUA_DIR</code> environment variable specifies the location where you put Lua modules, whether they are Lua scripts or compiled libraries.</p></li><li class="listitem"><p>The <code class="literal">LUA_PATH</code> environment variable has the value <code class="literal">?.lua;%LUA_DIR%\?.lua</code>.</p></li><li class="listitem"><p>The <code class="literal">LUA_CPATH</code> environment variable has the value <code class="literal">?.dll;%LUA_DIR%\?.dll</code>.<a id="IDX-CHP-12-0019" class="indexterm"></a><a id="IDX-CHP-12-0020" class="indexterm"></a><a id="IDX-CHP-12-0021" class="indexterm"></a><a id="IDX-CHP-12-0022" class="indexterm"></a><a id="IDX-CHP-12-0023" class="indexterm"></a><a id="IDX-CHP-12-0024" class="indexterm"></a><a id="IDX-CHP-12-0025" class="indexterm"></a></p></li><li class="listitem"><p>The <code class="literal">UTIL_DIR</code> environment variable specifies the location where you keep certain applications and dynamic-link libraries, including <code class="literal">lua.exe, lua5.1.dll</code>, and <code class="literal">luac.exe</code>.</p></li><li class="listitem"><p>The search path includes <code class="literal">%SDK_DIR%\bin</code> and <code class="literal">%UTIL_DIR%</code>.</p></li></ul></div><p>The commands you use to build a library in Windows include one for linking various object files. The link command contains a <code class="literal">/base</code> option followed by a hexadecimal number. This number specifies the location in the virtual address space of a process where the operating system will attempt to load the library when it is dynamically linked. By providing a unique address to each dynamic-link library that will be loaded together, Windows avoids address corrections when the library is loaded and paging inefficiencies when the program is executed. Several <span class="emphasis"><em>rebasing</em></span> utilities are available that will optimally assign base addresses to dynamic-link libraries after they have been compiled. The approach shown in this book is to explicitly assign them when a library is built, selecting unique addresses at one megabyte boundaries. Avoid using base addresses that interfere with libraries that are larger than one megabyte.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="limits_to_portability"></a>Limits to Portability</h2></div></div></div><p>Libraries are generally written to be as portable as possible, but sometimes there are system-imposed limits to this. For example, some operating systems do not support signals or file system links, so they consequently can't support a library dealing with these features. A case in point is the lack of support for POSIX libraries on older versions of Windows.</p><p>Additionally, some libraries, especially small ones or ones with limited distribution, may require some modifications to build properly on platforms other than the one on which they were developed. You'll learn some of the things you may need to watch for in the following parts of this chapter.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="how_lua_interacts_with_libraries"></a>How Lua Interacts with Libraries</h1></div></div></div><p>You're familiar with using functions like <code class="literal">print, string.gsub</code> and <code class="literal">io.open</code>. These and Lua's other functions are implemented in C and made available to Lua scripts by means of a program interface. To understand how your Lua script can call these functions, first you need to know how the functions make it into your script's environment (the registration process), and second what happens when a call to a C function is actually made.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="the_variable_registration_process"></a>The Variable Registration Process</h2></div></div></div><p>When the standard Lua interpreter starts, it calls a function named <code class="literal">lua_open</code> that allocates and initializes a state structure (sometimes called an <span class="emphasis"><em>instance</em></span> or <span class="emphasis"><em>universe</em></span>). A pointer to this structure is passed as the first argument to all other functions in the Lua C interface (usually called the <span class="emphasis"><em>application program interface</em></span>, or <span class="emphasis"><em>API</em></span>). Everything that pertains to your Lua script has its basis in this structure. It serves as a liaison that allows a C program to manipulate a script's environment, to be called by a script, and to call into a script. In fact, one of the first things an application does after receiving a pointer to this structure is to modify the initial (and, in practice, often the only) environment by placing functions and other variables (such as <code class="literal">print, string.rep</code> and <code class="literal">_VERSION</code>) into it. This is done by calling functions with names like <code class="literal">luaopen_base</code> and <code class="literal">luaopen_string</code>. These in turn call lower-level API functions that manipulate tables and the Lua call stack.<a id="IDX-CHP-12-0026" class="indexterm"></a></p><p>In the context of libraries, there are a couple of things to note here:<a id="IDX-CHP-12-0027" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>It doesn't matter if functions like <code class="literal">luaopen_string</code> are embedded statically into the application or are located in an external dynamic-link library, as long as only one copy is accessible during execution and they are properly exported so that Lua bindings can call them.</p></li><li class="listitem"><p>There is no difference between the way the base and standard libraries are loaded and the way external modules written in C or some other low-level language are loaded. For example, you could compile a Lua interpreter that doesn't load the math library by default. The math library could be built (with no changes to the source code) as a dynamic-link library. In this way, Lua scripts could use the math library by simply including the following line:</p><pre class="programlisting">require("math")</pre><p>Conversely, if you have a module that you want to be loaded by default in your Lua interpreter, you could load it the same way the standard libraries are usually loaded. Keep in mind that these kinds of alterations to Lua's default configuration can diminish the portability of Lua scripts. Unless you are building Lua for a special application where the benefits of these changes outweigh the portability costs, it's probably best to stay with the standard configuration.</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="calling_a_c_function_from_lua"></a>Calling a C Function from Lua</h2></div></div></div><p>When you call a function from a Lua script, you don't need to know whether it is implemented in Lua or in a lower-level language behind the Lua API. In fact, the bytecode that Lua generates for a function call doesn't distinguish between these two kinds of function calls. For example, if you redefine <code class="literal">string.format</code> in Lua, calls to the new function appear identical to calls to the original function, right down to the generated bytecode.</p><p>The following Try It Out illustrates how you can use Lua to call a function written in a language like C.</p><div class="sidebar"><a id="try_it_out_colon_building_a_diminutive_l"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Building a Diminutive Lua</strong></p></div></div></div><p>In this exercise, you'll build an interpreter that includes Lua's core functionality, but excludes its standard libraries. The small size of the source code makes it a great introduction to embedding and extending Lua in your own applications. (These topics are discussed in more detail in <a class="link" href="ch13.html" title="Chapter 13. Interfacing Lua with Other Languages">Chapter 13</a>.)</p><p>The Lua distribution includes a file called <code class="literal">min.c</code> in the <code class="literal">etc</code> directory. This file provides an excellent introduction to the way you can embed Lua into your own application and how you can create functions in C that can be called from Lua. Do one of the following, depending on the type of system you're using.</p><div class="blockquote"><blockquote class="blockquote"><p>The makefile entry for this program is clearly oriented toward Unix-like platforms. However, instructions are given here for both Unix-like system users and Windows users.</p></blockquote></div><p>If you've got a Unix-like system and have already built Lua successfully, follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Navigate to the distribution's <code class="literal">etc</code> directory and execute the following command:</p><pre class="programlisting"><strong class="userinput"><code>make min</code></strong></pre><p>This will result in the following three lines:</p><pre class="programlisting">gcc -O2 -Wall -I../src min.c -L../src -llua -lm
echo 'print"Hello there!"' | ./a.out
Hello there!</pre></li><li class="listitem"><p>Verify that this handles computations and errors correctly by typing the following commands shown in bold:</p><div class="blockquote"><blockquote class="blockquote"><p>The <code class="literal">#</code> symbol is the shell prompt; it may appear differently on your system.</p></blockquote></div><pre class="programlisting"># <strong class="userinput"><code>echo 'print(1+2*3^4)' | ./a.out</code></strong>
163
# <strong class="userinput"><code>echo 'print(1++2)' | ./a.out</code></strong>
stdin:1: unexpected symbol near '+'</pre></li></ol></div><p>If you are using version 6 of the Visual C++ toolkit on the Windows platform, follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Build <code class="literal">min.exe</code> by navigating to the <code class="literal">etc</code> subdirectory of the Lua source distribution and executing the following commands:</p><pre class="programlisting">cl /MD /O2 /W3 /c /DLUA_BUILD_AS_DLL min.c
link /OUT:min.exe min.obj lua5.1.lib</pre></li><li class="listitem"><p>Test the new scaled-down Lua interpreter by typing in the following commands shown in bold:</p><div class="blockquote"><blockquote class="blockquote"><p>The <code class="literal">&gt;</code> symbol is the shell prompt; it may appear differently on your system.</p></blockquote></div><pre class="programlisting">&gt; <strong class="userinput"><code>echo print('Hello there!') | min.exe</code></strong>
Hello there!
&gt; <strong class="userinput"><code>echo print(1+2*3/4) | min.exe</code></strong>
2.5
&gt; <strong class="userinput"><code>echo print(1++2) | min.exe</code></strong>
stdin:1: unexpected symbol near '+'</pre></li></ol></div><p>If you encounter any problems building this program, be sure that the assumptions listed previously for application development on your system have been met.</p><p><span class="strong"><strong>How It Works</strong></span></p><p>Examine the source code of <code class="literal">min.c</code>. At the top, the C library <code class="literal">stdio.h</code> header file is included to provide a prototype for <code class="literal">printf</code>. After this, the main Lua <code class="literal">lua.h</code> header file is included. It contains all of the information (including prototypes and definitions) that the C compiler needs to interface with Lua's core C API. Header information for Lua's auxiliary helper library is pulled in by including <code class="literal">lauxlib.h</code>. Double quotes are used to tell the preprocessor to look for the Lua header files first in the C file's directory and, failing this, in the standard header locations. The angle brackets indicate that the specified header file will be found in a standard location.</p><p>Skip to the function <code class="literal">main</code> at the bottom of <code class="literal">min.c</code>. The interaction with the Lua core begins with the call to <code class="literal">lua_open</code>. This function returns a pointer to an initialized record of type <code class="literal">lua_State</code>. This state pointer is used in all subsequent calls to the Lua core. The call to <code class="literal">lua_open</code> is balanced with a call to <code class="literal">lua_close</code> at the end of the program.</p><p>The <code class="literal">print</code> function defined in the middle of <code class="literal">min.c</code> is made available to Lua scripts with a call to <code class="literal">lua_register</code>:</p><pre class="programlisting">lua_register(L,"print",print);</pre><p>The arguments for this function, in the specified order, are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The Lua state pointer originally returned by <code class="literal">lua_open</code></p></li><li class="listitem"><p>The name of the global variable that will be assigned the function</p></li><li class="listitem"><p>The C function itself</p></li></ul></div><p>In this case, the C function has the same name as its Lua counterpart, but this is not required.</p><p>The line below this contains the following statement:</p><pre class="programlisting">luaL_dofile(L,NULL)</pre><p>This auxiliary function loads the specified file and runs it in a protected environment. Here, the <code class="literal">NULL</code> argument specifies the standard input, which is why in this exercise, you piped the Lua scripts to the minimal interpreter.</p><p>Turn your attention to the <code class="literal">print</code> function in the middle of <code class="literal">min.c</code>. Its prototype is as follows:</p><pre class="programlisting">static int print(lua_State *L)</pre><p>Every function that you write in C to be called from Lua will look like this. It will receive a single argument—the Lua state pointer—and return an integer.</p><p>Given such a minimal argument list, how can a function know what was passed to it from Lua? How can it return values to Lua? The answer in both cases has to do with the Lua state pointer. With it, you can manipulate the Lua stack frame to find the arguments with which the function was called and to place values that will be returned to the caller.</p><p>Lua uses its own call stack to transfer values to and from functions, and to hold values for safekeeping during nested function calls. When a call to a C function is made from Lua, each argument in turn, from left to right, is placed on the stack and the stack count is incremented. This combination of stack operations is known as a <span class="emphasis"><em>push</em></span>. A <span class="emphasis"><em>pop</em></span> undoes the effect of a push—the topmost stack element is copied and the stack count is decremented.<a id="IDX-CHP-12-0028" class="indexterm"></a><a id="IDX-CHP-12-0029" class="indexterm"></a></p><p>The purpose of <code class="literal">print</code> in this minimal interpreter is much like it is in the full-featured Lua interpreter: to output a tab-delimited sequence of its arguments in textual form. It does this by first finding out the number of arguments passed to it, like this:</p><pre class="programlisting">int n=lua_gettop(L);</pre><p>This stack is one-based, so each argument can be visited in turn with an indexed loop ranging from 1 to the number <code class="literal">n</code>. Functions with names like <code class="literal">lua_isstring</code> and <code class="literal">lua_isboolean</code> are used to classify the arguments.</p><p>Throughout the loop, each argument is printed in turn. After the first, each argument is preceded with a tab character. After the loop, a newline is emitted.<a id="IDX-CHP-12-0030" class="indexterm"></a><a id="IDX-CHP-12-0031" class="indexterm"></a><a id="IDX-CHP-12-0032" class="indexterm"></a><a id="IDX-CHP-12-0033" class="indexterm"></a><a id="IDX-CHP-12-0034" class="indexterm"></a><a id="IDX-CHP-12-0035" class="indexterm"></a><a id="IDX-CHP-12-0036" class="indexterm"></a></p><p>Finally, <code class="literal">print</code> returns the value 0. This is the quantity of values that is returned to the caller of the <code class="literal">print</code> function. In addition to querying the stack for values, you can remove, add, and move elements. Values are returned by placing them at the top of the Lua stack and returning their quantity.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="the_pack_binary_structuring_library"></a>The pack Binary Structuring Library</h1></div></div></div><p>Lua handles text as deftly as it handles numbers. Because strings can contain any byte value (which makes Lua what is known as <span class="emphasis"><em>8-bit clean</em></span>), they can be safely used to hold binary data. You can use the <code class="literal">string.byte</code> and <code class="literal">string.char</code> functions to work with string elements at the byte level. However, many of the binary blocks that you work with comprise elements that are larger than a byte. Moreover, the way the bytes within these elements are ordered may not correspond to the way your computing hardware orders them. This is the so-called <span class="emphasis"><em>endian</em></span> issue that has its roots in machine architecture. Sometimes binary blocks contain embedded strings. The length of a string might be fixed or variable, and if variable, the length might be placed as a byte or an integer value preceding the string, or the string might be terminated with a null byte. Some binary structures are relatively straightforward, while others may have optional or repeating components and subcomponents.<a id="IDX-CHP-12-0037" class="indexterm"></a></p><p>One of Lua's three authors, Luiz Henrique de Figueiredo, has written and released a number of libraries that extend Lua in many useful ways. One of these libraries, <code class="literal">pack</code>, enables you to read and write binary structures from within Lua scripts. To obtain the source code for this library, visit Luiz Henrique's homepage (<code class="literal"><code class="systemitem">www.tecgraf.puc-rio.br/~lhf/</code></code>) and follow the link to his libraries. An informative page explaining how to build, install, and use his libraries is available. Download the package <code class="literal">lpack.tar.gz</code> for Lua 5 and place it in the location where you want to build it.</p><p>Many of the libraries in Luiz Henrique's collections are bindings that connect Lua to other libraries. For example, the PDF binding allows Lua to interface with PDFLib, a well-known library that is used to generate files in portable document format (PDF). The <code class="literal">pack</code> library, however, is a standalone module. All of its functionality is expressed in the <code class="literal">lpack.c</code> file.<a id="IDX-CHP-12-0038" class="indexterm"></a></p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_the_pack_library_on_unix-type_s"></a>Building the pack Library on Unix-type Systems</h2></div></div></div><p>Follow these steps to build the pack module for Unix-type systems:</p><div class="blockquote"><blockquote class="blockquote"><p>Skip ahead if you're working on the Windows platform.</p></blockquote></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the tarball as follows:</p><pre class="programlisting">tar xzvf lpack.tar.gz</pre></li><li class="listitem"><p>Drop into the pack directory with the following command:</p><pre class="programlisting">cd pack</pre></li><li class="listitem"><p>Build the shared library with the following command:<a id="IDX-CHP-12-0039" class="indexterm"></a><a id="IDX-CHP-12-0040" class="indexterm"></a><a id="IDX-CHP-12-0041" class="indexterm"></a></p><div class="blockquote"><blockquote class="blockquote"><p>This command assumes that you have built Lua and installed it using the makefile provided with Lua.</p></blockquote></div><pre class="programlisting">cc -ansi -pedantic -Wall -O2 -o pack.so -shared lpack.c</pre><p>The compiler toolkit will locate the necessary header files and libraries in a standard location.</p></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_and_installing_the_pack_library"></a>Building and Installing the pack Library on Windows</h2></div></div></div><p>In this section, you'll compile the pack module for the Windows platform. Some of the steps are on the long side. As elsewhere in this book, if you see </p><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building and Installing the pack Library on Windows" width="12" height="12"></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the tarball as follows:</p><pre class="programlisting">7z x lpack.tar.gz
7z x lpack.tar
del lpack.tar</pre></li><li class="listitem"><p>Drop into the pack directory with the following command:</p><pre class="programlisting">cd pack</pre></li><li class="listitem"><p>Build the shared library with the following commands:</p><pre class="programlisting">cl /c /W1 /Zl /Zd /Yd /MD /DWIN32 lpack.c
link /dll /out:pack.dll /base:0x67400000 /machine:ix86 <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building and Installing the pack Library on Windows" width="12" height="12"></div>
/export:luaopen_pack lpack.obj lua5.1.lib msvcrt.lib</pre></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="testing_the_pack_library"></a>Testing the pack Library</h2></div></div></div><p>After building a library, it's good policy to test it before installing it. You'll do that now, but there is one small wrinkle to explain. The <code class="literal">pack</code> library has been written so that it can be loaded directly without an intermediate <code class="literal">.lua</code> file. The commands used to build the <code class="literal">pack</code> library make use of this fact by making the base name of the shared library <code class="literal">pack</code> rather than <code class="literal">lpack</code>. Because of this, the loading script <code class="literal">pack.lua</code> that comes with the library is rendered unnecessary. To prevent it from being inadvertently loaded, rename this file from <code class="literal">pack.lua</code> to <code class="literal">pack.lua.0</code> as follows:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>On Unix-type systems, execute the following:</p><pre class="programlisting">mv pack.lua pack.lua.0</pre><p>Or on Windows, execute following:</p><pre class="programlisting">ren pack.lua pack.lua.0</pre></li><li class="listitem"><p>Override the value of <code class="literal">package.cpath</code> in the test command so that shared libraries are sought only in the current directory. On Unix-type systems, test the library as follows:<a id="IDX-CHP-12-0042" class="indexterm"></a><a id="IDX-CHP-12-0043" class="indexterm"></a><a id="IDX-CHP-12-0044" class="indexterm"></a><a id="IDX-CHP-12-0045" class="indexterm"></a></p><pre class="programlisting">lua -e 'package.cpath="./?.so" require "pack" <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Testing the pack Library" width="12" height="12"></div>
print(string.pack("b3", 76, 117, 97))'</pre><p>On Windows, run this command:</p><pre class="programlisting">lua -e "package.cpath='./?.dll' require 'pack' <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Testing the pack Library" width="12" height="12"></div>
print(string.pack('b3', 76, 117, 97))"</pre><p>If the library has been successfully built, the output should be as follows:</p><pre class="programlisting">Lua</pre></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="installing_the_pack_library"></a>Installing the pack Library</h2></div></div></div><p>To make the <code class="literal">pack</code> library accessible to Lua scripts on your system, copy <code class="literal">pack.so</code> or <code class="literal">pack.dll</code> to the Lua library directory as specified by the environment variable <code class="literal">LUA_DIR</code>. On Unix-like systems, execute the following:</p><pre class="programlisting">cp pack.so $LUA_DIR/</pre><p>On Windows, use this:</p><pre class="programlisting">xcopy pack.dll "%LUA_DIR%\*.*"</pre></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="using_the_pack_library"></a>Using the pack Library</h2></div></div></div><p>The <code class="literal">pack</code> library is made available to your Lua script with the following line:</p><pre class="programlisting">require("pack")</pre><p>This introduces the new functions <code class="literal">string.pack</code> and <code class="literal">string.unpack</code>.</p><div class="blockquote"><blockquote class="blockquote"><p>If the symbol <code class="literal">USE_GLOBALS</code> was defined when you compiled <code class="literal">lpack.c</code>, the global functions <code class="literal">bpack</code> and <code class="literal">bunpack</code> will be introduced instead. In this case, make the appropriate replacements to the examples that follow.</p></blockquote></div><p>The <code class="literal">string.pack</code> function lets you construct a structured record from one or more elements. Its usage is as follows:</p><pre class="programlisting">string.pack(<em class="replaceable"><code>format string, one or more arguments</code></em>)</pre><p>This returns a binary record, in the form of a Lua string, based on the format specifier and the string and number arguments that you pass it.</p><p>The <code class="literal">string.pack</code> function examines each character in the format specifier and takes the appropriate action. These actions fall into three categories:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If the character is &gt;, &lt;, or <code class="literal">=</code>, the numeric conversions are set to big-endian, little-endian, or native-endian mode respectively. Examples of big-endian machines, in which the most significant byte is lower in memory, are Motorola 68K, Power PC, and Sparc. Network protocols typically require numbers to be big-endian. An example of a little-endian machine is the ubiquitous Intel x86, in which the least significant byte is lower in memory. The = character sets native-endian mode. This character is used to reset the numeric conversion mode back to its default in which a Lua number is converted to a form that is compatible with the underlying hardware. The conversion mode set by any of these three characters persists until another one of them occurs in the format specifier. The default is native-endian mode.<a id="IDX-CHP-12-0046" class="indexterm"></a><a id="IDX-CHP-12-0047" class="indexterm"></a><a id="IDX-CHP-12-0048" class="indexterm"></a></p></li><li class="listitem"><p>If the character is A, a, b, c, d, f, h, H, i, I, l, L, n, p, P, or z, the next argument in the argument list is appended to the result string in a form that is specified by the letter. See the following table for the nature of the conversion for each of these characters. In general, the position of a letter in the format specifier corresponds to the position of the corresponding argument after the format specifier.</p></li><li class="listitem"><p>If the character is a digit from 0 through 9, it and any digits after it are converted to an integer and applied as a repetition count for the preceding conversion code. For example, the <code class="literal">H2b4</code> sequence" in a format specifier is equivalent to <code class="literal">HHbbbb</code>. A format specifier like this would be followed by six Lua numbers. The first two would be formatted as unsigned shorts and the remaining four would be formatted as bytes.</p></li></ul></div><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"><col class="col2"></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Format Code</p></th><th style="text-align: left" valign="bottom"><p>Data Element Type</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">z</code></p></td><td style="text-align: left" valign="top"><p>Null-(zero-)-terminated string</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">p</code></p></td><td style="text-align: left" valign="top"><p>Byte-prefixed string</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">P</code></p></td><td style="text-align: left" valign="top"><p>Word-prefixed string</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">a</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">size_t</code>-prefixed string</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">A</code></p></td><td style="text-align: left" valign="top"><p>String</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">f</code></p></td><td style="text-align: left" valign="top"><p>Float</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">d</code></p></td><td style="text-align: left" valign="top"><p>Double</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">n</code></p></td><td style="text-align: left" valign="top"><p>Lua number</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">c</code></p></td><td style="text-align: left" valign="top"><p>Character</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">b</code></p></td><td style="text-align: left" valign="top"><p>Byte (unsigned char)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">h</code></p></td><td style="text-align: left" valign="top"><p>Short</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">H</code></p></td><td style="text-align: left" valign="top"><p>Unsigned short</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">i</code></p></td><td style="text-align: left" valign="top"><p>Integer</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">I</code></p></td><td style="text-align: left" valign="top"><p>Unsigned integer</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">L</code></p></td><td style="text-align: left" valign="top"><p>Long</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">L</code></p></td><td style="text-align: left" valign="top"><p>Unsigned long</p></td></tr></tbody></table></div><p>The string that <code class="literal">string.pack</code> returns is of little use within Lua. Generally, it is written to a file where it is to be used by some other application that understands its format. When you do write it to a file, make sure that the file is opened for writing in binary mode. This is neither required nor harmful on Unix-like systems, but it is imperative in Windows.</p><p>The function lets you deconstruct a structured binary record into one or more Lua strings and numbers. Its usage is as follows:</p><pre class="programlisting">string.unpack(<em class="replaceable"><code>structure, format string, optional start position</code></em>)</pre><p>This returns the position just beyond the last byte read followed by the strings and numbers extracted from the specified structure.</p><p>Here is how the <code class="literal">string.unpack</code> function works. You first pass the binary structure (a Lua string from which primary elements are to be extracted) to it. Such a string will typically come from a file, and the usual caveats about reading the file in binary mode apply. Next, you include a format specifier string that, except for one small difference, is identical to the one used in <code class="literal">string.pack</code>. The difference is the meaning of an integer that follows the <code class="literal">A</code> code. Such a value indicates the length of the string to unpack rather than a repetition count. After this format specifier, you can then include a 1-based starting position. This is optional and is used to specify a position in the structure at which to start unpacking.</p><p>The <code class="literal">string.unpack</code> function returns a position followed by Lua strings and numbers that correspond positionally to codes in the format specifier. The first return value indicates the position just beyond the last byte read—the position at which the next call to <code class="literal">string.unpack</code> should start. This value turns out to be very useful in unpacking complex structures that contain repeating substructures. The remaining return values are structure elements that have been converted to Lua values.</p><div class="sidebar"><a id="try_it_out_colon_unpacking_the_lua_icon"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Unpacking the Lua Icon Header</strong></p></div></div></div><p>The Lua source distribution comes with an icon file that contains small images of the Lua logo. It is located in the <code class="literal">etc</code> subdirectory and is named <code class="literal">lua.ico</code>. The icon file format contains little-endian numbers of various sizes and a repeating substructure, so it is a useful file for exercising the capabilities of <code class="literal">string.unpack</code>.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following code to a file named <code class="literal">icotest.lua</code>. This script uses the <code class="literal">show</code> module you created in <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a>. If you use the version of <code class="literal">show</code> that was revised in an exercise at the end of that chapter to include a namespace, you need to change <code class="literal">ObjectShow</code> to <code class="literal">Object.Show</code>.</p><pre class="programlisting">require "pack"
require "show"

local function LclFileGet(FileStr)
  local Str
  local Hnd, ErrStr = io.open(FileStr, "rb")
  if Hnd then
    Str = Hnd:read("*all")
    Hnd:close()
  end
  return Str, ErrStr
end</pre><pre class="programlisting">local FileStr = arg[1] or "../lua-5.1.1/etc/lua.ico"
local IcoStr, ErrStr = LclFileGet(FileStr)
if IcoStr then
  local Ico = {}
  local Pos
  Pos, Ico.Reserved, Ico.Type, Ico.Count = string.unpack(IcoStr, "&lt;H3")
  Ico.List = {}
  for J = 1, Ico.Count do
    local Item = {}
    Pos, Item.Width, Item.Height, Item.ColorCount, Item.Reserved,
      Item.Planes, Item.BitCount, Item.Size, Item.Offset =
      string.unpack(IcoStr, "&lt;b4H2L2", Pos)
    table.insert(Ico.List, Item)
  end
  Pos, Ico.HdrSize, Ico.Width, Ico.Height, Ico.Planes, Ico.Bitcount,
    Ico.Compression, Ico.ImageSize, Ico.XPixelsPerM, Ico.YPixelsPerM,
    Ico.ColorsUsed, Ico.ColorsImportant = string.unpack(IcoStr, "&lt;L3H2L6", Pos)
  ObjectShow(Ico, "Ico")
else
  io.write(ErrStr, "\n")
end</pre></li><li class="listitem"><p>As you can see by the <code class="literal">require("show")</code> line near the top, the script makes use of the <code class="literal">show</code> module introduced in <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a>. Invoke the script with the pathname of the icon file as an argument. For example, on a Unix-like system, execute the following command, adjusting the icon path if necessary:</p><pre class="programlisting">lua icotest.lua /usr/local/src/lua-5.1.1/etc/lua.ico</pre><p>This results in a display of the icon's header that looks like this:</p><pre class="programlisting">["Ico"] table: 0x8070ee0 (n = 0)
  ["Bitcount"] 4
  ["ColorsImportant"] 0
  ["ColorsUsed"] 0
  ["Compression"] 0
  ["Count"] 2
  ["HdrSize"] 40
  ["Height"] 64
  ["ImageSize"] 512
  ["List"] table: 0x8070d88 (n = 2)
    [1] table: 0x8070f48 (n = 0)
      ["BitCount"] 0
      ["ColorCount"] 16
      ["Height"] 32
      ["Offset"] 38
      ["Planes"] 0
      ["Reserved"] 0
      ["Size"] 744
      ["Width"] 32
    [2] table: 0x8070f70 (n = 0)
      ["BitCount"] 0
      ["ColorCount"] 16
      ["Height"] 16
      ["Offset"] 782
    ["Planes"] 0
      ["Reserved"] 0
      ["Size"] 296
      ["Width"] 16
  ["Planes"] 1
  ["Reserved"] 0
  ["Type"] 1
  ["Width"] 32
  ["XPixelsPerM"] 0
  ["YPixelsPerM"] 0</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span><a id="IDX-CHP-12-0049" class="indexterm"></a><a id="IDX-CHP-12-0050" class="indexterm"></a><a id="IDX-CHP-12-0051" class="indexterm"></a><a id="IDX-CHP-12-0052" class="indexterm"></a><a id="IDX-CHP-12-0053" class="indexterm"></a></p><p>You can retrieve the details of the icon format from various sites on the Web. From a layout that identifies record elements and their data types and purpose, you have enough information to construct the format specifier and to give meaningful names to the result values. For example, the following line indicates that the first three elements are little-endian unsigned shorts:</p><pre class="programlisting">Pos, Ico.Reserved, Ico.Type, Ico.Count = string.unpack(IcoStr, "&lt;H3")</pre><p>The first field is reserved, the second is an icon type code, and the third is the number of icons contained in the file. Notice that the results are assigned directly to associative table fields. This is generally a convenient way to keep the structure elements organized and accessible. Because there is no inherent order to associative table fields, however, any display of the contents will in general not match the order of the elements in the original data structure. Subsequent calls to <code class="literal">string.unpack</code> use the most recently returned position as the third argument. Doing so eliminates the need to manually count bytes in the structure.</p></div><p>If you use Lua to work with binary data of any kind, the <code class="literal">pack</code> library definitely belongs in your toolkit. Like Lua's regular expression functions that break apart plain text data, the use of <code class="literal">string.pack</code> and <code class="literal">string.unpack</code> becomes quite natural with a little familiarity.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="the_curl_file_transfer_library"></a>The cURL File Transfer Library</h1></div></div></div><p>The command line program cURL (a contraction of Client for URLs) is an extremely popular and portable tool for moving files around on the Internet using protocols such as http, https, ftp, and ftps. It hails from Sweden and is the work of hundreds of contributors, with Daniel Stenberg at the helm. One very nice feature of this program is that its core functionality is factored into a library that can be used by other applications as well. Additionally, the library has an interface that makes it conducive for use by scripting languages like Lua. Visit <code class="literal">curl.haxx.se</code> for more information on cURL.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_libcurl"></a>Building libcurl</h2></div></div></div><p>To use cURL from a Lua script, include the following line:</p><pre class="programlisting">require("luacurl")</pre><p>The <code class="literal">luacurl</code> module binds Lua to the main cURL library. This common arrangement involves a main library ( <code class="literal">libcurl.dll</code> or <code class="literal">libcurl.so</code>) that provides functionality and a binding (which in this case is <code class="literal">luacurl.dll</code> or <code class="literal">luacurl.so</code>) that connects <code class="literal">lua</code> to the main library.<a id="IDX-CHP-12-0054" class="indexterm"></a><a id="IDX-CHP-12-0055" class="indexterm"></a><a id="IDX-CHP-12-0056" class="indexterm"></a><a id="IDX-CHP-12-0057" class="indexterm"></a></p><p>The cURL application and library are very popular, and it is quite possible that they are already installed on your system. You can check this by issuing the following command:<a id="IDX-CHP-12-0058" class="indexterm"></a><a id="IDX-CHP-12-0059" class="indexterm"></a><a id="IDX-CHP-12-0060" class="indexterm"></a></p><pre class="programlisting">which curl</pre><p>If <code class="literal">curl</code> is not found, you may be able to download it in the form of a package tailored to your particular platform. Doing so saves you the trouble of building cURL.</p><p>If you're going to build cURL, the first step is to make sure you've got a properly installed and up-to-date cURL library. One decision you'll need to make is whether you want support for file transfer protocols based on the secure sockets layer (SSL). Including SSL allows you to use the https and ftps protocols at the expense of more library dependencies and certificate management. The introduction in this chapter will not support SSL.<a id="IDX-CHP-12-0061" class="indexterm"></a></p><p>The <code class="literal">libcurl</code> library can use the OpenSSL, zlib, and OpenLDAP libraries if they are available. The cURL website can guide you to the websites where you can download these libraries if they are not already installed on your system.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_libcurl_on_unix-like_systems"></a>Building libcurl on Unix-Like Systems</h3></div></div></div><p>As is the case with many libraries, <code class="literal">libcurl</code> builds like a dream on Linux and friends. Obtain the tarball (<code class="literal">curl-7.15.4.tar.gz</code> is used here, but you'll want the most recent version if it has been updated) from <code class="literal">curl.haxx.se/download.html</code> and move it to the location where you want to build it. Then follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Unpack it with the following command:</p><pre class="programlisting">tar xzvf curl-7.15.4.tar.gz</pre><p>Or if you are unpacking the bzipped package (with the extension <code class="literal">tar.bz2</code> instead of <code class="literal">tar.gz</code>), unpack it as follows:</p><pre class="programlisting">tar xjvf curl-7.15.4.tar.gz</pre></li><li class="listitem"><p>Drop down into the newly created directory:</p><pre class="programlisting">cd curl-7.15.4</pre></li><li class="listitem"><p>Build the makefiles with the following command:</p><pre class="programlisting">./configure</pre></li><li class="listitem"><p>Make the entire package with the following command"</p><pre class="programlisting">make</pre></li><li class="listitem"><p>As root, install the package as follows:</p><pre class="programlisting">make install</pre></li><li class="listitem"><p>Test the build with the following command:</p><pre class="programlisting">curl -V</pre></li></ol></div><p>This should result in a short version and features report.</p></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_libcurl_on_windows"></a>Building libcurl on Windows</h3></div></div></div><p>Follow these steps to compile the cURL library:<a id="IDX-CHP-12-0062" class="indexterm"></a><a id="IDX-CHP-12-0063" class="indexterm"></a></p><div class="blockquote"><blockquote class="blockquote"><p>An alternative that saves you the trouble of building the library is to download a precompiled package.</p></blockquote></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>After downloading the most recent version of the cURL source package from <code class="literal">curl.haxx.se/download.html</code>, move it to the location where you will build it. If you are using the <span class="emphasis"><em>7</em></span>-zip utility, extract it as follows, adjusting the tarball name if you have a more recent version:</p><pre class="programlisting">7z x curl-7.15.4.tar.gz
7z x curl-7.15.4.tar</pre><p>The <code class="literal">.tar.gz</code> and <code class="literal">.tar</code> files may be deleted.</p></li><li class="listitem"><p>Navigate to the library source directory:</p><pre class="programlisting">cd curl-7.15.4\lib</pre></li><li class="listitem"><p>If you are using version 6 of Microsoft's Visual C++ software development kit, the makefile of interest is <code class="literal">Makefile.vc6</code> located in the <code class="literal">lib</code> subdirectory. Some small adjustments may need to be made to this file on your system. Look for the definition of <code class="literal">CFLAGS</code> and add the following text to the end of the line:</p><pre class="programlisting">/Dsocklen_t=int</pre></li><li class="listitem"><p>Locate the section that begins with the line:</p><pre class="programlisting"># release-dll</pre></li><li class="listitem"><p>A few lines below this, on the line that begins with <code class="literal">LNK</code>, remove the occurrence of <code class="literal">$(RTLIB)</code>. One line below this, on the line that begins with <code class="literal">CC</code>, add a space and <code class="literal">$(RTLIB)</code> following <code class="literal">$(CCNODBG)</code>.</p></li><li class="listitem"><p>Execute the following to build the dynamic-link library:</p><pre class="programlisting">nmake -f Makefile.vc6 CFG=release-dll</pre><p>This generates the dynamic-link library libcurl.dll and its associated <code class="literal">libcurl_imp.lib</code> import library. The library should compile without warnings except for a few messages like this after the link step:</p><pre class="programlisting">File not found - libcurl.lib
0 File(s) copied</pre><p>These may be safely ignored.</p></li><li class="listitem"><p>Issue the following command to copy <code class="literal">libcurl.dll</code> to a standard location where it will be found by Windows when needed:</p><pre class="programlisting">xcopy libcurl.dll "%UTIL_DIR%\*.*"</pre></li><li class="listitem"><p>Use the following command to copy the import library to a standard development directory where the linker will be able to find it:</p><pre class="programlisting">xcopy libcurl_imp.lib "%SDK_DIR%\lib\usr\*.*"</pre></li><li class="listitem"><p>Use the following command to copy the cURL header to a standard development directory where the compiler can find them:<a id="IDX-CHP-12-0064" class="indexterm"></a><a id="IDX-CHP-12-0065" class="indexterm"></a><a id="IDX-CHP-12-0066" class="indexterm"></a></p><pre class="programlisting">xcopy ..\include\curl\*.h "%SDK_DIR%\include\usr\curl\*.*"</pre></li><li class="listitem"><p>Buildthe command line cURL program, curl.exe, as follows:</p><pre class="programlisting">cd ..\src
nmake -f Makefile.vc6 CFG=release-dll</pre></li><li class="listitem"><p>Test the build with the following command:</p><pre class="programlisting">.\curl -V</pre><p>This should result in the following output:</p><pre class="programlisting">curl 7.15.4 (i386-pc-win32) libcurl/7.15.4
Protocols: tftp ftp telnet dict ldap http file
Features: Largefile</pre></li><li class="listitem"><p>Copy <code class="literal">curl.exe</code> to your utility directory as follows:</p><pre class="programlisting">xcopy curl.exe "%UTIL_DIR%\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_luacurl"></a>Building luacurl</h2></div></div></div><p>The luacurl library is a binding that joins Lua to libcurl. It was created by Alexander Marinov and is available at the LuaForge website at <code class="literal">luaforge.net</code>.<a id="IDX-CHP-12-0067" class="indexterm"></a><a id="IDX-CHP-12-0068" class="indexterm"></a><a id="IDX-CHP-12-0069" class="indexterm"></a></p><p>Download the latest version of the <code class="literal">luacurl</code> source package and place it in the location where you intend to build it. The example shown here is for version 1.1 of the binding, so you'll need to make the changes to its name in the following instructions if you are building an updated version.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_luacurl_on_unix-like_systems"></a>Building luacurl on Unix-Like Systems</h3></div></div></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the zip file in the location where you will build it:</p><pre class="programlisting">unzip luacurl-1.1.zip</pre></li><li class="listitem"><p>Drop into the <code class="literal">luacurl</code> directory:</p><pre class="programlisting">cd luacurl-1.1</pre></li><li class="listitem"><p>Compile the library was follows:</p><pre class="programlisting">cc -ansi -pedantic -Wall -O2 -o luacurl.so -shared luacurl.c -lcurl</pre></li><li class="listitem"><p>Execute the following command to test whether the library can be loaded:</p><pre class="programlisting">lua -e 'package.cpath="./?.so" require "luacurl" print(curl)'</pre></li><li class="listitem"><p>The <code class="literal">curl</code> table identifier should be reported. If it is, copy <code class="literal">luacurl.so</code> to your Lua library directory:</p><pre class="programlisting">cp luacurl.so $LUA_DIR/</pre></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_luacurl_on_windows"></a>Building luacurl on Windows</h3></div></div></div><p>Follow these steps:<a id="IDX-CHP-12-0070" class="indexterm"></a><a id="IDX-CHP-12-0071" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the zip file in the location where you will build it:</p><pre class="programlisting">7z x luacurl-1.1.zip</pre></li><li class="listitem"><p>Drop into the <code class="literal">luacurl</code> directory:</p><pre class="programlisting">cd luacurl-1.1</pre></li><li class="listitem"><p>Compile the library as follows. These instructions will work if you are using Microsoft Visual C++ 6.0. Join the line ending with </p><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building luacurl on Windows" width="12" height="12"></div><pre class="programlisting">cl /c /W1 /Zl /Zd /Yd /MD /DWIN32 luacurl.c
link /dll /base:0x68000000 /machine:ix86 /export:luaopen_luacurl <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building luacurl on Windows" width="12" height="12"></div>
luacurl.obj lua5.1.lib msvcrt.lib libcurl_imp.lib</pre></li><li class="listitem"><p>Execute the following command to make sure the library can be loaded:</p><pre class="programlisting">lua -e "package.cpath='./?.dll' require 'luacurl' print(curl)"</pre></li><li class="listitem"><p>The <code class="literal">curl</code> table identifier should be reported. If it is, copy <code class="literal">luacurl.dll</code> to your Lua library directory:</p><pre class="programlisting">xcopy luacurl.dll "%LUA_DIR%\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="using_luacurl"></a>Using luacurl</h2></div></div></div><p>The <code class="literal">luacurl</code> binding provides file transfer capabilities to your Lua scripts by exposing functions from the cURL library. The documentation for <code class="literal">luacurl</code> is included in the source package as <code class="literal">luacurl.html</code>. Most of the library's functionality is encapsulated in the object that is returned from a call to <code class="literal">curl.new</code>. With this object, various options are set using the <code class="literal">setopt</code> method. These options specify details of the request. The documentation for cURL itself, located in the <code class="literal">docs</code> subdirectory of the <code class="literal">curl</code> source tree, has more information about these options. When these options are set, the actual request is made using the <code class="literal">perform</code> method.</p><div class="sidebar"><a id="try_it_out_colon_retrieving_a_web_docume"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Retrieving a Web Document</strong></p></div></div></div><p>In this exercise, you will use <code class="literal">luacurl</code> to programmatically request a resource on the Web.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following listing as <code class="literal">curltest.lua</code>:</p><pre class="programlisting">require "luacurl"
require "show"

local FileStr = "test"
local SiteStr = "http://www.lua.org/"

local function LclWrite(FileHnd, BufStr)
  FileHnd:write(BufStr)
  return string.len(BufStr)
end</pre><pre class="programlisting">local function LclProgress(UserPrm, DownTotal, DownNow, UpTotal, UpNow)
     print(DownTotal, DownNow, UpTotal, UpNow)
end

local Hnd = curl.new()
if Hnd then
  local FileHnd = io.open(FileStr, "wb")
  if FileHnd then
    Hnd:setopt(curl.OPT_WRITEFUNCTION, LclWrite)
    Hnd:setopt(curl.OPT_WRITEDATA, FileHnd)
    Hnd:setopt(curl.OPT_PROGRESSFUNCTION, LclProgress)
    Hnd:setopt(curl.OPT_NOPROGRESS, false)
    Hnd:setopt(curl.OPT_BUFFERSIZE, 5000)
    Hnd:setopt(curl.OPT_HTTPHEADER, "Connection: Keep-Alive",
      "Accept-Language: en-us")
    Hnd:setopt(curl.OPT_URL, SiteStr)
    Hnd:setopt(curl.OPT_CONNECTTIMEOUT, 15)
    local R = { Hnd:perform() }
    ObjectShow(R, "perform")
    local Ok, ErrStr, RetCode = Hnd:perform()
    if Ok then
      io.write("Resource successfully saved as ", FileStr, "\n")
    else
      io.write("Error: ", ErrStr, " (", RetCode, ")\n")
    end
    FileHnd:close()
  else
    io.write("Error opening ", FileStr, "\n")
  end
  Hnd:close()
else
  io.write("Error instantiating curl object.\n")
end</pre></li><li class="listitem"><p>Run the script with the Lua interpreter:<a id="IDX-CHP-12-0073" class="indexterm"></a><a id="IDX-CHP-12-0074" class="indexterm"></a></p><pre class="programlisting">lua curltest.lua</pre></li></ol></div><p>This should result in the periodic printing of progress lines indicating the total size of the transfer and how much of it has been downloaded. Because the time needed to resolve the name of the web server is included in this progress, the first few notifications may indicate no transfer of content. The progress notification is done in a callback that could be used to drive a progress bar in an application.<a id="IDX-CHP-12-0075" class="indexterm"></a></p><p><span class="strong"><strong>How It Works</strong></span></p><p>After requiring the <code class="literal">luacurl</code> module, some local variables are declared that identify the resource to be retrieved and the name with which to save it. Placing values like this near the top of a script can help make it a bit more convenient to modify later.</p><p>The <code class="literal">LclWrite</code> function is used as a <span class="emphasis"><em>callback</em></span>, which is a function that is called by the library back into the script. In this case, it is called by <code class="literal">luacurl</code> when there is retrieved data to be written.</p><p>Beneath this is another callback. This one is called at intervals with arguments that indicate the number of bytes transferred and the number of bytes to be transferred.</p><p>This is followed by a call to <code class="literal">curl.new</code>, which is the function that creates a new transaction handle. If this succeeds, the returned value will not be <code class="literal">nil</code> and a new block is entered. Here, a file is opened in binary mode to save the resource to be downloaded. If the file is successfully opened, a number of options are set which modify how the request is to be made and handled. In this case, the two callbacks are registered. The <code class="literal">curl.OPT_WRITEDATA</code> option specifies the first parameter to the write callback. Here, the handle to the open file is passed. The cURL library merely passes this parameter back to the calling script without acting on it. This feature makes it easier to avoid global variables or the need to make a closure.<a id="IDX-CHP-12-0076" class="indexterm"></a><a id="IDX-CHP-12-0077" class="indexterm"></a><a id="IDX-CHP-12-0078" class="indexterm"></a><a id="IDX-CHP-12-0079" class="indexterm"></a><a id="IDX-CHP-12-0080" class="indexterm"></a><a id="IDX-CHP-12-0081" class="indexterm"></a><a id="IDX-CHP-12-0082" class="indexterm"></a><a id="IDX-CHP-12-0083" class="indexterm"></a></p><p>You can use the <code class="literal">curl.OPT_PROXY</code> option to make a web request through a proxy server. It should receive a string of the form "<code class="systemitem">http://proxyserver:8888</code>" where <code class="literal">proxyserver</code> and <code class="literal">8888</code> is the name and address of your proxy server and its port, respectively.</p><p>Even the address of the desired resource is conveyed to the cURL library by means of an option, in this case, <code class="literal">curl.OPT_URL</code>. There are dozens of other options, including timeout value, buffer size, and additional headers.</p><p>When all options have been set up, the actual request is made with a call to the <code class="literal">perform</code> method. This method returns <code class="literal">true</code> if the request succeeds, or <code class="literal">false</code> followed by a message and a result code if the request fails. Note that cURL considers the transaction a success if everything sent by the server is received. The returned page might, however, be a notification page indicating that the requested page could not be found or that some other error occurred at the server. You must examine the headers of the returned resource to determine that.</p></div><p>The cURL website, <code class="literal">curl.haxx.se</code>, contains a wealth of information on how the library can be used. In <a class="link" href="ch16.html" title="Chapter 16. Connecting to a Larger World">Chapter 16</a> you'll become familiar with LuaSocket, an alterative and more general package for network communication that was designed from the ground up to work with Lua.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="the_gd_graphics_library"></a>The gd Graphics Library</h1></div></div></div><p>The <code class="literal">gd</code> graphics library enables programs to noninteractively construct images in a number of formats. It has become a fixture on web servers around the world for dynamically generating web content at runtime, an example of which you will encounter in <a class="link" href="ch15.html" title="Chapter 15. Programming for the Web">Chapter 15</a>. The library was created by Thomas Boutell and is available from <code class="literal"><code class="systemitem">www.boutell.com/gd</code></code>.</p><p>The notion of a graphics library that is entirely driven by program commands rather than through interactive use is a powerful one. As a programmer, you are accustomed to specifying in exact terms the steps needed to accomplish some goal. When applied to graphic generation, this skill can be leveraged to produce precise images repeatedly and automatically.</p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_gd"></a>Building gd</h2></div></div></div><p>The <code class="literal">gd</code> library makes use of a number of libraries for image formatting, font specification, and data compression. Meeting these library requirements on Unix-like systems is nothing out of the ordinary, but it can be a hardship on Windows. Consequently, the documentation for <code class="literal">gd</code> encourages developers on Windows to use the precompiled DLL and the related files it comes packaged with. That's the approach taken here.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_gd_on_unix-like_systems"></a>Building gd on Unix-Like Systems</h3></div></div></div><p>Before building <code class="literal">gd</code>, you should check to see if your system already has it. You can do this with the following command:<a id="IDX-CHP-12-0084" class="indexterm"></a><a id="IDX-CHP-12-0085" class="indexterm"></a><a id="IDX-CHP-12-0086" class="indexterm"></a><a id="IDX-CHP-12-0087" class="indexterm"></a></p><pre class="programlisting">find / -name "libgd.*"</pre><p>If you see lines like this, you've already got the <code class="literal">gd</code> library installed, and you can skip the building step:</p><pre class="programlisting">/usr/local/lib/libgd.so.2.0.0</pre><p>Even if the <code class="literal">gd</code> library is not present on your system, you may be able to install it as a package tailored for your platform.</p><p>Follow these steps to build <code class="literal">gd</code>:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Acquire <code class="literal">gd-2.0.33.tar.gz</code> from <code class="literal"><code class="systemitem">www.boutell.com/gd</code></code> and place it in the location where you'll build it. Unpackage it with this:</p><pre class="programlisting">tar xzvf gd-2.0.33.tar.gz</pre></li><li class="listitem"><p>Drop into the newly-created directory like this:</p><pre class="programlisting">cd gd-2.0.33</pre></li><li class="listitem"><p>Take time to read the files README.TXT and INSTALL that are in this directory. They're short and explain library dependencies that may be relevant to your system. Assuming you've got the libraries you need, run the configure script as follows:</p><pre class="programlisting">./configure</pre></li><li class="listitem"><p>Compile and link the library by running this:</p><pre class="programlisting">make</pre></li><li class="listitem"><p>As root, install the library by running this:</p><pre class="programlisting">make install</pre></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="installing_gd_on_windows"></a>Installing gd on Windows</h3></div></div></div><p>To install <code class="literal">gd</code> on Windows, follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Download <code class="literal">gdwin32.zip</code> from <code class="literal"><code class="systemitem">www.boutell.com/gd</code></code> and place it in the location where you'll unzip it. If you're using <span class="emphasis"><em>7</em></span>-zip, unpackage it as follows:</p><pre class="programlisting">7z x gdwin32.zip</pre><p>This extracts the zipfile's contents into a directory named <code class="literal">gdwin32</code>. Drop into that directory now by issuing this command:</p><pre class="programlisting">cd gdwin32</pre><p>The <code class="literal">gd</code> library is implemented in the <code class="literal">bgd.dll</code> file.</p></li><li class="listitem"><p>Copy that file to your utility directory like this:<a id="IDX-CHP-12-0088" class="indexterm"></a><a id="IDX-CHP-12-0089" class="indexterm"></a><a id="IDX-CHP-12-0090" class="indexterm"></a><a id="IDX-CHP-12-0091" class="indexterm"></a></p><pre class="programlisting">xcopy bgd.dll "%UTIL_DIR%\*.*"</pre></li><li class="listitem"><p>Assuming you're using version 6 of the Microsoft Visual C++ development kit, create and install the import library for this DLL as follows:</p><pre class="programlisting">lib /machine:i386 /def:bgd.def
xcopy bgd.lib "%SDK_DIR%\lib\usr\*.*"</pre></li><li class="listitem"><p>Install the header files as follows:</p><pre class="programlisting">xcopy *.h "%SDK_DIR%\include\usr\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_lua-gd"></a>Building lua-gd</h2></div></div></div><p>Alexandre Erwin Ittner has written a binding that allows the <code class="literal">gd</code> library to be used from Lua scripts. The following instructions use <code class="literal">lua-gd-2.0.33r2.tar.gz</code>. In the package name, the number to the left of the <code class="literal">r</code> corresponds to the <code class="literal">gd</code> library version, and the number to the right indicates the binding release version. If you are using an updated version, make sure it conforms to the <code class="literal">gd</code> library version you have installed.<a id="IDX-CHP-12-0092" class="indexterm"></a><a id="IDX-CHP-12-0093" class="indexterm"></a><a id="IDX-CHP-12-0094" class="indexterm"></a></p><p>Download the source tarball from <code class="literal">lua-gd.luaforge.net</code> and move it to location where you will build the library.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_lua-gd_on_unix-like_systems"></a>Building lua-gd on Unix-Like Systems</h3></div></div></div><p>To build <code class="literal">lua-gd</code> on Unix-like systems, follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the package's contents as follows:</p><pre class="programlisting">tar xzvf lua-gd-2.0.33r2.tar.gz</pre></li><li class="listitem"><p>Change the working directory to this newly-created directory like this:</p><pre class="programlisting">cd lua-gd-2.0.33r2</pre></li><li class="listitem"><p>The <code class="literal">luagd</code> is built to match the functionality of the <code class="literal">gd</code> library. For example, if the <code class="literal">gd</code> library supports JPEG operations but not XPM operations, then the <code class="literal">luagd</code> library will provide bindings for JPEG but not XPM. In order to find out what libraries <code class="literal">gd</code> supports, run that library's configuration reporter, as follows:</p><pre class="programlisting">gdlib-config --features --version</pre><p>This should result in a report like this:</p><pre class="programlisting">GD_JPEG GD_FREETYPE GD_PNG GD_GIF
2.0.33</pre></li><li class="listitem"><p>Compile <code class="literal">luagd</code> as follows:</p><div class="blockquote"><blockquote class="blockquote"><p>You may need to modify the symbol definitions to match the features of the <code class="literal">gd</code> library. Every feature shown in the previous output should be defined using the <code class="literal">-D</code> switch.</p></blockquote></div><pre class="programlisting">cc -ansi -pedantic -Wall -O2 -DGD_JPEG -DGD_PNG -DGD_FREETYPE <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building lua-gd on Unix-Like Systems" width="12" height="12"></div>
-DGD_GIF -o gd.so -lgd -shared luagd.c</pre></li><li class="listitem"><p>Test the new library as follows:<a id="IDX-CHP-12-0095" class="indexterm"></a></p><pre class="programlisting">lua -e 'package.cpath="./?.so"' test_features.lua</pre><p>A report like this should be generated:</p><pre class="programlisting">Lua-GD version: lua-gd 2.0.33r2
Lua-GD features:
    PNG support ..................... Enabled
    GIF support ..................... Enabled
    JPEG support .................... Enabled
    XPM/XBM support ................. Disabled
    FreeType support ................ Enabled
    Fontconfig support .............. Disabled</pre></li><li class="listitem"><p>Copy <code class="literal">gd.so</code> to the Lua module directory with this command:</p><pre class="programlisting">cp gd.so $LUA_DIR/</pre></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_lua-gd_on_windows"></a>Building lua-gd on Windows</h3></div></div></div><p>To build lua-gd on Windows, follow these steps:<a id="IDX-CHP-12-0096" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the package's contents as follows:</p><pre class="programlisting">7z x lua-gd-2.0.33r2.tar.gz
7z x lua-gd-2.0.33r2.tar</pre><p>You can now delete these files.</p></li><li class="listitem"><p>Jump into the newly created directory as follows:</p><pre class="programlisting">cd lua-gd-2.0.33r2</pre></li><li class="listitem"><p>Compile the library as follows:</p><pre class="programlisting">cl /c /W1 /Zl /Zd /Yd /MD /DWIN32 /DGD_PNG /DGD_GIF /DGD_FREETYPE <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building lua-gd on Windows" width="12" height="12"></div>
/DGD_JPEG /DGD_XPM /DGD_FONTCONFIG luagd.c

link /dll /out:gd.dll /base:0x67500000 /machine:ix86 <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building lua-gd on Windows" width="12" height="12"></div>
/export:luaopen_gd luagd.obj lua5.1.lib msvcrt.lib bgd.lib</pre></li><li class="listitem"><p>Test the <code class="literal">luagd</code> library with the following command:</p><pre class="programlisting">lua -e "package.cpath='./?.dll'" test_features.lua</pre><p>The following report should be displayed:</p><pre class="programlisting">Lua-GD version: lua-gd 2.0.33r2
Lua-GD features:
    PNG support ..................... Enabled
    GIF support ..................... Enabled
    JPEG support .................... Enabled
    XPM/XBM support ................. Enabled
    FreeType support ................ Enabled
    Fontconfig support .............. Enabled</pre></li><li class="listitem"><p>If this test succeeds, install <code class="literal">luagd</code> as follows:<a id="IDX-CHP-12-0097" class="indexterm"></a><a id="IDX-CHP-12-0098" class="indexterm"></a><a id="IDX-CHP-12-0099" class="indexterm"></a></p><pre class="programlisting">xcopy gd.dll "%LUA_DIR%\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="using_lua-gd"></a>Using lua-gd</h2></div></div></div><p>The <code class="literal">demos</code> subdirectory of the <code class="literal">luagd</code> source package has an abundance of sample scripts that demonstrate the capabilities of the <code class="literal">gd</code> library and <code class="literal">luagd</code> binding. Most of the scripts end with a construction something like this:</p><pre class="programlisting">im:png("out.png")
os.execute("display out.png")</pre><p>That is, the <code class="literal">gd</code> library is called to create an image file, and then the system is called to display it. If this is appropriate for your system, no changes need to be made to the scripts. On Windows, however, you will likely need to modify the command submitted to <code class="literal">os.execute</code>. If you have a visual display program like IrfanView that is registered to display PNG files, then changing <code class="literal">display</code> to <code class="literal">start</code> is sufficient.</p><p>Now that you've installed the <code class="literal">gd</code> library and <code class="literal">luagd</code> module on your system, you'll use it in the following Try It Out to programmatically generate the Lua logo.</p><div class="sidebar"><a id="try_it_out_colon_generating_the_lua_logo"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Generating the Lua Logo</strong></p></div></div></div><p>The Lua logo would have delighted Euclid. The center of the moon element is positioned at the corner of the bounding square of the planet, and its radius is based on metrics of this bounding square. The instructions to construct the logo are adapted from a sample script in Luiz Henrique de Figueiredo's PDF binding, with a friendly tip of the hat to its author and to Alexandre Nakonechnyj, the designer of the Lua logo.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Copy the following contents to a script named <code class="literal">lua-logo.lua</code>:</p><pre class="programlisting">require "gd"

local Lcl = {}

local function LclWriteCtr(Hnd, X, Y, Clr, FontStr, PtSize, TextStr)
  local Ext = {gd.stringFT(nil, Clr, FontStr, PtSize, 0, 0, 0, TextStr)}
  Hnd:stringFT(Clr, FontStr, PtSize, 0, X - (Ext[3] - Ext[1]) / 2,
    Y + (Ext[4] - Ext[6]) / 2, TextStr)
end

Lcl.Size = 256
--Lcl.FontStr = "c:/windows/fonts/arial.ttf" -– Windows
Lcl.FontStr = "vera " -– Linux and friends
Lcl.Scale = 1 - math.sqrt(2) / 2
Lcl.RadiusLg = Lcl.Size / 3
Lcl.DiameterLg = 2 * Lcl.RadiusLg
Lcl.RadiusSm = Lcl.Scale * Lcl.RadiusLg
Lcl.DiameterSm = 2 * Lcl.RadiusSm
Lcl.CenterX = (Lcl.Size - Lcl.RadiusSm / 2) / 2
Lcl.CenterY = (Lcl.Size + Lcl.RadiusSm / 2) / 2</pre><pre class="programlisting">Hnd = gd.createTrueColor(Lcl.Size, Lcl.Size)
Lcl.White = Hnd:colorAllocate(255, 255, 255)
Lcl.Blue = Hnd:colorAllocate(32, 32, 128)
Lcl.Gray = Hnd:colorAllocate(192, 192, 192)
Lcl.Black = Hnd:colorAllocate(0, 0, 0)
Hnd:setAntiAliased(Lcl.Blue)
Hnd:filledRectangle(0, 0, Lcl.Size - 1, Lcl.Size - 1, Lcl.White)
-- Planet
Hnd:filledArc(Lcl.CenterX, Lcl.CenterY, Lcl.DiameterLg, Lcl.DiameterLg,
0, 360, gd.ANTI_ALIASED, gd.ARC)
-- Moon
Hnd:filledArc(Lcl.CenterX + Lcl.RadiusLg, Lcl.CenterY - Lcl.RadiusLg,
  Lcl.DiameterSm, Lcl.DiameterSm, 0, 360, gd.ANTI_ALIASED, gd.ARC)
-- Moonshadow
Hnd:setAntiAliased(Lcl.White)
Hnd:filledArc(Lcl.CenterX + Lcl.RadiusLg - Lcl.DiameterSm,
  Lcl.CenterY - Lcl.RadiusLg + Lcl.DiameterSm,
  Lcl.DiameterSm, Lcl.DiameterSm, 0, 360, gd.ANTI_ALIASED, gd.ARC)
-- Orbit
Hnd:setAntiAliased(Lcl.Gray)
Hnd:arc(Lcl.CenterX, Lcl.CenterY,
  Lcl.DiameterLg + Lcl.DiameterSm, Lcl.DiameterLg + Lcl.DiameterSm, 0, 300,
  gd.ANTI_ALIASED, gd.ARC)
Hnd:arc(Lcl.CenterX, Lcl.CenterY,
  Lcl.DiameterLg + Lcl.DiameterSm, Lcl.DiameterLg + Lcl.DiameterSm, 330, 360,
  gd.ANTI_ALIASED, gd.ARC)
-- Text
LclWriteCtr(Hnd, Lcl.CenterX, Lcl.CenterY + Lcl.RadiusSm, Lcl.White,
  Lcl.FontStr, 48, "Lua")
Hnd:png("logo.png")
Hnd:gif("logo.gif")
Hnd:jpeg("logo.jpg", 90)
os.execute("start logo.png")</pre></li><li class="listitem"><p>The font specification may need some adjustment on your system. On Windows, the full path of the Arial font is specified; on systems with Helvetica, use that instead. The <code class="literal">gd</code> library is generally successful in finding fonts without path information on Unix-type systems Also, depending on how you view PNG images, you may need to adjust the final line or remove it entirely.</p></li><li class="listitem"><p>To generate the logo, run the script with the Lua interpreter as follows:</p><pre class="programlisting">lua lua-logo.lua</pre></li></ol></div><p>This will generate the file <code class="literal">logo.png</code>, which should look like <a class="link" href="ch12.html#figure_12-3" title="Figure 12.3. Figure 12-3">Figure 12-3</a>.<a id="IDX-CHP-12-0100" class="indexterm"></a></p><div class="figure"><a id="figure_12-3"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1203.png" width="285" alt="Figure 12-3" height="286"></div></div><p class="title"><strong>Figure 12.3. Figure 12-3</strong></p></div><p><span class="strong"><strong>How It Works</strong></span></p><p>Requiring the <code class="literal">lua-gd</code> module introduces the <code class="literal">gd</code> namespace to your script. A blank image is created by passing the width and height in pixels to the <code class="literal">gd.createTrueColor</code> function or the <code class="literal">gd.createPalette</code> function. These functions return an object that is used for subsequent image construction.<a id="IDX-CHP-12-0101" class="indexterm"></a></p><p>The origin for subsequent operations is the upper-left corner. X values increase to the right; Y values increase to the bottom. Units are measured in pixels. Arcs are drawn clockwise starting from the 3 o'clock position using degrees.</p><p>Colors need to be allocated using red, green and blue values ranging from 0 to 255. In the case of a palette image, the first color allocated becomes the background color. The stairstep appearance of nonvertical and nonhorizontal lines in the image can be mitigated by anti-aliasing, a technique which blends the boundary between different colors with appropriate shades. This feature is available only with truecolor images. To use it, call the <code class="literal">setAntiAliased</code> method with the color you will be using. Then, instead of specifying this color for a drawing operation, specify <code class="literal">gd.ANTI_ALIASED</code>.</p><p>The extent of a string is obtained using the same function used to render it on an image, namely the <code class="literal">stringFT</code> method. Instead of calling it as a method, however, it is called as an ordinary namespace function with the value <code class="literal">nil</code> instead of an image object. In this case, the coordinates of the bound rectangle are returned. Both the extent retrieval and text rendering are combined into a helper function named <code class="literal">LclWriteCtr</code> in this script.</p><p>The graphical drawing in this script is done with the <code class="literal">filledRectangle, filledArc</code>, and <code class="literal">arc</code> methods.</p><p>The <code class="literal">gd</code> library constructs the image using its own internal format. The actual file generation occurs with a call to <code class="literal">png, pngEx, jpeg, gif</code>, or <code class="literal">gd2</code>. These methods are not mutually exclusive—more than one can be called to generate copies in various destination formats. The last image type is the internal format of <code class="literal">gd</code>—it is not intended for use by other programs, but it can be useful when images will be subsequently processed by the <code class="literal">gd</code> library.</p></div><p>The <code class="literal">gd</code> library and <code class="literal">lua-gd</code> binding are well suited to many kinds of image production. In the next Try It Out, you use them to generate a graphical representation of a function's output.<a id="IDX-CHP-12-0102" class="indexterm"></a></p><div class="sidebar"><a id="try_it_out_colon_producing_a_function_pl"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Producing a Function Plot</strong></p></div></div></div><p>In <a class="link" href="ch11.html" title="Chapter 11. Exploring Lua's Libraries">Chapter 11</a>, a number of the math function summaries were accompanied by a graphical plot that was generated using <code class="literal">gd</code> and <code class="literal">lua-gd</code>. In this exercise, you specify a function that accepts a number and returns a correlated number. The Lua script creates and initializes a graphic object and uses it to plot the specified function over a range of values. The diagram is then saved as a PNG image.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>With your text editor, create a new file with the following contents:</p><div class="blockquote"><blockquote class="blockquote"><p>Depending on your platform, you may need to adjust the value of the <code class="literal">FontStr</code> field near the top of the script. In particular, you need to specify the full path of the directory in which fonts are stored.</p></blockquote></div><pre class="programlisting">require "gd"

local Cn = {
  -- FontStr = "c:/windows/fonts/arial.ttf",
  FontStr = "vera",
  Height = 1024,
  Margin = 12,
  PointSize = 36,
}

local function ImgInit()
  local Img = {}
  Img.Height = Cn.Height
  Img.Width = Img.Height * (1 + math.sqrt(5)) / 2
  Img.Hnd = gd.createTrueColor(Img.Width, Img.Height)
  Img.White = Img.Hnd:colorAllocate(255, 255, 255)
  Img.Black = Img.Hnd:colorAllocate(0, 0, 0)
  Img.Gray = Img.Hnd:colorAllocate(192, 192, 192)
  local Ext = {gd.stringFT(nil, Img.White,
    Cn.FontStr, Cn.PointSize, 0, Cn.Margin, Cn.Margin, "X")}
  Img.ChHt = Ext[2] - Ext[8]
  Img.Left = Cn.Margin
  Img.Right = Img.Width - Img.Left - 1
  Img.Top = Cn.Margin + Img.ChHt + Cn.Margin
  Img.Bottom = Img.Height - Img.Left - 1
  Img.Hnd:setAntiAliased(Img.Black)
  Img.Hnd:filledRectangle(0, 0, Img.Width - 1, Img.Height - 1, Img.White)
  Img.Hnd:rectangle(Img.Left, Img.Top, Img.Right, Img.Bottom, Img.Black)
  return Img
end

-- Write antialiased text. XAlign is "left", "center", or "right" and qualifies
-- X. YAlign is "top", "middle", or "bottom" and qualifies Y.

local function LclWrite(Img, X, XAlign, Y, YAlign, Clr, TextStr)
  local Lf, Bt, Rt, _, _, Tp = gd.stringFT(nil, Clr, Cn.FontStr,
    Cn.PointSize, 0, 0, 0, TextStr)
  local Wd = Rt - Lf
  X = XAlign == "center" and X - Wd / 2 or XAlign == "right" and X - Wd or X
  Y = YAlign == "middle" and Y + Img.ChHt / 2 or</pre><pre class="programlisting">YAlign == "top" and Y + Img.ChHt or Y
  Img.Hnd:stringFT(Clr, Cn.FontStr, Cn.PointSize, 0, X, Y, TextStr)
end

-- Plot Y = Fnc(X) from X1 to X2. Disjoint is true if change in Y lifts pen.

local function Plot(Img, X1, Y1, X2, Y2, Fnc, TitleStr, Disjoint)
  -- Mapping functions
  -- X = Xm * H + Xb where H is horizontal pixel unit
  -- H = Hm * X + Hb
  -- Y = Fnc(X)
  -- V = Vm * Y + Vb where V is vertical pixel unit
  local Lift, X, Xm, Xb, V, Vm, Vb, Y, H, HPrv, VPrv, Ht, Wd,
    Hm, Hb, YPrv, BadVal
  Ht = Img.Bottom - Img.Top
  Wd = Img.Right - Img.Left
  Xm = (X2 - X1) / Wd
  Xb = X2 - Xm * Img.Right
  Hm = Wd / (X2 - X1)
  Hb = Img.Left - Hm * X1
  Vm = Ht / (Y1 - Y2)
  Vb = Img.Bottom - Vm * Y1

  LclWrite(Img, Cn.Margin, "left", Cn.Margin, "top", Img.Black, TitleStr)
  Img.Hnd:setClip(Img.Left, Img.Top, Img.Right, Img.Bottom)
  Img.Hnd:line(Img.Left + 1, Vb, Img.Right - 1, Vb, Img.Gray) -- Y = 0
  Img.Hnd:line(Hb, Img.Top + 1, Hb, Img.Bottom - 1, Img.Gray) -- X = 0
  BadVal = tostring(math.asin(2))
  Lift = true
  for H = Img.Left, Img.Right do
    X = Xm * H + Xb
    X = X &lt; X1 and X1 or X &gt; X2 and X2 or X -- Constrain sign at boundaries
    Y = Fnc(X)
    if tostring(Y) ~= BadVal then
      if Disjoint and Y ~= YPrv then
        Lift = true
      end
      YPrv = Y
      V = Vm * Y + Vb
      if Lift then
        Lift = false
      else
        if Y &gt;= Y1 and Y &lt;= Y2 then
          Img.Hnd:line(HPrv, VPrv, H, V, Img.Hnd.ANTI_ALIASED)
        end
      end
      VPrv = V
      HPrv = H
    end
  end
  LclWrite(Img, Img.Left + Cn.Margin, "left", Img.Bottom - Cn.Margin, "bottom",
    Img.Gray, "(" .. X1 .. ", " .. Y1 .. ")")
  LclWrite(Img, Img.Right - Cn.Margin, "right", Img.Top + Cn.Margin, "top",
    Img.Gray, "(" .. X2 .. ", " .. Y2 .. ")")
end</pre><pre class="programlisting">function Waveform(X)
  return math.sin(3*X) * math.sin(X/3)
end

local Img = ImgInit()
Plot(Img, −12, −1.2, 12, 1.2, Waveform, "Waveform")
Img.Hnd:png("waveform.png")</pre></li><li class="listitem"><p>Save this file as <code class="literal">plot.lua</code>.<a id="IDX-CHP-12-0103" class="indexterm"></a></p></li><li class="listitem"><p>Run the script as follows:</p><pre class="programlisting">lua plot.lua</pre></li></ol></div><p>An image file in PNG format named <code class="literal">waveform.png</code> will be generated, which is shown in <a class="link" href="ch12.html#figure_12-4" title="Figure 12.4. Figure 12-4">Figure 12-4</a>.</p><div class="figure"><a id="figure_12-4"></a><div class="figure-contents"><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/1204.png" height="339" alt="Figure 12-4" width="549"></div></div><p class="title"><strong>Figure 12.4. Figure 12-4</strong></p></div><p><span class="strong"><strong>How It Works</strong></span></p><p>The local table named <code class="literal">Cn</code> near the top of the script holds various constants that the script uses. Placing these values in one place makes it easier to make adjustments later if you need to modify the script's behavior.</p><p>The <code class="literal">ImgInit</code> function instantiates a graphic object using some of the specified constants. This is a general purpose routine that isn't bound to the plotting function called later in the script.</p><p>The <code class="literal">LclWrite</code> function is another general purpose routine. This one positions text in relation to a specified point. For example, you can render text so that it is centered horizontally on a point and positioned vertically just beneath the point.<a id="IDX-CHP-12-0104" class="indexterm"></a><a id="IDX-CHP-12-0105" class="indexterm"></a><a id="IDX-CHP-12-0106" class="indexterm"></a><a id="IDX-CHP-12-0107" class="indexterm"></a><a id="IDX-CHP-12-0108" class="indexterm"></a><a id="IDX-CHP-12-0109" class="indexterm"></a><a id="IDX-CHP-12-0110" class="indexterm"></a><a id="IDX-CHP-12-0111" class="indexterm"></a><a id="IDX-CHP-12-0112" class="indexterm"></a></p><p>The main function in the script is <code class="literal">Plot</code>. This function takes care of all the scaling and iterating needed to plot the function that you specify with an image object. As arguments, you specify the <span class="emphasis"><em>domain</em></span> of the function (the allowable input values) and the <span class="emphasis"><em>range</em></span> of the function (its output values). These are passed as endpoints. For example, in this script, the value for <code class="literal">X1</code> indicates the low point at which the function is evaluated, and <code class="literal">X2</code> indicates the high point. The main iteration begins with the following line:</p><pre class="programlisting">for H = Img.Left, Img.Right do</pre><p>This loop steps through the drawing region from the left side to the right. The block of the loop determines the input value that corresponds with the position and calls the passed-in function with this value. The value returned from the passed-in function is mapped to a vertical position, and a line is drawn to the previous point.</p><p>The <code class="literal">Waveform</code> function is a custom function that you pass to the <code class="literal">Plot</code> function for rendering. Experiment with different replacement functions, adjusting the values for <code class="literal">X1, X2, Y1</code>, and <code class="literal">Y2</code> as needed.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="the_sqlite_database_library"></a>The SQLite Database Library</h1></div></div></div><p>There are Lua bindings to many relational databases systems. The one discussed here binds to SQLite, a fast and remarkably compact embeddable database engine that implements much of the SQL92 standard. SQLite is a trouble-free, dependable database system suitable for a wide spectrum of applications. It was created by D. Richard Hipp to fill a niche left vacant by large-scale relational database management systems, such as the need for serverless data management in which an application and its data can be moved together. Relational databases will be explored in more detail in <a class="link" href="ch14.html" title="Chapter 14. Managing Information with Databases">Chapter 14</a>.<a id="IDX-CHP-12-0113" class="indexterm"></a></p><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_sqlite3"></a>Building SQLite3</h2></div></div></div><p>The SQLite documentation, changelogs, source code comments, and rational version numbering all indicate an exemplary development environment. It is no surprise that SQLite compiles very nicely on a large number of platforms. The version covered here is 3.3.6—if you're using an updated version, make the appropriate changes to these instructions.</p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_sqlite3_on_unix-like_systems"></a>Building SQLite3 on Unix-Like Systems</h3></div></div></div><p>SQLite is a very popular system, and there is a good chance that it is already installed on your Unix-like system or that a package has been prepared for your platform that will expedite its installation. To see if it is already installed, issue the following command:</p><pre class="programlisting">which sqlite3</pre><p>If this results in a line that looks like the following, then SQLite is installed and you can dispense with the following building procedure:</p><pre class="programlisting">/usr/local/bin/sqlite3</pre><p>If SQLite is not installed, or you have an outdated version of SQLite, you should check to see if a package is available for your platform.<a id="IDX-CHP-12-0114" class="indexterm"></a><a id="IDX-CHP-12-0115" class="indexterm"></a></p><p>If you are going to build SQLite, start by downloading <code class="literal">sqlite-3.3.6.tar.gz</code> from <code class="literal"><code class="systemitem">www.sqlite.org</code></code> and placing it in your source code development directory. Then do the following:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract it with the following command:</p><pre class="programlisting">tar xzvf sqlite-3.3.6.tar.gz</pre></li><li class="listitem"><p>Make the newly created directory your working directory as follows:</p><pre class="programlisting">cd sqlite-3.3.6</pre></li><li class="listitem"><p>Configure the makefiles as follows:</p><pre class="programlisting">./configure</pre></li><li class="listitem"><p>Compile the library and database shell like this:</p><pre class="programlisting">make</pre></li><li class="listitem"><p>As root, install SQLite as follows:</p><pre class="programlisting">make install</pre></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_sqlite3_on_windows"></a>Building SQLite3 on Windows</h3></div></div></div><p>Developers on the Windows platform are provided a zip file called <code class="literal">sqlite-source-3_3_6.zip</code>, which contains preconfigured source code that simplifies the process of building SQLite. Download this zip file and then follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Create a directory for building the package as follows:</p><pre class="programlisting">mkdir sqlite-3.3.6
cd sqlite-3.3.6</pre></li><li class="listitem"><p>Extract the contents of the zip file into this directory, replacing <code class="literal">path\to</code> with the directory where the zip file is located, as follows:</p><pre class="programlisting">7z x path\to\sqlite-source-3_3_6.zip</pre></li><li class="listitem"><p>Some files can be effectively removed from the build. Do this by renaming them like this:</p><pre class="programlisting">ren os_os2.c os_os2.c0
ren os_unix.c os_unix.c0
ren tclsqlite.c tclsqlite.c0</pre></li><li class="listitem"><p>A small modification to the SQLite shell source file needs to be made to address Microsoft's naming conventions. Open <code class="literal">shell.c</code> with your editor and locate the following line:</p><pre class="programlisting">extern int isatty();</pre></li><li class="listitem"><p>Above this line, insert the following preprocessor definitions:</p><pre class="programlisting">#define isatty _isatty
#define fileno _fileno
#define access _access</pre><p>Unfortunately, these definitions can't be made on the compiler command line because they would interfere with definitions in the header files.<a id="IDX-CHP-12-0116" class="indexterm"></a><a id="IDX-CHP-12-0117" class="indexterm"></a><a id="IDX-CHP-12-0118" class="indexterm"></a><a id="IDX-CHP-12-0119" class="indexterm"></a><a id="IDX-CHP-12-0120" class="indexterm"></a></p></li><li class="listitem"><p>Compile the files as follows:</p><pre class="programlisting">cl /c /nologo /I. /Zl /Zd /Yd /MD /W0 *.c</pre></li><li class="listitem"><p>Exclude <code class="literal">shell.obj</code> from being pulled into the SQLite DLL by renaming it like this:</p><pre class="programlisting">ren shell.obj shell.o</pre></li><li class="listitem"><p>Create the DLL and its import library as follows:</p><pre class="programlisting">link /DLL /OUT:sqlite3.dll /BASE:0x66000000 /DEF:sqlite3.def *.obj msvcrt.lib</pre></li><li class="listitem"><p>Install these products and the SQLite header file as follows:</p><pre class="programlisting">xcopy sqlite3.dll "%UTIL_DIR%\*.*"
xcopy sqlite3.lib "%SDK_DIR%\lib\usr\*.*"
xcopy sqlite3.h "%SDK_DIR%\include\usr\*.*"</pre></li><li class="listitem"><p>Build the SQLite shell like this:</p><pre class="programlisting">link shell.o /OUT:sqlite3.exe sqlite3.lib msvcrt.lib</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The export definition file <code class="literal">sqlite3.def</code> has been problematic in recent releases of the SQLite source package for Windows. In version 3.3.7, you need to add the <code class="literal">sqlite3_enable_load_extension</code> and <code class="literal">sqlite3_load_extension</code> symbols to the file before the DLL can be linked properly. In version 3.3.8, the export definition file is missing completely.</p></div></li><li class="listitem"><p>Install the shell to your utility directory as follows:</p><pre class="programlisting">xcopy sqlite3.exe "%UTIL_DIR%\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="building_lua-sqlite3"></a>Building lua-sqlite3</h2></div></div></div><p>Michael Roth has written a two-layer Lua binding to SQLite3. One layer, the backend, is written in C and serves as a <span class="emphasis"><em>thin</em></span> binding to the SQLite API. This binding is thin in the sense that it doesn't add a lot of functionality to what is provided by SQLite. On top of this is the front-end layer. This is written in Lua and provides an interface that uses natural Lua expressions and capabilities. It permits query results to be read in a <code class="literal">for</code> loop, supports coroutines, and allows handlers to augment database operations.<a id="IDX-CHP-12-0121" class="indexterm"></a></p><p>Download <code class="literal">lua-sqlite3-0.4.1.tar.bz2</code> from the LuaForge site to the location where you will build it.<a id="IDX-CHP-12-0122" class="indexterm"></a><a id="IDX-CHP-12-0123" class="indexterm"></a><a id="IDX-CHP-12-0124" class="indexterm"></a></p><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_lua-sqlite3_on_unix-like_system"></a>Building lua-sqlite3 on Unix-Like Systems</h3></div></div></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the source package as follows:</p><pre class="programlisting">tar xjvf lua-sqlite3-0.4.1.tar.bz2</pre></li><li class="listitem"><p>Drop into the source directory like this:<a id="IDX-CHP-12-0125" class="indexterm"></a><a id="IDX-CHP-12-0126" class="indexterm"></a></p><pre class="programlisting">cd lua-sqlite3-0.4.1</pre></li><li class="listitem"><p>Configure the build process as follows:</p><pre class="programlisting">./configure</pre></li><li class="listitem"><p>Compile the shared library as follows:</p><pre class="programlisting">make</pre></li><li class="listitem"><p>Open the file <code class="literal">libluasqlite3-loader.lua</code> with a text editor, and locate the line that begins with the following:</p><pre class="programlisting">local shared_lib_path =</pre></li><li class="listitem"><p>Modify the line so that it points to the directory where you place Lua shared libraries. For example, if this directory is <code class="literal">/usr/local/lib/lua/5.1</code>, then change the line to the following:</p><pre class="programlisting">local shared_lib_path = "/usr/local/lib/lua/5.1"</pre></li><li class="listitem"><p>Save the file and exit the editor.</p></li><li class="listitem"><p>Install the package as follows:</p><pre class="programlisting">cp *.so $LUA_DIR/
cp libluasqlite3-loader.lua $LUA_DIR/
cp sqlite3.lua $LUA_DIR/</pre></li></ol></div></div><div class="sect3"><div class="titlepage"><div><div><h3 class="title"><a id="building_lua-sqlite3_on_windows"></a>Building lua-sqlite3 on Windows</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Extract the source package as follows:</p><pre class="programlisting">7z x lua-sqlite3-0.4.1.tar.bz2
7z x lua-sqlite3-0.4.1.tar
del lua-sqlite3-0.4.1.tar</pre></li><li class="listitem"><p>Make the source directory the default working directory like this:</p><pre class="programlisting">cd lua-sqlite3-0.4.1</pre></li><li class="listitem"><p>Compile the dynamic-link library as follows:</p><pre class="programlisting">cl /c /Zl /Zd /Yd /MD /DWIN32 libluasqlite3.c

link /dll /base:0x67A00000 /machine:ix86 /export:luaopen_sqlite3 <div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U002.png" alt="Building lua-sqlite3 on Windows" width="12" height="12"></div>
libluasqlite3.obj lua5.1.lib msvcrt.lib sqlite3.lib</pre></li><li class="listitem"><p>Create a new file with the following contents. If the directory in which you place your Lua bindings is different from that shown, make the appropriate change.</p><div class="blockquote"><blockquote class="blockquote"><p>The value of <code class="literal">LibStr</code> is quoted using double brackets to ensure that the Microsoft-style path delimiters are treated literally.</p></blockquote></div><pre class="programlisting">local LibStr = [[c:\program files\lua\5.1\libluasqlite3.dll]]
load_libluasqlite3 = assert(package.loadlib(LibStr, "luaopen_sqlite3"))</pre></li><li class="listitem"><p>Save this file as <code class="literal">libluasqlite3-loader.lua</code>.</p></li><li class="listitem"><p>Install the package as follows:</p><pre class="programlisting">xcopy *.dll "%LUA_DIR%\*.*"
xcopy libluasqlite3-loader.lua "%LUA_DIR%\*.*"
xcopy sqlite3.lua "%LUA_DIR%\*.*"</pre></li></ol></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="using_lua-sqlite3"></a>Using lua-sqlite3</h2></div></div></div><p>The documentation for <code class="literal">lua-sqlite3</code> is named <code class="literal">documentation.html</code> and is located in the main directory of the source package. The documentation for SQLite, found at <code class="literal"><code class="systemitem">www.sqlite.org</code></code>, is a very helpful source of information. Its pages on SQL language support, keywords, and <span class="emphasis"><em>pragmas</em></span> provide a good introduction to using this database library. Pragmas are SQLite-specific commands that allow you to examine the details of a database and control the way SQLite operates.<a id="IDX-CHP-12-0127" class="indexterm"></a></p><p>If you are new to SQLite and <code class="literal">lua-sqlite3</code>, you'll find it helpful to initially include the <code class="literal">show</code> module that was developed in <a class="link" href="ch07.html" title="Chapter 7. Using Modules">Chapter 7</a> in your scripts. The <code class="literal">ObjectShow</code> function can give you a thorough view of a function's return value. This can help you get your bearings when looking at query results.</p><div class="sidebar"><a id="try_it_out_colon_providing_a_database_st"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Providing a Database Standard Deviation Function</strong></p></div></div></div><p>The <code class="literal">lua-sqlite3</code> library lets you write functions that can be called from within SQL commands, including an <span class="emphasis"><em>aggregate</em></span> function that returns one value for an entire series of database rows. The way that an aggregate function is registered to <code class="literal">lua-sqlite3</code> is elegant Lua. You register a function that itself returns two functions: a row-by-row function and a wrapup function. The advantage of this is that any variables that need to be shared between the two generated functions can do so by means of upvalues. This limits the scope of these variables to exactly the parties that need to access them.<a id="IDX-CHP-12-0128" class="indexterm"></a></p><p>As of version 3.3.6, SQLite doesn't have a built-in function to calculate the standard deviation of a series of numbers. This example fills that gap.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Copy the following script to a file named <code class="literal">sqlstddev.lua</code>:</p><pre class="programlisting">require "sqlite3"

local Cn = {}
Cn.DbStr = "test.db"
Cn.InitStr = [[
  BEGIN TRANSACTION;
  DROP TABLE IF EXISTS T3;
  CREATE TABLE T3(A);
  INSERT INTO T3 VALUES (12);
  INSERT INTO T3 VALUES (27);
  INSERT INTO T3 VALUES (32);
  INSERT INTO T3 VALUES (91);
  INSERT INTO T3 VALUES (79);
  INSERT INTO T3 VALUES (66);
  INSERT INTO T3 VALUES (40);
  INSERT INTO T3 VALUES ( 5);
  INSERT INTO T3 VALUES (53);
  END TRANSACTION;
]]</pre><pre class="programlisting">local function LclStdDev()
  local Sum, List = 0, {}

  local function LclStep(Val)
    if type(Val) == "number" then
      table.insert(List, Val)
      Sum = Sum + Val
    end
  end

  local function LclFinal(Count)
    local StdDev = 0
    Count = #List
    if Count &gt; 1 then
      local SumDevSq = 0
      local Mean = Sum / Count
      for J, Val in ipairs(List) do
        local Dev = Val - Mean
        SumDevSq = SumDevSq + Dev * Dev
      end
      StdDev = math.sqrt(SumDevSq / (Count - 1))
    end
    return StdDev
  end

  return LclStep, LclFinal
end

local DbHnd, ErrStr = sqlite3.open(Cn.DbStr)
if DbHnd then
  if DbHnd:exec(Cn.InitStr) then
    DbHnd:set_aggregate("stddev", 1, LclStdDev)
    print(DbHnd:first_cols("SELECT STDDEV(A) FROM T3"))
  else
    io.write("Error initializing ", Cn.DbStr, "\n")
  end
  DbHnd:close()
else
  io.write("Error opening ", Cn.DbStr, ": ", tostring(ErrStr), "\n")
end</pre></li><li class="listitem"><p>Run the script as follows:</p><pre class="programlisting">lua sqlstddev.lua</pre><p>This displays the following standard deviation:</p><pre class="programlisting">29.546573405388</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p>This script initializes a table in the <code class="literal">test.db</code> database file. The file is created if it doesn't already exist. The T3 table is created, or effectively overwritten if it already exists, and is populated with a series of numbers.</p><p>The <code class="literal">LclStdDev</code> function is the <span class="emphasis"><em>factory</em></span> function that produces the row-by-row function (<code class="literal">LclStep</code>) and the wrapup function (<code class="literal">LclFinal</code>). These two closures share a Lua table that holds each value submitted to <code class="literal">LclStep</code>. Also shared is a variable that holds the running sum of the values.</p><p>When all rows have been visited, the wrapup function is called. Here, the mean is calculated and, for each value in the series, the square of the deviation from this mean is summed. The variance is calculated by dividing this sum by the degrees of freedom in the sample. Finally, the square root of the variance, the standard deviation, is calculated and returned.</p><p>The <code class="literal">set_aggregate</code> method is used to register the aggregate function with the database instance. The first argument is the name of the function to be used case-insensitively in a query. The next argument specifies the number of arguments the row-by-row function is to be called with. The last argument is the factory function that generates the two closures. This function is not called with any arguments.</p><p>User functions can extend SQLite in many useful ways. If you find that you use certain extensions frequently, you can modularize them to promote their reusability and limit their scope. In this case, only a registration function that receives an open database handle need be exported from the module; everything else could be hidden inside it. The module would include the <code class="literal">LclStdDev</code> function and a line like the following, which registers the function with the specified database handle:</p><pre class="programlisting">DbHnd:set_aggregate("stddev", 1, LclStdDev)</pre></div></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="summary-035"></a>Summary</h1></div></div></div><p>In this chapter, you learned about interfacing Lua with open source libraries. These libraries can be categorized as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Libraries that have nothing to do with Lua and everything to do with a particular functionality, such as the cURL, SQLite, and gd libraries.</p></li><li class="listitem"><p>Libraries that provide a binding between Lua and another library, such as the <code class="literal">luacurl, lua-sqlite3</code>, and <code class="literal">lua-gd</code> libraries.</p></li><li class="listitem"><p>Libraries that combine functionality with a Lua interface, such as the <code class="literal">pack</code> library.</p></li></ul></div><p>You saw how a binding can expose a library's C API closely or, at the other end of the spectrum, through a layer of expressive Lua mechanisms such as iterators and objects.</p><p>By compiling and installing a small cross-section of libraries, you learned some techniques that can be applied to a large number of other open source libraries. Try your hand at the exercises that follow to stretch these techniques a bit.</p><p>If learning about how Lua can be extended with community libraries has stirred an interest in writing your own extensions in C, the next chapter will provide an introduction.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-036"></a>Exercises</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>The <code class="literal">lua-sqlite3</code> binding lets you register a function, including one that can receive multiple arguments that can be called within a database query. Use this feature to provide a format function for SQLite results. Name the function <code class="literal">format</code>. It should receive a format string followed by a variable number of arguments to be formatted, very much like <code class="literal">string.format</code> (hint, hint). And just like <code class="literal">string.format</code> (hint, hint), it should return one value, the formatted string. An example of its usage is as follows:</p><pre class="programlisting">print(DbHnd:first_cols("SELECT FORMAT('%05d %05d', 12, 34)"))</pre><p>This should return the following:</p><pre class="programlisting">00012 00034</pre><p>The example shows <code class="literal">FORMAT</code> receiving fixed arguments, but ordinary database expressions are supported too. Note that the second argument to the <code class="literal">set_function</code> method can be −1 to indicate that the registered function can receive multiple arguments.</p></li><li class="listitem"><p>A PNG image file is made up of a signature string followed by a <span class="emphasis"><em>chunk</em></span>, which is a variable length data structure that follows a relatively simple format. All numbers in a PNG file are big-endian. The signature is made up of the following eight bytes, shown here in decimal:</p><pre class="programlisting">137, 80, 78, 71, 13, 10, 26, 10</pre><p>The <code class="literal">string.char</code> function is useful for constructing strings from lists like this one.</p><p>Each chunk has the following layout:</p><pre class="programlisting">Data length: unsigned long integer
Chunk header: four character string
Data: &lt;Data length&gt; bytes
CRC: unsigned long integer</pre></li></ol></div><p><span class="emphasis"><em>CRC</em></span> stands for Cyclic Redundancy Check, a standard hash checksum of data. In this case, it covers the chunk header and data, but not the data length field.</p><p>Chunks can come in any order, except that chunks with the IHDR and IEND headers are first and last respectively.</p><p>Write a script that steps through each chunk of a PNG file and prints a listing that shows the header, data length and CRC values. A chunk summary for the Lua logo that was constructed in the <code class="literal">gd</code> library discussion looks like this:</p><pre class="programlisting">Header Length CRC
------ ------ ----------
IHDR       13 0xD3103F31
IDAT     4867 0xF5459E04
IEND        0 0xAE426082</pre><p>Remember to open the PNG file in binary mode to prevent problems on Windows.</p><p>Because the data length field does not immediately precede the data field, you will need to make two calls to <code class="literal">string.unpack</code> for every chunk. The first will pick up the chunk's data length and header fields, and the second will pick up the CRC field. You don't need to read the data field for the purposes of this exercise.</p></div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="ch11.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">11. Exploring Lua&#39;s Libraries</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="ch13.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">13. Interfacing Lua with Other Languages</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag">
        
        

        
          <p>You have 6 days left in your trial, Michaelschiner. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="ch12.html#" class="icon-up" onclick="window.Appcues.track('JumpTop_HeronBook')"><div class="visuallyhidden">Back to top</div></a>
  <ul class='js-footer-nav'>
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">&#169; 2021 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="https://learning.oreilly.com/jsi18n/web/" charset="utf-8"></script>
    <script src="https://learning.oreilly.com/library/jsi18n/appcache/" charset="utf-8"></script>
  </body>
</html>
