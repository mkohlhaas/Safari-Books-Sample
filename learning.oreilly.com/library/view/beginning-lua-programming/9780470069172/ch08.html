<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch08.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch08.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/beginning-lua-programming/9780470069172/ch08.html"
data-csrf-cookie="csrfsafari"


  data-user-id="11366403"
  data-user-uuid="ce47de5b-ce80-49f0-b5cd-c60d3d33b198"
  data-username="michaelschiner"
  data-account-type="Trial"
  
  data-activated-trial-date="05/13/2021"


  data-archive="9780470069172"
  data-publishers="Wrox"



  data-htmlfile-name="ch08.html"
  data-epub-title="Beginning Lua Programming" data-debug=0 data-testing=0><!--<![endif]--><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="author" content="O'Reilly Media" /><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780470069172"/><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico" /><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"/><meta property="twitter:account_id" content="4503599627559754" /><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic' rel='stylesheet' type='text/css'><title>8. Extending Lua&#39;s Behavior with Metamethods - Beginning Lua Programming</title><link rel="stylesheet" href="https://learning.oreilly.com/static/CACHE/css/output.5bdb4fcb2aad.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book"></style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780470069172/chapter/ch08.html",
          "book_id": "9780470069172",
          "chapter_uri": "ch08.html",
          "position": 0,
          "user_uuid": "ce47de5b-ce80-49f0-b5cd-c60d3d33b198",
          "next_chapter_uri": "/library/view/beginning-lua-programming/9780470069172/ch09.html"
        
      },
      title: "Beginning Lua Programming",
      author_list: "Aaron Brown, Kurt Jung",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="https://learning.oreilly.com/static/js/src/modernizr.8e35451ddb64.js"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
        }
      };
  </script><link rel="canonical" href="ch08.html"/><meta name="description" content="Chapter 8. Extending Lua&#39;s Behavior with Metamethods You use metatables and metamethods mainly to create what can, loosely speaking, be described as user-defined types. For example, if you have defined ... "><meta property="og:title" content="8. Extending Lua&#39;s Behavior with Metamethods" /><meta itemprop="isPartOf" content="/library/view/beginning-lua-programming/9780470069172/" /><meta itemprop="name" content="8. Extending Lua&#39;s Behavior with Metamethods" /><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch08.html" /><meta property="og:site_name" content="Safari" /><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780470069172/" /><meta property="og:description" itemprop="description" content="Chapter 8. Extending Lua&#39;s Behavior with Metamethods You use metatables and metamethods mainly to create what can, loosely speaking, be described as user-defined types. For example, if you have defined ... "><meta itemprop="inLanguage" content="en" /><meta itemprop="publisher" content="Wrox" /><meta property="og:type" content="book" /><meta property="og:book:isbn" itemprop="isbn" content="9780470069172" /><meta property="og:book:author" itemprop="author" content="Aaron Brown" /><meta property="og:book:author" itemprop="author" content="Kurt Jung" /><meta property="og:book:tag" itemprop="about" content="Core Programming" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; URL=https://learning.oreilly.com/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198';
      dataLayer.push({userIdentifier: 'ce47de5b-ce80-49f0-b5cd-c60d3d33b198'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '29964b7b-68d8-4532-9a9b-32e089689c1f';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer src="https://learning.oreilly.com/static/js/build/vendor.0eac897f11ed.js"></script><script defer src="https://learning.oreilly.com/static/js/build/reader.c745ea9296ac.js"></script></head>


<body class="reading sidenav nav-collapsed  scalefonts">

    
  <noscript> 
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="ch08.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z" /></svg><span>Home</span></a></li><li class="search"><a href="ch08.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"/></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="ch08.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"/></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a
                href="ch08.html#"
                class="l1 nav-icn "
                
              ><?xml version="1.0" encoding="UTF-8"?><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O&#39;Reilly</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/profile/"
                    class="l2 nav-icn"
                    
                  ><span>Profile</span></a></li><li><a
                    href="https://learning.oreilly.com/history/"
                    class="l2 nav-icn"
                    
                  ><span>History</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/"
                    class="l2 nav-icn"
                    
                  ><span>Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/u/ce47de5b-ce80-49f0-b5cd-c60d3d33b198/"
                    class="l2 nav-icn"
                    
                  ><span>Highlights</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/answers/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"/></svg><span>Answers</span></a></li><li class="flyout-parent"><a
                href="ch08.html#"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"/></g></svg><span>Explore</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/topics/"
                    class="l2 nav-icn"
                    
                  ><span>All Topics</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert"
                    class="l2 nav-icn"
                    
                  ><span>Most Popular Titles</span></a></li><li><a
                    href="https://learning.oreilly.com/recommendations/"
                    class="l2 nav-icn"
                    
                  ><span>Recommended</span></a></li><li><a
                    href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0"
                    class="l2 nav-icn"
                    
                  ><span>Early Releases</span></a></li><li><a
                    href="https://learning.oreilly.com/playlists/discover/"
                    class="l2 nav-icn"
                    
                  ><span>Shared Playlists</span></a></li><li><a
                    href="https://learning.oreilly.com/resource-centers/"
                    class="l2 nav-icn"
                    
                  ><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch08.html#"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z" /></svg><span>Live Events</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/attend/"
                    class="l2 nav-icn"
                    
                  ><span>All Events</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/architectural-katas/"
                    class="l2 nav-icn"
                    
                  ><span>Architectural Katas</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/ai/"
                    class="l2 nav-icn"
                    
                  ><span>AI &amp; ML</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/strata/"
                    class="l2 nav-icn"
                    
                  ><span>Data Sci &amp; Eng</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/oscon/"
                    class="l2 nav-icn"
                    
                  ><span>Programming</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/infrastructure-ops/"
                    class="l2 nav-icn"
                    
                  ><span>Infra &amp; Ops</span></a></li><li><a
                    href="https://learning.oreilly.com/featured/software-architecture/"
                    class="l2 nav-icn"
                    
                  ><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a
                href="ch08.html#"
                class="l1 nav-icn "
                
              ><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interactive</span></a><ul class="flyout"><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=content-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Scenarios</span></a></li><li><a
                    href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario"
                    class="l2 nav-icn"
                    
                  ><span>Sandboxes</span></a></li><li><a
                    href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook"
                    class="l2 nav-icn"
                    
                  ><span>Jupyter Notebooks</span></a></li></ul></li><li ><a
                href="https://learning.oreilly.com/certifications/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"/></svg><span>Certifications</span></a></li><li ><a
                href="https://learning.oreilly.com/preferences/"
                class="l1 nav-icn "
                
              ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"/></g></svg><span>Settings</span></a></li><li ><a
                href="https://learning.oreilly.com/public/support/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z" /></svg><span>Support</span></a></li><li ><a
                href="https://get.oreilly.com/email-signup.html"
                class="l1 nav-icn "
                target=&quot;_blank&quot;
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z" /></svg><span>Newsletters</span></a></li><li ><a
                href="https://learning.oreilly.com/accounts/logout/"
                class="l1 nav-icn "
                
              ><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z" /></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="ch08.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Beginning Lua Programming
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="ch08.html#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track('SearchBook_HeronBook')"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780470069172/chapter/ch08.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track('AddPlaylist_HeronBook')"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="ch08.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track('ChangeFont_HeronBook')"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="ch08.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track('Share_HeronBook')"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a
        class="twitter share-button t-twitter"
        target="_blank"
        aria-label="Share this section on Twitter"
        title="Share this section on Twitter"
      
        href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch08.html&text=Beginning%20Lua%20Programming&via=OReillyMedia"
      ><span>Twitter</span></a></li><li><a
        class="facebook share-button t-facebook"
        target="_blank"
        aria-label="Share this section on Facebook"
        title="Share this section on Facebook"
        href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch08.html"
      ><span>Facebook</span></a></li><li><a
        class="googleplus share-button t-googleplus"
        target="_blank"
        aria-label="Share this secton on Google Plus"
        title="Share this secton on Google Plus"
        href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch08.html"
      ><span>Google Plus</span></a></li><li><a
        class="email share-button t-email"
        aria-label="Share this section via email"
        title="Share this section via email"
      
        href="mailto:?subject=Safari: 8.%20Extending%20Lua%27s%20Behavior%20with%20Metamethods&body=https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/ch08.html%0D%0Afrom Beginning%20Lua%20Programming%0D%0A"
      ><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer src="https://learning.oreilly.com/static/js/build/djangoMessagesPage.bfaca9fd8619.js"></script>


        <script src="https://fast.appcues.com/48743.js"></script>
<script>
  var userId = "ce47de5b-ce80-49f0-b5cd-c60d3d33b198";

  var userObject = {
    firstName: "Michael",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2021-05-13",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Using Modules</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. Handling Events Naturally with Coroutines</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="extending_lua_apostrophy_s_behavior_with"></a>Chapter 8. Extending Lua's Behavior with Metamethods</h1></div></div></div><p>You use metatables and metamethods mainly to create what can, loosely speaking, be described as user-defined types. For example, if you have defined a table that represents a number-like value, metamethods let you use arithmetical operators with it as though it really were a number. In this chapter, you learn how to do the following:<a id="IDX-CHP-8-0001" class="indexterm"></a><a id="IDX-CHP-8-0002" class="indexterm"></a><a id="IDX-CHP-8-0003" class="indexterm"></a><a id="IDX-CHP-8-0004" class="indexterm"></a><a id="IDX-CHP-8-0005" class="indexterm"></a><a id="IDX-CHP-8-0006" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Use operators with types that they normally don't work with</p></li><li class="listitem"><p>Control what happens when a table is indexed or a table field is assigned to</p></li><li class="listitem"><p>Customize how a value is converted to a string</p></li></ul></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="using_concatenation_and_arithmetical_ope"></a>Using Concatenation and Arithmetical Operators on Tables</h1></div></div></div><p>If you use tables as operands to the concatenation operator, you get the following error:</p><pre class="programlisting">&gt; <strong class="userinput"><code>A, B = {}, {}</code></strong>
&gt; <strong class="userinput"><code>print(A .. B)</code></strong>
 stdin:1: attempt to concatenate global 'A' (a table value)
 stack traceback:
         stdin:1: in main chunk
         [C]: ?</pre><p>There's a way to override this, though, so the concatenation operator is handled by a function that you define.</p><div class="sidebar"><a id="try_it_out_colon_splicing_two_arrays_wit"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Splicing Two Arrays with the Concatenation Operator</strong></p></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Define the function <code class="literal">MakeSpliceArr</code> and its upvalue <code class="literal">SpliceMeta</code> as follows (notice that <code class="literal">SpliceMeta</code>'s field <code class="literal">__concat</code> starts with two underscores):<a id="IDX-CHP-8-0007" class="indexterm"></a><a id="IDX-CHP-8-0008" class="indexterm"></a><a id="IDX-CHP-8-0009" class="indexterm"></a></p><pre class="programlisting">do
   local SpliceMeta -- SpliceMeta needs to be in
     -- SpliceMeta.__concat's scope.
   SpliceMeta = {
     -- Makes a new array by splicing two arrays together:
     __concat = function(ArrA, ArrB)
       assert(type(ArrA) == "table" and type(ArrB) == "table")
       local Ret = setmetatable({}, SpliceMeta)
       for I, Elem in ipairs(ArrA) do
         Ret[I] = Elem
       end
       local LenA = #ArrA
       for I, Elem in ipairs(ArrB) do
         Ret[LenA + I] = Elem
       end
       return Ret
     end}

   -- Takes an array, returns that array after giving it a
   -- metamethod that makes it "spliceable" with the
   -- concatenation operator:
   function MakeSpliceArr(Arr)
     return setmetatable(Arr, SpliceMeta)
   end
 end</pre></li><li class="listitem"><p>Use it to make two spliceable arrays:</p><pre class="programlisting">-- Note -- curly braces, not parentheses:
 A = MakeSpliceArr{"alpha", "bravo", "charlie"}
 B = MakeSpliceArr{"x-ray", "yankee", "zulu"}</pre></li><li class="listitem"><p>Concatenate them and look at the result:</p><pre class="programlisting">C = A .. B
 for I, Elem in ipairs(C) do
   print(I, Elem)
 end</pre><p>You should see the following:</p><pre class="programlisting">1  alpha
 2  bravo
 3  charlie
 4  x-ray
 5  yankee
 6  zulu</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span><a id="IDX-CHP-8-0010" class="indexterm"></a><a id="IDX-CHP-8-0011" class="indexterm"></a></p><p>Every table in Lua (actually every value, but more on that later) can have something called a <span class="emphasis"><em>metatable</em></span>. By default, a table does not have a metatable. The built-in <code class="literal">setmetatable</code> function gives its first argument a metatable (its second argument), and then returns the first argument. Using <code class="literal">setmetatable</code>, the <code class="literal">MakeSpliceArr</code> function sets the <code class="literal">SpliceMeta</code> table as the metatable of the array given to it:</p><pre class="programlisting">function MakeSpliceArr(Arr)
   return setmetatable(Arr, SpliceMeta)
 end</pre><p><code class="literal">A</code> and <code class="literal">B</code> therefore both have the same metatable. When Lua sees you concatenating <code class="literal">A</code> and <code class="literal">B</code>, it checks to see if they are both strings or numbers. Because they aren't, normal string concatenation can't be done, so it looks to see if the first operand has a metatable, and if that metatable has a field called <code class="literal">__concat</code> (two underscores), and if that field contains a function. Because this all checks out, it calls <code class="literal">__concat</code> with the first and second operands as arguments, and uses <code class="literal">__concat</code>'s result as the result of the <code class="literal">..</code> operator.</p><p>A metatable's <code class="literal">__concat</code> field is an example of a <span class="emphasis"><em>metamethod</em></span>.</p><p>The <code class="literal">__concat</code> function defined in the example splices the two arrays given to it, creating a new array that has all elements of the first, then the second array, in order. This new array is given the <code class="literal">SpliceMeta</code> metatable, so that it will have the same behavior with the concatenation operator:<a id="IDX-CHP-8-0012" class="indexterm"></a><a id="IDX-CHP-8-0013" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>for I, Elem in ipairs(C .. C) do</code></strong>
&gt;&gt;   <strong class="userinput"><code>print(I, Elem)</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
1      alpha
2      bravo
3      charlie
4      x-ray
5      yankee
6      zulu
7      alpha
8      bravo
9      charlie
10     x-ray
11     yankee
12     zulu</pre><p>This is why <code class="literal">local SpliceMeta</code> and the assignment of the table to <code class="literal">SpliceMeta</code> are separated into two statements. If they were one statement, then <code class="literal">SpliceMeta</code>'s scope wouldn't begin until the next statement, and the <code class="literal">SpliceMeta</code> used inside <code class="literal">__concat</code> would be global.</p></div><p>Because the first operand's <code class="literal">__concat</code> metamethod is used if it has one, the second operand doesn't have to have one. For example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>for I, Elem in ipairs(A .. {"delta", "echo", "foxtrot"}) do</code></strong>
&gt;&gt;   <strong class="userinput"><code>print(I, Elem)</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
1      alpha
2      bravo
3      charlie</pre><pre class="programlisting">4      delta
5      echo
6      foxtrot</pre><p>If the first operand has no <code class="literal">__concat</code> metamethod but the second one does, then that metamethod is used (but the left operand is still the metamethod's first argument), as follows:</p><pre class="programlisting">&gt; <strong class="userinput"><code>for I, Elem in ipairs({"uniform", "victor", "whiskey"} .. B) do</code></strong>
&gt;&gt;   <strong class="userinput"><code>print(I, Elem)</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
1      uniform
2      victor
3      whiskey
4      x-ray
5      yankee
6      zulu</pre><p>Only if neither operand has a <code class="literal">__concat</code> metamethod do you get an error for attempting to concatenate a table.</p><p>If more than two tables are concatenated, then (assuming no parentheses are used) at least one of the last two has to have a <code class="literal">__concat</code> metamethod. This works because <code class="literal">SpliceMeta.__concat</code>'s result itself has a <code class="literal">__concat</code> metamethod. It depends on the last two operands rather than the first two because concatenation is right associative. Here's an example of multiple concatenated tables:</p><pre class="programlisting">&gt; <strong class="userinput"><code>A, B, C, D = {"a"}, {"b"}, {"c"}, {"d"}</code></strong>
&gt; <strong class="userinput"><code>Test = MakeSpliceArr(A) .. B .. C .. D</code></strong>
stdin:1: attempt to concatenate global 'C' (a table value)
stack traceback:
        stdin:1: in main chunk
        [C]: ?
&gt; <strong class="userinput"><code>Test = A .. MakeSpliceArr(B) .. C .. D</code></strong>
stdin:1: attempt to concatenate global 'C' (a table value)
stack traceback:
        stdin:1: in main chunk
        [C]: ?
&gt; <strong class="userinput"><code>Test = A .. B .. MakeSpliceArr(C) .. D</code></strong>
&gt; <strong class="userinput"><code>Test = A .. B .. C .. MakeSpliceArr(D)</code></strong></pre><p>To take away a value's metatable, give <code class="literal">setmetatable</code> a second argument of <code class="literal">nil</code>:</p><pre class="programlisting">&gt; <strong class="userinput"><code>A = MakeSpliceArr{"alpha", "bravo", "charlie"}</code></strong>
&gt; <strong class="userinput"><code>setmetatable(A, nil)</code></strong>
&gt; <strong class="userinput"><code>A2 = A .. A</code></strong>
stdin:1: attempt to concatenate global 'A' (a table value)
stack traceback:
        stdin:1: in main chunk</pre><p>To retrieve a value's metatable, use <code class="literal">getmetatable</code> (it returns <code class="literal">nil</code> if its argument has no metatable):</p><pre class="programlisting">&gt; <strong class="userinput"><code>A = MakeSpliceArr{"alpha", "bravo", "charlie"}</code></strong>
&gt; <strong class="userinput"><code>SpliceMeta = getmetatable(A)</code></strong>
&gt; <strong class="userinput"><code>for K, V in pairs(SpliceMeta) do print(K, V) end</code></strong>
__concat        function: 0x807ce78</pre><p>Don't make the terminological mistake of saying that a table <span class="emphasis"><em>is</em></span> a metatable when you mean that it <span class="emphasis"><em>has</em></span> a metatable. (For example, <code class="literal">MakeSpliceArr</code> does not return a metatable—it returns a table that has a metatable.) A table and its metatable are generally two different tables, though there's nothing preventing a table from having itself as a metatable.<a id="IDX-CHP-8-0014" class="indexterm"></a></p><p>There are metamethods for all of Lua's operators except the Boolean ones (<code class="literal">and, or</code>, and <code class="literal">not</code>). In the next Try It Out, you use arithmetical metamethods to define a simple implementation of <span class="emphasis"><em>rational</em></span> numbers. Unlike the floating-point numbers that Lua normally uses, rational numbers can represent quantities like <span class="emphasis"><em>f</em></span>⅓ and <span class="emphasis"><em>f</em></span>⅕ with perfect accuracy.</p><div class="sidebar"><a id="try_it_out_colon_defining_rational_numbe"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Defining Rational Numbers</strong></p></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following as <code class="literal">rational.lua</code>:</p><pre class="programlisting">-- A basic rational number implementation.

 -- Returns A and B's greatest common divisor:
 local function GetGcd(A, B)
   local Remainder = A % B
   return Remainder == 0 and B or GetGcd(B, Remainder)
 end

 -- Metamethods:

 local function Add(A, B)
   return MakeRat(A.Numer * B.Denom + B.Numer * A.Denom,
    A.Denom * B.Denom)
 end


 local function Sub(A, B)
   return A + -B
 end

 local function Mul(A, B)
   return MakeRat(A.Numer * B.Numer, A.Denom * B.Denom)
 end

 local function Div(A, B)
   assert(B.Numer ~= 0, "Divison by zero")
   return A * MakeRat(B.Denom, B.Numer)
 end

 local function Unm(A)
   return MakeRat(-A.Numer, A.Denom)
 end

 local function ToString(Rat)
   return Rat.Numer .. "/" .. Rat.Denom
 end

 local RatMeta = {
   __add = Add,
   __sub = Sub,
   __mul = Mul,</pre><pre class="programlisting">__div = Div,
   __unm = Unm,
   __tostring = ToString,
 }

 -- The three global functions supplied by this library:

 -- Instantiates a rational number:
 function MakeRat(Numer, Denom)
   Numer, Denom = tonumber(Numer), tonumber(Denom)
   assert(Denom ~= 0, "Denominator must be nonzero")
   assert(Numer == math.floor(Numer) and Denom == math.floor(Denom),
     "Numerator and denominator must be integers")
  -- Make sure the denominator is positive:
  if Denom &lt; 0 then
    Numer, Denom = -Numer, -Denom
  end
  -- Reduce the fraction to its lowest terms:
  local Gcd = GetGcd(Numer, Denom)
  local Rat = {
    Numer = Numer / Gcd,
    Denom = Denom / Gcd}
  return setmetatable(Rat, RatMeta)
end

  -- Instantiates a rational number from a string of the form
  -- "numerator/denominator":
  function r(Str)
    local Numer, Denom = string.match(Str, "^(%-?%d+)%/(%-?%d+)$")
    assert(Numer, "Couldn't parse rational number")
    return MakeRat(Numer, Denom)
  end

  -- Converts a rational to a (floating-point) number:
  function RatToNumber(Rat)
    return Rat.Numer / Rat.Denom
  end</pre></li><li class="listitem"><p>Require the file and multiply two rational numbers:</p><pre class="programlisting">&gt; <strong class="userinput"><code>require("rational")</code></strong>
&gt; <strong class="userinput"><code>print(r"2/3" * r"1/10")</code></strong>
1/15</pre></li><li class="listitem"><p>Add the floating-point approximation of <span class="emphasis"><em>f⅓</em></span> to itself 300000 times:</p><pre class="programlisting">&gt; <strong class="userinput"><code>FloatAcc = 0</code></strong>
&gt; <strong class="userinput"><code>for I = 1, 300000 do</code></strong>
&gt;&gt;   <strong class="userinput"><code>FloatAcc = FloatAcc + 1 / 3</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
&gt; <strong class="userinput"><code>print(FloatAcc)</code></strong>
99999.999999689</pre></li><li class="listitem"><p>Add the rational number <span class="emphasis"><em>f</em></span>⅓ to itself 300000 times:<a id="IDX-CHP-8-0015" class="indexterm"></a><a id="IDX-CHP-8-0016" class="indexterm"></a><a id="IDX-CHP-8-0017" class="indexterm"></a><a id="IDX-CHP-8-0018" class="indexterm"></a><a id="IDX-CHP-8-0019" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>RatAcc = r"0/1"</code></strong>
&gt; <strong class="userinput"><code>OneThird = r"1/3"</code></strong>
&gt; <strong class="userinput"><code>for I = 1, 300000 do</code></strong>
&gt;&gt;   <strong class="userinput"><code>RatAcc = RatAcc + OneThird</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
&gt; <strong class="userinput"><code>print(RatAcc)</code></strong>
100000/1</pre></li><li class="listitem"><p>Verify that the result is exactly 100000:</p><pre class="programlisting">&gt; <strong class="userinput"><code>print(RatToNumber(RatAcc) == 100000)</code></strong>
true</pre></li><li class="listitem"><p>Print the rational number <span class="emphasis"><em>f</em></span></p><div><img src="https://learning.oreilly.com/library/view/beginning-lua-programming/9780470069172/figs/U0801.png" alt="Try It Out: Defining Rational Numbers" width="26" height="14"></div><pre class="programlisting">&gt; <strong class="userinput"><code>Rat = r"15/100"</code></strong>
<strong class="userinput"><code>&gt; print(Rat) -- Will be reduced to lowest terms</code></strong>.</pre></li><li class="listitem"><p>Print the negative version of the previous rational number:</p><pre class="programlisting">&gt; <strong class="userinput"><code>print(-Rat)</code></strong>
-3/20</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p>A rational number is just a fraction—a numerator over a denominator. It is represented as a table with <code class="literal">Numer</code> and <code class="literal">Denom</code> fields and a metatable with <code class="literal">__add</code> (addition), <code class="literal">__sub</code> (subtraction), <code class="literal">__mul</code> (multiplication), <code class="literal">__div</code> (division), and <code class="literal">__unm</code> (unary minus) metamethods. (Like <code class="literal">__concat</code>, these and all other metamethods start with two underscores.)</p><p>In the following part of the Try It Out, <code class="literal">r"2/3"</code> and <code class="literal">r"1/10"</code> create the rational numbers two thirds and one tenth:<a id="IDX-CHP-8-0020" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>print(r"2/3" * r"1/10")</code></strong>
1/15</pre><div class="blockquote"><blockquote class="blockquote"><p>The function is called <code class="literal">r</code> to minimize the typing needed for rational "literals." Remember also that <code class="literal">r"2/3"</code> means the same thing as <code class="literal">r("2/3")</code>.</p></blockquote></div><p>When these two rational numbers are multiplied, what happens is basically the same as what happened in the previous concatenation example: Lua sees that they are tables (rather than numbers), so it looks for a <code class="literal">__mul</code> metamethod, finds one in the left operand, and calls it with both operands as arguments. This metamethod returns the result (one fifteenth). As it does with all values, <code class="literal">print</code> runs this result through <code class="literal">tostring</code>, which sees the <code class="literal">__tostring</code> metamethod and uses it to do the conversion. (More on <code class="literal">__tostring</code> later.)</p><p>The <code class="literal">FloatAcc</code> section of the example initializes an accumulator to <code class="literal">0</code> and increments it 300000 times by the floating-point approximation of <span class="emphasis"><em>f</em></span>⅓. The inaccuracy snowballs, as shown by the final value of <code class="literal">FloatAcc</code>:</p><pre class="programlisting">&gt; <strong class="userinput"><code>FloatAcc = 0</code></strong>
&gt; <strong class="userinput"><code>for I = 1, 300000 do</code></strong>
&gt;&gt;   <strong class="userinput"><code>FloatAcc = FloatAcc + 1 / 3</code></strong></pre><pre class="programlisting">&gt;&gt;   <strong class="userinput"><code>end</code></strong>
&gt; <strong class="userinput"><code>print(FloatAcc)</code></strong>
 99999.999999689</pre><p>The <code class="literal">RatAcc</code> section, on the other hand, shows no loss of accuracy:</p><pre class="programlisting">&gt; <strong class="userinput"><code>RatAcc = r"0/1"</code></strong>
&gt; <strong class="userinput"><code>OneThird = r"1/3"</code></strong>
&gt; <strong class="userinput"><code>for I = 1, 300000 do</code></strong>
&gt;&gt;   <strong class="userinput"><code>RatAcc = RatAcc + OneThird</code></strong>
&gt;&gt; <strong class="userinput"><code>end</code></strong>
&gt; <strong class="userinput"><code>print(RatAcc)</code></strong>
100000/1
&gt; <strong class="userinput"><code>print(RatToNumber(RatAcc) == 100000)</code></strong>
true</pre><p>You may have noticed that the <code class="literal">RatAcc</code> loop took longer to run than the <code class="literal">FloatAcc</code> loop. Floating-point numbers will always be faster than rational numbers because your computer includes dedicated hardware to do floating-point math, but in the interest of simplicity, this rational number library makes no special effort to narrow the speed gap.</p><p>The <code class="literal">__add, __sub, __mul</code>, and <code class="literal">__div</code> metamethods all handle binary operators, so they take two arguments. The <code class="literal">__unm</code> metamethod handles a unary operator, so it takes one argument:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Rat = r"15/100"</code></strong>
&gt; <strong class="userinput"><code>print(Rat) -- Will be reduced to lowest terms</code></strong>.
3/20
&gt; <strong class="userinput"><code>print(-Rat)</code></strong>
-3/20</pre></div><p>The <code class="literal">__pow, __mod</code>, and <code class="literal">__len</code> metamethods define the behavior of the <code class="literal">^</code> (exponentiation), <code class="literal">%</code> (modulo), and <code class="literal">#</code> (length) operators. All of these metamethods (the arithmetical ones, <code class="literal">__concat</code>, and <code class="literal">__len</code>) are not for redefining behavior that already exists, but for adding new behavior. Normally, you can't use a table as an operand to an arithmetical operator or the concatenation operator, so you would use metamethods to define its behavior with these operators. But a table's behavior with the length operator is already defined, so giving a table a <code class="literal">__len</code> metamethod has no effect, as shown here:</p><pre class="programlisting">&gt; <strong class="userinput"><code>T = {"one", "two", "three", [1000] = "one thousand"}</code></strong>
&gt; <strong class="userinput"><code>print(table.maxn(T))</code></strong>
1000
&gt; <strong class="userinput"><code>setmetatable(T, {</code></strong>
&gt;&gt;   <strong class="userinput"><code>__len = function(T) return table.maxn(T) end})</code></strong>
&gt; <strong class="userinput"><code>print(#T)</code></strong>
3</pre><p>Lua does pay attention to a <code class="literal">__len</code> metamethod if it belongs to a value for which the length operator is not already defined (i.e., something other than a table or string). Giving metatables to values other than tables will be covered later in this chapter.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="relational_metamethods"></a>Relational Metamethods</h1></div></div></div><p>You can use metamethods to make rational numbers work with equality and inequality operators (<code class="literal">==</code> and <code class="literal">~=</code>) and other relational operators (<code class="literal">&lt;, &gt;, &lt;=</code>, and <code class="literal">&gt;=</code>). To do this, add appropriate <code class="literal">__eq</code> (equal) and <code class="literal">__lt</code> (less than) metamethods, like this:<a id="IDX-CHP-8-0021" class="indexterm"></a><a id="IDX-CHP-8-0022" class="indexterm"></a></p><pre class="programlisting">local function Unm(A)
   return MakeRat(-A.Numer, A.Denom)
 end

 local function Eq(A, B)
   -- This and Lt work because MakeRat always makes sure the
   -- denominator is positive and reduces to lowest terms:
   return A.Numer == B.Numer and A.Denom == B.Denom
 end

 local function Lt(A, B)
   local Diff = A - B
   return Diff.Numer &lt; 0
 end

 local function ToString(Rat)
   return Rat.Numer .. "/" .. Rat.Denom
 end

 local RatMeta = {
   __add = Add,
   __sub = Sub,
   __mul = Mul,
   __div = Div,
   __unm = Unm,
   __eq = Eq,
   __lt = Lt,
   __tostring = ToString,
 }</pre><div class="blockquote"><blockquote class="blockquote"><p>Remember, to see these changes you'll need to set <code class="literal">package.loaded.rational</code> to <code class="literal">nil</code>, or use <code class="literal">dofile("rational.lua")</code> instead of <code class="literal">require("rational")</code>, or restart Lua.</p></blockquote></div><p>The <code class="literal">__eq</code> (equal) and <code class="literal">__lt</code> (less than) metamethods are enough to define all the relational operators. The inequality operator produces the opposite of the <code class="literal">__eq</code> result, and the greater-than operator produces the <code class="literal">__lt</code> result after swapping the operands. For example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>print(r"20/100" == r"2/10")</code></strong>
true
&gt; <strong class="userinput"><code>print(r"20/100" ~= r"2/10")</code></strong>
false
&gt; <strong class="userinput"><code>print(r"7/16" &lt; r"1/2")</code></strong>
true
&gt; <strong class="userinput"><code>print(r"7/16" &gt; r"1/2")</code></strong>
false</pre><p>The less-than-or-equal and greater-than-or-equal operators are also defined in terms of <code class="literal">__lt</code>——for example, <code class="literal">A &lt;= B</code> is defined as <code class="literal">not (B &lt; A)</code>—<span class="emphasis"><em>unless</em></span> there's an <code class="literal">__le</code> (less than or equal) metamethod. Rational numbers have what mathematicians call a <span class="emphasis"><em>total order</em></span>. This means that if two rational numbers are not equal, then one is less than the other. If you want to compare things for which this is not true, you need to define <code class="literal">__le</code> in addition to <code class="literal">__lt</code>. For example, imagine you're working with values that represent shapes on a two-dimensional surface. A handy interpretation of <code class="literal">&lt;=</code> would be "is contained within," so that <code class="literal">A &lt;= B</code> means "is every point in <code class="literal">A</code> also in <code class="literal">B</code>?" This is not a total order, because if <code class="literal">A</code> contains points not in <code class="literal">B</code> and <code class="literal">B</code> contains points not in <code class="literal">A</code>, then both <code class="literal">A &lt;= B</code> and <code class="literal">B &lt;= A</code> are false. Therefore, such shapes would need <code class="literal">__le</code> (is <code class="literal">A</code> contained in <code class="literal">B</code>), <code class="literal">__lt</code> (is <code class="literal">A</code> contained in <code class="literal">B</code> but not identical with it), and <code class="literal">__eq</code> (is <code class="literal">A</code> identical with <code class="literal">B</code>).<a id="IDX-CHP-8-0023" class="indexterm"></a><a id="IDX-CHP-8-0024" class="indexterm"></a><a id="IDX-CHP-8-0025" class="indexterm"></a></p><p>The <code class="literal">__eq</code> metamethod is only consulted when the values being compared meet all of these criteria:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>They are both tables, or they are both full userdatas (discussed later in this chapter).</p></li><li class="listitem"><p>They are not the same value</p></li><li class="listitem"><p>They have the same <code class="literal">__eq</code> metamethod.</p></li></ul></div><p>If any one of these three conditions is not true, then the values are compared as if they had no <code class="literal">__eq</code> metamethods.</p><p>The <code class="literal">rawequal</code> function does a test for equality that bypasses any <code class="literal">__eq</code> metamethods that may be present. For example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Rat1, Rat2 = r"22/7", r"22/7"</code></strong>
&gt; <strong class="userinput"><code>print(Rat1 == Rat2) -- __eq says they're equal,</code></strong>
true
&gt; <strong class="userinput"><code>print(rawequal(Rat1, Rat2)) -- but they're different tables</code></strong>.
false</pre><p>The <code class="literal">__lt</code> and <code class="literal">__le</code> metamethods are only consulted when the values being compared meet all of these criteria:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>They are the same type.</p></li><li class="listitem"><p>They are neither numbers nor strings.</p></li><li class="listitem"><p>They have the same <code class="literal">__lt</code> (<code class="literal">__le</code>) metamethod.</p></li></ul></div><p>If any one of these three of these conditions is not true, then an error occurs.</p><div class="blockquote"><blockquote class="blockquote"><p>These conditions (for when <code class="literal">__eq, __lt</code>, and <code class="literal">__le</code> are used) are stricter than those for the other operator metamethods because the relational operators themselves are stricter. For example, all of the nonrelational binary operators can, even without metamethods, be used with mixed types (strings and numbers), but using <code class="literal">&lt;, &gt;, &lt;=</code>, or <code class="literal">&gt;=</code> to compare a string and a number is an error.</p></blockquote></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="indexing_and_call_metamethods"></a>Indexing and Call Metamethods</h1></div></div></div><p>There are metamethods that allow you to control what happens when something is indexed, when it is on the left side of an indexing assignment, or when it is called. In the following Try It Out, you use the indexing and indexing assignment metamethods when defining a table that considers two keys the same if they differ only in case.</p><div class="sidebar"><a id="try_it_out_colon_defining_case-insensiti"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Defining Case-Insensitive Tables</strong></p></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Define the <code class="literal">MakeIgnoreCase</code> function, along with its helper functions and metatable, as follows:<a id="IDX-CHP-8-0026" class="indexterm"></a><a id="IDX-CHP-8-0027" class="indexterm"></a></p><pre class="programlisting">do
   -- Returns Val after (if it's a string) lowercasing it:
   local function Lower(Val)
     if type(Val) == "string" then
       Val = string.lower(Val)
     end
     return Val
   end

   local Meta = {
     __newindex = function(Tbl, Key, Val)
       rawset(Tbl, Lower(Key), Val)
     end,
     __index = function(Tbl, Key)
       return rawget(Tbl, Lower(Key))
     end}

  -- Returns a new table with a metatable that makes its
  -- keys case-insensitive:
  function MakeIgnoreCase()
    return setmetatable({}, Meta)
  end
end</pre></li><li class="listitem"><p>Make a case-insensitive table, assign a value to its <code class="literal">abc</code> field, and then verify that the value is accessible from the <code class="literal">ABC, Abc</code>, and <code class="literal">abc</code> fields:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl = MakeIgnoreCase()</code></strong>
&gt; <strong class="userinput"><code>Tbl.abc = 1</code></strong>
&gt; <strong class="userinput"><code>print(Tbl.ABC, Tbl.Abc, Tbl.abc)</code></strong>
1      1      1</pre></li><li class="listitem"><p>Assign a different value to the table's <code class="literal">Abc</code> field, and then verify that the new value is accessible from the <code class="literal">ABC, Abc</code>, and <code class="literal">abc</code> fields:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl.Abc = 2</code></strong>
&gt; <strong class="userinput"><code>print(Tbl.ABC, Tbl.Abc, Tbl.abc)</code></strong>
2      2      2</pre></li><li class="listitem"><p>Assign another value to the table's <code class="literal">ABC</code> field, and then verify that the new value is accessible from the <code class="literal">ABC, Abc</code>, and <code class="literal">abc</code> fields:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl.ABC = 3</code></strong>
&gt; <strong class="userinput"><code>print(Tbl.ABC, Tbl.Abc, Tbl.abc)</code></strong>
3      3      3</pre></li><li class="listitem"><p>Loop through the table, verifying that it only has one field, not three:</p><pre class="programlisting">&gt; <strong class="userinput"><code>for K, V in pairs(Tbl) do print(K, V) end</code></strong>
abc      3</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span><a id="IDX-CHP-8-0028" class="indexterm"></a><a id="IDX-CHP-8-0029" class="indexterm"></a></p><p>The metamethod for indexing assignment (setting a key to a value) is <code class="literal">__newindex</code>. When Lua sees <code class="literal">Tbl.abc = 1</code>, it checks to see whether <code class="literal">Tbl</code> already has an <code class="literal">abc</code> field. It doesn't, but it does have a <code class="literal">__newindex</code> metamethod, so instead of putting the <code class="literal">abc = 1</code> key-value pair directly into <code class="literal">Tbl</code>, Lua calls <code class="literal">__newindex</code> with three arguments: <code class="literal">Tbl</code>, "<code class="literal">abc"</code>, and <code class="literal">1</code>. After making sure that "<code class="literal">abc"</code> is all lowercase, <code class="literal">__newindex</code> needs to set <code class="literal">Tbl.abc</code> to <code class="literal">1</code>. It can't do this with a regular indexing assignment (that would cause infinite recursion), so it uses the function <code class="literal">rawset</code>, which sets a table's key to a value but bypasses the table's <code class="literal">__newindex</code> metamethod (if present).</p><p>The metamethod for indexing (getting a key's value) is <code class="literal">__index</code>. When Lua sees <code class="literal">print(Tbl.ABC)</code>, it checks to see whether <code class="literal">Tbl</code> already has an <code class="literal">ABC</code> field. It doesn't, but it does have an <code class="literal">__index</code> metamethod, so instead of giving a result of <code class="literal">nil</code>, Lua calls <code class="literal">__index</code> with two arguments: <code class="literal">Tbl</code> and "<code class="literal">ABC"</code>. After lowercasing "<code class="literal">ABC", __index</code> gets the value of <code class="literal">Tbl.abc</code> (using <code class="literal">rawget</code> to avoid infinite recursion). This value is what is printed.</p><p>The <code class="literal">pairs</code> loop shows that even after setting the "<code class="literal">abc"</code>, "<code class="literal">Abc"</code>, and "<code class="literal">ABC"</code> keys there's only one key in the table:</p><pre class="programlisting">&gt; <strong class="userinput"><code>for K, V in pairs(Tbl) do print(K, V) end</code></strong>
abc     3</pre><p><code class="literal">pairs</code> and <code class="literal">ipairs</code> both bypass a table's <code class="literal">__index</code> metamethod. That's the desired behavior here, but if you want something different, you can write your own replacements for <code class="literal">pairs, next</code> (the iterator used by <code class="literal">pairs</code>), and <code class="literal">ipairs</code>. There's an example of this later in this chapter.</p></div><p>The <code class="literal">__newindex</code> and <code class="literal">__index</code> methods are only called when the given key isn't in the table. To demonstrate this, put the following debugging statements into them:</p><pre class="programlisting">local Meta = {
    __newindex = function(Tbl, Key, Val)
      print("__newindex:", Tbl, Key, Val)
      rawset(Tbl, Lower(Key), Val)
    end,
    __index = function(Tbl, Key)
      print("__index:", Tbl, Key)
      return rawget(Tbl, Lower(Key))
    end}</pre><p>Now you can see when the <code class="literal">__newindex</code> and <code class="literal">__index</code> methods are called:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl = MakeIgnoreCase()</code></strong>
&gt; <strong class="userinput"><code>Tbl.abc = 1 -- Calls __newindex because there's no Tbl.abc</code></strong>.
__newindex:        table: 0x4961e8 abc  1
&gt; <strong class="userinput"><code>Tbl.abc = 2 -- Doesn't call __newindex since Tbl.abc exists</code></strong>.
&gt; <strong class="userinput"><code>print(Tbl.ABC) -- Calls __index because there's no Tbl.ABC</code></strong>.
__index:           table: 0x4961e8 ABC
2
&gt; <strong class="userinput"><code>print(Tbl.abc) -- Doesn't call __index because Tbl.abc exists</code></strong>.
2</pre><p>This is fine for the case-insensitive table, but in other situations, you might want <code class="literal">__newindex</code> and <code class="literal">__index</code> to always be called. The way to do this is to give the metamethods to a <span class="emphasis"><em>proxy table</em></span>, which is a table that always stays empty. The next example uses this technique. It's a table that remembers the order in which things were put into it.<a id="IDX-CHP-8-0030" class="indexterm"></a><a id="IDX-CHP-8-0031" class="indexterm"></a><a id="IDX-CHP-8-0032" class="indexterm"></a></p><div class="sidebar"><a id="try_it_out_colon_employing_ordered_table"></a><div class="titlepage"><div><div><p class="title"><strong>Try It Out: Employing Ordered Tables</strong></p></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Save the following as <code class="literal">orderedtbl.lua</code>:</p><pre class="programlisting">-- "Ordered tables" -- they remember the order in which
 -- things are put into them.

 local RealTbls = {} -- Keys: proxy tables; values: the real
   -- tables.
 local NumToKeys = {} -- Keys: proxy tables; values: arrays
   -- of real tables' keys, in order.
 local KeyToNums = {} -- Keys: proxy tables; values: tables
   -- mapping real tables' keys to their (order) numbers.

 -- Does the bookkeeping necessary to add a key and its order
 -- to the real table (or update/delete a key):
 local function __newindex(Proxy, Key, Val)
   local RealTbl = RealTbls[Proxy]
   local NumToKey = NumToKeys[Proxy]
   local KeyToNum = KeyToNums[Proxy]
   if RealTbl[Key] == nil then
     -- This is a new key. Only add it if the value's
     -- non-nil:
     if Val ~= nil then
       -- Record the value:
       RealTbl[Key] = Val
       -- Record the order:
       NumToKey[#NumToKey + 1] = Key
       KeyToNum[Key] = #NumToKey
     end
   else
     -- This is an already existing key.
     if Val ~= nil then
       -- Record the new value:
       RealTbl[Key] = Val
     else
       -- Delete it:
       RealTbl[Key] = nil
       local Num = KeyToNum[Key]
       KeyToNum[Key] = nil
       -- table.remove will shift down anything in NumToKey
       -- that's higher than Num, but it needs to be done by
       -- hand for KeyToNum:
       if Num &lt; #NumToKey then
         for SomeKey, SomeNum in pairs(KeyToNum) do
           if SomeNum &gt; Num then
             KeyToNum[SomeKey] = SomeNum - 1
           end
         end
       end
       table.remove(NumToKey, Num)</pre><pre class="programlisting">end
   end
 end

 -- Returns Key's value in the real table:
 local function __index(Proxy, Key)
   return RealTbls[Proxy][Key]
 end

 -- An iterator that iterates through all the real table's
 -- key-value pairs in the correct order:
 local function __next(Proxy, PrevKey)
   assert(type(Proxy) == "table", "bad argument to 'next'")
   local RealTbl = RealTbls[Proxy]
   local NumToKey = NumToKeys[Proxy]
   local KeyToNum = KeyToNums[Proxy]
   -- This will be 0 only if PrevKey is the seed value nil:
   local PrevNum = KeyToNum[PrevKey] or 0
   local Key = NumToKey[PrevNum + 1]
   return Key, RealTbl[Key]
 end

 local RealIpairs = ipairs

 -- Returns an ipairs iterator for the real table:
 local function __ipairs(Proxy)
   return RealIpairs(RealTbls[Proxy])
 end

 -- The metatable:
 local OrderMeta = {__newindex = __newindex, __index = __index,
   __next = __next, __ipairs = __ipairs}

 local RealNext = next

 -- A metatable-aware replacement for next:
 function next(Tbl, Key)
   local Meta = getmetatable(Tbl)
   if Meta and Meta.__next then
     return Meta.__next(Tbl, Key)
   else
     return RealNext(Tbl, Key)
   end
 end

 -- A metatable-aware replacement for pairs:
 function pairs(Tbl)
   -- The real pairs only needs to be replaced because it
   -- returns its own copy of next unaffected by our
   -- replacement.
   assert(type(Tbl) == "table", "bad argument to 'pairs'")
   return next, Tbl, nil
 end

 -- A metatable-aware replacement for ipairs:</pre><pre class="programlisting">function ipairs(Tbl)
   local Meta = getmetatable(Tbl)
   if Meta and Meta.__ipairs then
     return Meta.__ipairs(Tbl)
   else
     return RealIpairs(Tbl)
   end
 end

 -- Returns a table that remembers the order in which keys
 -- are added to it:
 function MakeOrderedTbl()
   local RealTbl, Proxy = {}, {}
   RealTbls[Proxy] = RealTbl
   -- The following two tables are two complementary ways of
   -- recording the order that keys are added in:
   NumToKeys[Proxy] = {}
   KeyToNums[Proxy] = {}
   return setmetatable(Proxy, OrderMeta)
 end</pre></li><li class="listitem"><p>Require the file, make an ordered table, and give it some key-value pairs:</p><pre class="programlisting">&gt; <strong class="userinput"><code>require("orderedtbl")</code></strong>
&gt; <strong class="userinput"><code>Tbl = MakeOrderedTbl()</code></strong>
&gt; <strong class="userinput"><code>Tbl.John = "rhythm guitar"</code></strong>
&gt; <strong class="userinput"><code>Tbl.Paul = "bass guitar"</code></strong>
&gt; <strong class="userinput"><code>Tbl.George = "lead guitar"</code></strong>
&gt; <strong class="userinput"><code>Tbl.Ringo = "drumkit"</code></strong></pre></li><li class="listitem"><p>Verify that the pairs are looped through in the same order in which they were added:</p><pre class="programlisting">&gt; <strong class="userinput"><code>for Name, Instr in pairs(Tbl) do print(Name, Instr) end</code></strong>
 John   rhythm guitar
 Paul   bass guitar
 George lead guitar
 Ringo  drumkit</pre></li><li class="listitem"><p>Change one key's value and verify that the pairs are still in the same order:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl.George = "lead guitar, sitar"</code></strong>
&gt; <strong class="userinput"><code>for Name, Instr in pairs(Tbl) do print(Name, Instr) end</code></strong>
 John   rhythm guitar
 Paul   bass guitar
 George lead guitar, sitar
 Ringo  drumkit</pre></li><li class="listitem"><p>Remove one key and verify that the remaining pairs are still in the same order:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl.Paul = nil -- I buried Paul</code></strong>.
&gt; <strong class="userinput"><code>for Name, Instr in pairs(Tbl) do print(Name, Instr) end</code></strong>
 John   rhythm guitar
 George lead guitar, sitar
 Ringo  drumkit</pre></li></ol></div><p><span class="strong"><strong>How It Works</strong></span></p><p><code class="literal">pairs</code> iterates through the <code class="literal">Tbl</code> pairs in the same order as they were added. If you modify a key's value, the order is not changed, and you can delete a key by setting its value to <code class="literal">nil</code>. Most of the hard work is done by <code class="literal">__newindex</code>. Because the proxy table is always empty, every attempt to do indexing assignment on it is routed through <code class="literal">__newindex</code>, which keeps the following three tables for each proxy table:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">RealTbls[Proxy]</code>: The real table that corresponds to the proxy table—it contains all the key-value pairs, in the usual order.<a id="IDX-CHP-8-0033" class="indexterm"></a></p></li><li class="listitem"><p><code class="literal">NumToKeys[Proxy]</code>: An array of the <code class="literal">RealTbls[Proxy]</code> keys, in order of addition.<a id="IDX-CHP-8-0034" class="indexterm"></a></p></li><li class="listitem"><p><code class="literal">KeyToNums[Proxy]</code>: A mapping of all the keys to their positions in <code class="literal">NumToKeys[Proxy]</code>.<a id="IDX-CHP-8-0035" class="indexterm"></a></p></li></ul></div><p><code class="literal">RealTbls[Proxy]</code> is necessary for retrieving a value given its key, <code class="literal">NumToKeys[Proxy]</code> is necessary for looping through the keys in order, and <code class="literal">KeyToNums[Proxy]</code> is necessary for finding a given key's position in <code class="literal">NumToKeys[Proxy]</code> (for iteration, and also for modification or deletion of already existing pairs).</p><p>The <code class="literal">__next</code> metamethod is an iterator that uses these tables to iterate in the desired order. Lua itself knows nothing about a <code class="literal">__next</code> metamethod—the only thing that knows about it is <code class="literal">orderedtbl.lua</code>'s replacement for <code class="literal">next</code> (which, in turn, is what the <code class="literal">pairs</code> replacement returns). Similarly, Lua itself neither defines nor looks for an <code class="literal">__ipairs</code> metamethod—the only thing that knows about it is the <code class="literal">ipairs</code> replacement. (There's nothing that requires <code class="literal">__next</code> and <code class="literal">__ipairs</code> to start with two underscores, but it makes it easier to see that they're metamethods.) These <code class="literal">next</code> and <code class="literal">ipairs</code> replacements still work with regular tables. If they don't find the metamethods they look for, they use the real <code class="literal">next</code> and <code class="literal">ipairs</code> (stored as upvalues).</p><div class="blockquote"><blockquote class="blockquote"><p>There's a problem with <code class="literal">orderedtbl.lua</code>. The tables <code class="literal">RealTbls, NumToKeys</code>, and <code class="literal">KeyToNums</code> get bigger (consuming more memory) every time <code class="literal">MakeOrderedTbl</code> is called, but they never get smaller, even when the table returned by <code class="literal">MakeOrderedTbl</code> is no longer in use. This is called a memory leak, and a fix for it, using the <code class="literal">__mode</code> metamethod, is shown in <a class="link" href="ch10.html" title="Chapter 10. Looking Under the Hood">Chapter 10</a>.</p></blockquote></div></div><p>Both <code class="literal">__newindex</code> and <code class="literal">__index</code> can be tables. As such, you can use them instead of the table being indexed like this:</p><pre class="programlisting">&gt; <strong class="userinput"><code>TblA, TblB = {}, {}</code></strong>
&gt; <strong class="userinput"><code>setmetatable(TblB, {__newindex = TblA, __index = TblA})</code></strong>
&gt; <strong class="userinput"><code>TblB[1] = "one"</code></strong>
&gt; <strong class="userinput"><code>print(TblB[1])</code></strong>
one
&gt; <strong class="userinput"><code>-- It's not really in TblB:</code></strong>
&gt; <strong class="userinput"><code>print(rawget(TblB, 1))</code></strong>
nil
&gt; <strong class="userinput"><code>-- It's really in TblA:</code></strong>
&gt; <strong class="userinput"><code>print(TblA[1])</code></strong>
one</pre><p>If <code class="literal">__newindex</code> and/or <code class="literal">__index</code> are tables that themselves have indexing metamethods, these are used. That means that one table can get some of its values from another table, which gets some of its values from another, and so on. This is called <span class="emphasis"><em>inheritance</em></span> and is illustrated in the following example:<a id="IDX-CHP-8-0036" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>TblA = {"one", "two", "three", "four", "five", "six"}</code></strong>
&gt; <strong class="userinput"><code>TblB = {[3] = "III", [4] = "IV", [5] = "V", [6] = "VI"}</code></strong>
&gt; <strong class="userinput"><code>-- Make TblB inherit from TblA:</code></strong></pre><pre class="programlisting">&gt; <strong class="userinput"><code>setmetatable(TblB, {__index = TblA})</code></strong>
&gt; <strong class="userinput"><code>TblC = {[5] = "*****", [6] = "******"}</code></strong>
&gt; <strong class="userinput"><code>-- Make TblC inherit from TblB:</code></strong>
&gt; <strong class="userinput"><code>setmetatable(TblC, {__index = TblB})</code></strong>
&gt; <strong class="userinput"><code>-- TblC thus indirectly inherits from TblA:</code></strong>
&gt; <strong class="userinput"><code>for I = 1, 6 do print(I, TblC[I]) end</code></strong>
1         one
2         two
3         III
4         IV
5         *****
6         ******</pre><p>This can twist and turn through up to 100 tables (or more if you recompile Lua with a higher value for <code class="literal">MAXTAGLOOP</code>).<a id="IDX-CHP-8-0037" class="indexterm"></a><a id="IDX-CHP-8-0038" class="indexterm"></a><a id="IDX-CHP-8-0039" class="indexterm"></a></p><p>Other than <code class="literal">__tostring</code> (and the <code class="literal">__next</code> and <code class="literal">__ipairs</code> metamethods defined in <code class="literal">orderedtbl.lua</code>), all of the metamethods you've seen so far are <span class="emphasis"><em>syntactical metamethods</em></span>, which means they correspond to syntactical constructs (all of the operators, plus indexing and indexing assignment). Another syntactical metamethod yet to be covered is <code class="literal">__call</code>. This metamethod controls what happens when something other than a function is called. For instance, if a table has the <code class="literal">__call</code> method given in the following example, then calling it (as though it were a function) returns <code class="literal">true</code> if all the arguments are keys in it with true values, and <code class="literal">false</code> otherwise:<a id="IDX-CHP-8-0040" class="indexterm"></a><a id="IDX-CHP-8-0041" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>CallMeta = {</code></strong>
&gt;&gt;   <strong class="userinput"><code>-- Are all of the arguments true-valued keys in Tbl?</code></strong>
&gt;&gt;   <strong class="userinput"><code>__call = function(Tbl, ...)</code></strong>
&gt;&gt;      <strong class="userinput"><code>for I = 1, select("#", ...) do</code></strong>
&gt;&gt;        <strong class="userinput"><code>if not Tbl[select(I, ...)] then</code></strong>
&gt;&gt;           <strong class="userinput"><code>return false -- NON-STRUCTURED EXIT: FOUND A KEY</code></strong>
&gt;&gt;        <strong class="userinput"><code>-- WITH A NON-TRUE VALUE</code></strong>.
&gt;&gt;      <strong class="userinput"><code>end</code></strong>
&gt;&gt;    <strong class="userinput"><code>end</code></strong>
&gt;&gt;    <strong class="userinput"><code>return true</code></strong>
&gt;&gt; <strong class="userinput"><code>end}</code></strong>
&gt; <strong class="userinput"><code>Tbl = {John = "rhythm guitar", Paul = "bass guitar",</code></strong>
&gt;&gt; <strong class="userinput"><code>George = "lead guitar", Ringo = "drumkit"}</code></strong>
&gt; <strong class="userinput"><code>setmetatable(Tbl, CallMeta)</code></strong>
&gt; <strong class="userinput"><code>-- Same truth-value as (Tbl.Paul and Tbl.John):</code></strong>
&gt; <strong class="userinput"><code>print(Tbl("Paul", "John"))</code></strong>
true
&gt; <strong class="userinput"><code>-- Same truth-value as (Tbl.Ringo and Tbl.Mick and Tbl.Keith):</code></strong>
&gt; <strong class="userinput"><code>print(Tbl("Ringo", "Mick", "Keith"))</code></strong>
false</pre></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="non-tables_with_metamethods"></a>Non-Tables with Metamethods</h1></div></div></div><p>As mentioned earlier, all datatypes (not just tables) can have metatables. The <code class="literal">setmetatable</code> function only works with tables. The metatables of other types must be set either from C or with the function <code class="literal">debug.setmetatable</code>. Unlike tables, most other types have per-type metatables. This means that giving a metatable to a number gives it to all numbers. In the following example, a <code class="literal">__len</code> metamethod is given to numbers (where making the <code class="literal">math.abs</code> argument positive if it's negative is called getting the argument's <span class="emphasis"><em>absolute value</em></span>):<a id="IDX-CHP-8-0042" class="indexterm"></a><a id="IDX-CHP-8-0043" class="indexterm"></a><a id="IDX-CHP-8-0044" class="indexterm"></a><a id="IDX-CHP-8-0045" class="indexterm"></a></p><pre class="programlisting">&gt; <strong class="userinput"><code>print(#99)</code></strong>
stdin:1: attempt to get length of a number value
stack traceback:
        stdin:1: in main chunk
        [C]: ?
&gt; <strong class="userinput"><code>debug.setmetatable(1, {__len = math.abs})</code></strong>
&gt; <strong class="userinput"><code>print(#99)</code></strong>
99
&gt; <strong class="userinput"><code>print(#-99)</code></strong>
99</pre><div class="blockquote"><blockquote class="blockquote"><p>Unlike <code class="literal">setmetatable, debug.setmetatable</code> returns a Boolean: <code class="literal">true</code> if it succeeded, <code class="literal">false</code> otherwise.<a id="IDX-CHP-8-0046" class="indexterm"></a></p></blockquote></div><p>By default, types have no metatable, except for strings, whose <code class="literal">__index</code> metamethod is the <code class="literal">string</code> table, as shown here:</p><pre class="programlisting">&gt; <strong class="userinput"><code>StringMeta = getmetatable("")</code></strong>
&gt; <strong class="userinput"><code>for Name, Meth in pairs(StringMeta) do print(Name, Meth)</code></strong>
&gt; <strong class="userinput"><code>end</code></strong>
 __index table: 0x8066f30
&gt; <strong class="userinput"><code>print(StringMeta.__index == string)</code></strong>
true</pre><p>This means that all the functions of the string library are available from any string. For example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>SomeString = "some string"</code></strong>
&gt; <strong class="userinput"><code>print(SomeString.char(65, 66, 67))</code></strong>
ABC</pre><p>More usefully, it means that any string function that takes a string as its first argument (that's almost all of them) can be used in object-oriented style, with the string as the object and the function as its method. For example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Greet = "Hello"</code></strong>
&gt; <strong class="userinput"><code>print(Greet:upper())</code></strong>
HELLO
&gt; <strong class="userinput"><code>FrmtStr = '&lt;a href="%s"&gt;%s&lt;/a&gt;'</code></strong>
&gt; <strong class="userinput"><code>print(FrmtStr:format("http://luaforge.net", "LuaForge"))</code></strong>
&lt;a href="http://luaforge.net"&gt;LuaForge&lt;/a&gt;</pre><p>A literal string can be used in this way, but only if it's surrounded in parentheses like this:</p><pre class="programlisting">&gt; <strong class="userinput"><code>print(("a"):rep(5))</code></strong>
aaaaa</pre><p>There's one more type whose behavior with metatables needs special clarification. The <span class="emphasis"><em>userdata</em></span> type will be covered in <a class="link" href="ch13.html" title="Chapter 13. Interfacing Lua with Other Languages">Chapter 13</a>, but it's basically a way of exposing a C datatype (or a datatype of some other language) to Lua. It comes in two varieties: full userdatas and light userdatas. Both varieties are identified by the <code class="literal">type</code> function as "<code class="literal">userdata"</code>, but their behavior with metatables is different. Metatable-wise, full userdatas are similar to tables, and light userdatas are similar to nontables:<a id="IDX-CHP-8-0047" class="indexterm"></a><a id="IDX-CHP-8-0048" class="indexterm"></a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Each full userdata can have its own metatable.</p></li><li class="listitem"><p>Giving a metatable to a light userdata gives it to all light userdatas.</p></li></ul></div><div class="blockquote"><blockquote class="blockquote"><p>In Lua 5.0, only tables and full userdatas could have metatables.</p></blockquote></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="non-syntactical_metamethods"></a>Non-Syntactical Metamethods</h1></div></div></div><p>As mentioned previously, <code class="literal">__tostring</code> is a non-syntactical metamethod, which means that it doesn't control the behavior of an operator or other syntactical construct. Instead, it controls the behavior of the function <code class="literal">tostring</code>, which will always use a value's <code class="literal">__tostring</code> metamethod, if present, to convert that value to a string. In this way, <code class="literal">__tostring</code> is no different from <code class="literal">__next</code> and <code class="literal">__ipairs</code>, except that it is consulted by a built-in Lua function and they are not.<a id="IDX-CHP-8-0049" class="indexterm"></a><a id="IDX-CHP-8-0050" class="indexterm"></a></p><p>One other metamethod consulted by a built-in function (or two functions, in this case) is <code class="literal">__metatable</code>. If <code class="literal">getmetatable</code> sees that a value has a <code class="literal">__metatable</code> metamethod, it returns that metamethod instead of the metatable itself. If <code class="literal">setmetatable</code> sees that a value has a <code class="literal">__metatable</code> metamethod, it triggers an error rather than setting the metatable. A <code class="literal">__metatable</code> metamethod can be any type (except <code class="literal">nil</code>, of course).</p><p>This is most commonly used to protect metatables from tampering. Here's an example:</p><pre class="programlisting">&gt; <strong class="userinput"><code>T = setmetatable({}, {__metatable = false})</code></strong>
&gt; <strong class="userinput"><code>print(getmetatable(T))</code></strong>
false
&gt; <strong class="userinput"><code>T = setmetatable(T, nil)</code></strong>
stdin:1: cannot change a protected metatable
stack traceback:
         [C]: in function 'setmetatable'
         stdin:1: in main chunk
         [C]: ?</pre><p><code class="literal">debug.setmetatable</code> and <code class="literal">debug.getmetatable</code> both ignore <code class="literal">__metatable</code>.</p><p>The two remaining nonsyntactical metamethods defined by Lua both control <span class="emphasis"><em>garbage-collection</em></span>, which is the automatic process of reclaiming no-longer-used memory for reuse.</p><p>The <code class="literal">__mode</code> metamethod is for tables. It is explained in <a class="link" href="ch10.html" title="Chapter 10. Looking Under the Hood">Chapter 10</a> (which contains a fix for the problem with <code class="literal">orderedtbl.lua</code> mentioned earlier).</p><p>The <code class="literal">__gc</code> metamethod is for full userdatas. It is explained in <a class="link" href="ch13.html" title="Chapter 13. Interfacing Lua with Other Languages">Chapter 13</a>.</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="metamethod_applicability"></a>Metamethod Applicability</h1></div></div></div><p>You have seen a number of cases where metamethods are ignored. The following chart lists all the metamethods defined by Lua's core and its built-in libraries and shows which situations they are applicable in.<a id="IDX-CHP-8-0051" class="indexterm"></a><a id="IDX-CHP-8-0052" class="indexterm"></a></p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"><col class="col2"></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Metamethod</p></th><th style="text-align: left" valign="bottom"><p>Applicability</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">__add __mod</code></p>
<p><code class="literal">__call __mul</code></p>
<p><code class="literal">__concat __pow</code></p>
<p><code class="literal">__div __sub</code></p>
<p><code class="literal">__len __unm</code></p></td><td style="text-align: left" valign="top"><p>Only consulted if the syntactical construct they are for doesn't already have a meaning for the given types.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">__eq</code></p>
<p><code class="literal">__lt</code></p>
<p><code class="literal">__le</code></p></td><td style="text-align: left" valign="top"><p>Only consulted if both operands are the same type and have the same metamethod. Additionally, <code class="literal">__eq</code> is only consulted if the operands are unequal tables or full userdatas; <code class="literal">__lt</code> and <code class="literal">__le</code> are only consulted if the operands are not numbers or strings.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">__index</code></p>
<p><code class="literal">__newindex</code></p></td><td style="text-align: left" valign="top"><p>Not consulted if the given key exists.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">__tostring</code></p>
<p><code class="literal">__metatable</code></p></td><td style="text-align: left" valign="top"><p>Consulted by <code class="literal">tostring</code> and <code class="literal">getmetatable</code>/<code class="literal">setmetatable</code>, respectively.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">__mode</code></p></td><td style="text-align: left" valign="top"><p>For tables only (<code class="literal">"k"</code>, "<code class="literal">v"</code>, or "<code class="literal">kv")</code>.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">__gc</code></p></td><td style="text-align: left" valign="top"><p>For full userdatas only.</p></td></tr></tbody></table></div></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="summary-021"></a>Summary</h1></div></div></div><p>In this chapter, you were introduced to the concept of metamethods and to all the metamethods defined by Lua's core and its built-in libraries. Here are some highlights of what you've learned:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You can use metamethods to give new behavior to all of the operators except for the Boolean ones, and to table indexing, indexing assignment, and calls.</p></li><li class="listitem"><p>Nonrelational binary metamethods are retrieved from the left operand or from the right operand if the left one doesn't have the appropriate metamethod.</p></li><li class="listitem"><p>You can use proxy tables to increase the power of <code class="literal">__newindex</code> and <code class="literal">__index</code>.</p></li><li class="listitem"><p><code class="literal">__newindex</code> and <code class="literal">__index</code> can themselves be tables, and they can use their own indexing metamethods (if they exist) to implement inheritance.</p></li><li class="listitem"><p>You can also use metamethods to control how values are converted to strings and how they are garbage-collected.</p></li><li class="listitem"><p>Metamethods serve mainly to define new behavior, not to redefine existing behavior. Even the exceptions to that rule are limited, which is why <code class="literal">__eq</code> only works with tables or full userdatas, and why <code class="literal">__newindex</code> and <code class="literal">__index</code> only work with nonexistent keys.</p></li></ul></div><p>The next chapter explains something new to add to your arsenal of control flow tools (alongside control structures and functions). But before moving on, this chapter concludes with a couple of exercises (answers are in the appendix).</p></div><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-022"></a>Exercises</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Write a metamethod that makes the unary minus operator give a reversed copy of an array:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Arr = setmetatable({"one", "two", "three"}, Meta)</code></strong>
&gt; <strong class="userinput"><code>for I, Val in ipairs(-Arr) do print(I, Val) end</code></strong>
1      three
2      two
3      one</pre></li><li class="listitem"><p>Write a function that makes the table given to it read-only:</p><pre class="programlisting">&gt; <strong class="userinput"><code>Tbl = {"Hello"}</code></strong>
&gt; <strong class="userinput"><code>Protect(Tbl)</code></strong>
&gt; <strong class="userinput"><code>print(Tbl[1])</code></strong>
Hello
&gt; <strong class="userinput"><code>Tbl[2] = "Goodbye"</code></strong>
stdin:14: attempt to assign to a protected table
stack traceback:
        [C]: in function 'error'
        stdin:14: in function &lt;stdin:13&gt;
        stdin:1: in main chunk
        [C]: ?
&gt; <strong class="userinput"><code>Tbl[1] = "Goodbye"</code></strong>
stdin:14: attempt to assign to a protected table
stack traceback:
        [C]: in function 'error'
        stdin:14: in function &lt;stdin:13&gt;
        stdin:1: in main chunk
        [C]: ?
&gt; <strong class="userinput"><code>setmetatable(Tbl, nil)</code></strong>
stdin:1: cannot change a protected metatable
stack traceback:
        [C]: in function 'setmetatable'
        stdin:1: in main chunk
        [C]: ?</pre></li></ol></div></div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Using Modules</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. Handling Events Naturally with Coroutines</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag">
        
        

        
          <p>You have 6 days left in your trial, Michaelschiner. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="ch08.html#" class="icon-up" onclick="window.Appcues.track('JumpTop_HeronBook')"><div class="visuallyhidden">Back to top</div></a>
  <ul class='js-footer-nav'>
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">&#169; 2021 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="https://learning.oreilly.com/jsi18n/web/" charset="utf-8"></script>
    <script src="https://learning.oreilly.com/library/jsi18n/appcache/" charset="utf-8"></script>
  </body>
</html>
